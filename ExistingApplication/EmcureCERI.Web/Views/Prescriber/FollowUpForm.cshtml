@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> SharedLocalizer
@{
    ViewData["Title"] = @SharedLocalizer["Follow Up Form"].Value;
}
<section class="section">
    <div class="container-fluid">
        <h4>@ViewBag.Name</h4>
        <div class="tabsContainer tblContainer">
            <ul class="nav nav-pills toptabs">
                <li><a asp-area="" asp-controller="Prescriber" asp-action="InformedConsentForm" asp-route-id="@ViewBag.patientid">@SharedLocalizer["Informed Consent Form"].Value</a></li>
                <li><a asp-area="" asp-controller="Prescriber" asp-action="BaselineDataForm" asp-route-id="@ViewBag.patientid">@SharedLocalizer["Baseline Data Form"].Value</a></li>
                <li class="active"><a asp-area="" asp-controller="Prescriber" asp-action="FollowUpForm" asp-route-id="@ViewBag.patientid">@SharedLocalizer["Follow Up Form"].Value</a></li>
            </ul>
            <div class="tab-content tab-content">
                <div class="table-responsive">
                    <table id="addFollwUpFormTableId" class="stripe row-border order-column" style="width:100%">
                        <thead>
                            <tr>
                                <th style="max-width:55px">@SharedLocalizer["Sr. No."].Value</th>
                                <th class="text-left">@SharedLocalizer["Follow Up Form"].Value</th>
                                <th>@SharedLocalizer["Date"].Value</th>
                                <th style="width:85px;">@SharedLocalizer["Action"].Value</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            @if (User.IsInRole("Prescriber"))
            {
                <div class="row">
                    <div class="text-right clearfix col-sm-12">
                        <br />
                        <a class="btn btn-default btn-sm" onclick=AddFollowUpForm(@ViewBag.patientid);><i class="fa fa-plus"></i> @SharedLocalizer["Add Follow Up Form"].Value</a>
                    </div>
                </div>
            }
        </div>
    </div>

    <div id="followViewModal" class="modal themeModal " role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
            </div>
        </div>
    </div>

</section>
@section Scripts {
    <script>
        var Popup, dataTable, getFollowUpForm;
        $(document).ready(function () {
            var dataTable = $('#addFollwUpFormTableId').DataTable({
                responsive: true,
                language: {
                    "emptyTable": "@SharedLocalizer["No data available in table"].Value",
                    "info": "@SharedLocalizer["Showing _START_ to _END_ of _TOTAL_ entries"].Value",
                    "infoEmpty":"@SharedLocalizer["Showing 0 to 0 of 0 entries"].Value",
                    "infoFiltered":"@SharedLocalizer["(filtered from _MAX_ total entries)"].Value",
                    "lengthMenu":"@SharedLocalizer["Show _MENU_ entries"].Value",
                    "loadingRecords": "@SharedLocalizer["Loading..."].Value",
                    "processing": "@SharedLocalizer["Processing..."].Value",
                    "search": "@SharedLocalizer["Search"].Value",
                    "zeroRecords":"@SharedLocalizer["No matching records found"].Value",
                    "paginate": {
                        "first":"@SharedLocalizer["First"].Value",
                        "last":"@SharedLocalizer["Last"].Value",
                        "next": "@SharedLocalizer["Next"].Value",
                        "previous":"@SharedLocalizer["Previous"].Value"
                    },
                }
            });
            getFollowUpForm = function () {
                $('#loaderContainer').show();
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetFollowUpForm", "Prescriber")/' +@ViewBag.patientid,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        $('#loaderContainer').hide();
                        var jsonObject = response.data;
                        var result = jsonObject.map(function (item) {
                            var result = [];
                            result.push(item.SrNo);
                            result.push(item.FollowUpFormName);
                            result.push(item.Date);
                            if (response.result) {
                                result.push("<a title='@SharedLocalizer["Edit"].Value' class='btn btn-info btn-sm custTblBtn' href='@Url.Action("FollowDetails","Prescriber")?PatientID=" + @ViewBag.patientid + "&FollowUpFormID=" + item.Id + "'> <span class='glyphicon glyphicon-pencil' aria-hidden='true'> </span> </a>");
                            } else {
                                result.push("<a title='@SharedLocalizer["Edit"].Value' class='btn btn-info btn-sm custTblBtn' href='@Url.Action("FollowDetails","Prescriber")?PatientID=" + @ViewBag.patientid + "&FollowUpFormID=" + item.Id + "'> <span class='glyphicon glyphicon-pencil' aria-hidden='true'> </span> </a>  <a title='@SharedLocalizer["Delete"].Value' class='btn btn-danger btn-sm' onclick=DeleteFollowUpForm("+item.Id+"); > <span class='glyphicon glyphicon-remove' aria-hidden='true'></span></a >");
                            }
                            return result;
                        });
                        dataTable.clear();
                        dataTable.rows.add(result); // add to DataTable instance
                        dataTable.draw(); // always redraw
                    },
                    failure: function () {
                        $("#addFollwUpFormTableId").append('@SharedLocalizer["Error when fetching data please contact administrator"].Value');
                    }
                });
            }
            getFollowUpForm();
        });

    function AddFollowUpForm(Id) {
            var url = "/Prescriber/AddFollowUpForm/" +Id;
            $.get(url)
                .done(function (response) {
                    $('#followViewModal .modal-title').html('@SharedLocalizer["Add Follow Up Form"].Value');
                    $('#followViewModal .modal-body').html(response);
                    $('#followViewModal').modal('show');
                });
    }


    function DeleteFollowUpForm(followUpFormId) {
        var model = { PatientID: @ViewBag.patientid, FollowUpFormID: followUpFormId };
            $.ajax({
                type: "GET",
                url: "/Prescriber/DeleteFollowDetails",
                data: model,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        openCommonModal("successModal modal-sm", '@Html.Raw(SharedLocalizer["Success"].Value)', data.message, false);
                        location.reload();
                    }
                },
                error: function (err) {
                    openCommonModal('alertModal modal-sm', '@SharedLocalizer["Error"].Value', err.statusText, false);
                }
            });
    }

    function SubmitFormFollowUpForm(form) {
        $.validator.unobtrusive.parse(form);
        if ($(form).valid()) {
            $.ajax({
                type: "POST",
                url: form.action,
                data: $(form).serialize(),
                success: function (data) {
                    $('#followViewModal').modal('hide');
                    if (data.result === "success") {
                        openCommonModal('successModal modal-sm', '@Html.Raw(SharedLocalizer["Success"].Value)', '@Html.Raw(SharedLocalizer["Record has been added successfully."].Value)', false);
                    } else {
                        if (data.result === "error") {
                            openCommonModal('alertModal modal-sm', '@SharedLocalizer["Error"].Value', data.message, false);
                        }
                    }
                    getFollowUpForm();
                }
            });
        }
        return false;
    }
    </script>
}

