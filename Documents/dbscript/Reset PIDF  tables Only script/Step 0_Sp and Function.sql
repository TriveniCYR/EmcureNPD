
GO
/****** Object:  StoredProcedure [dbo].[usp_PIDF_CSV]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[usp_PIDF_CSV]
GO
/****** Object:  StoredProcedure [dbo].[stp_PBF_PhasewiseBudgetData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_PBF_PhasewiseBudgetData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_VerifyUserLogin]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_VerifyUserLogin]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_RemoveChildDataAPICharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_RemoveChildDataAPICharter]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_RemoveAllMultipleMappingofMasterUser]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_RemoveAllMultipleMappingofMasterUser]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_InsertException]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_InsertException]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetUserList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetUserList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetUserDropdown]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetUserDropdown]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetRegionByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetRegionByBusinessUnit]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetRealTimeNotificationForUser]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetRealTimeNotificationForUser]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFManagementPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPIDFManagementPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFAPICharterSummaryData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPIDFAPICharterSummaryData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFAPICharterData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPIDFAPICharterData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFRADates]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPBFRADates]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFOutsourceWorkflowTask]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPBFOutsourceWorkflowTask]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFOutsourceData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPBFOutsourceData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPbfData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPbfData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFAPIPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPBFAPIPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPbfAllTabData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPbfAllTabData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPatentDetailsById]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPatentDetailsById]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPatentDetails]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetPatentDetails]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetNotificationList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetNotificationList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetModulePermissionRefByRoleId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetModulePermissionRefByRoleId]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetManagementPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetManagementPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIpdPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetIpdPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDPatentDetailsCountryList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetIPDPatentDetailsCountryList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIpdPatentDetailsBUssinessUnitWiseCountryList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetIpdPatentDetailsBUssinessUnitWiseCountryList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDManagementPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetIPDManagementPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDDetailByPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetIPDDetailByPIDF]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetFinancePIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetFinancePIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetDepartmentCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetDepartmentCountryByBusinessUnit]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryListByIsInterested]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCountryListByIsInterested]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryByUserId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCountryByUserId]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryByRegion]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCountryByRegion]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCommercialPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCommercialPIDFList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCommercialFormData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCommercialFormData]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCanBeApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetCanBeApprove]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetBusinessUnitByUserId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetBusinessUnitByUserId]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetAuditLogList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetAuditLogList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetAPIList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_GetAPIList]
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_AfterApproveRejectActions]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[stp_npd_AfterApproveRejectActions]
GO
/****** Object:  StoredProcedure [dbo].[std_npd_GetIsInterestedByPIDFandBU]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[std_npd_GetIsInterestedByPIDFandBU]
GO
/****** Object:  StoredProcedure [dbo].[std_npd_GetIsAlloeToApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[std_npd_GetIsAlloeToApprove]
GO
/****** Object:  StoredProcedure [dbo].[SpGetPIDF_PBF_General_RND]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SpGetPIDF_PBF_General_RND]
GO
/****** Object:  StoredProcedure [dbo].[SP_PIDF_UPDATE_CSV]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_PIDF_UPDATE_CSV]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetCurrencyByUser]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_GetCurrencyByUser]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_GetCountryByBusinessUnit]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetActiveBusinessUnitByUserid]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_GetActiveBusinessUnitByUserid]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetActiveBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_GetActiveBusinessUnit]
GO
/****** Object:  StoredProcedure [dbo].[SP_Fill_ddl_PIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_Fill_ddl_PIDF]
GO
/****** Object:  StoredProcedure [dbo].[SP_Fill_ddl_PBF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SP_Fill_ddl_PBF]
GO
/****** Object:  StoredProcedure [dbo].[SaveUpdateEmailLogs]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[SaveUpdateEmailLogs]
GO
/****** Object:  StoredProcedure [dbo].[RemovePIDF_Finance_BatchSizeCoatingById]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[RemovePIDF_Finance_BatchSizeCoatingById]
GO
/****** Object:  StoredProcedure [dbo].[ProcUpdateParentTaskProgressByParentId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcUpdateParentTaskProgressByParentId]
GO
/****** Object:  StoredProcedure [dbo].[ProcUpdateEmailNotificationMaster]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcUpdateEmailNotificationMaster]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetSUIMSVolumeYearWiseByPackSize]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetSUIMSVolumeYearWiseByPackSize]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetStrengthByPIDFAnddBuId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetStrengthByPIDFAnddBuId]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetProjectNameAndStrength]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetProjectNameAndStrength]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetPidfFinance]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetPidfFinance]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetPackSizeByStrengthId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetPackSizeByStrengthId]
GO
/****** Object:  StoredProcedure [dbo].[PRocGetFinanceBatchSizeCoating]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[PRocGetFinanceBatchSizeCoating]
GO
/****** Object:  StoredProcedure [dbo].[ProcGetCommercialPackSizeForManagmentApproval]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcGetCommercialPackSizeForManagmentApproval]
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasksSwapp]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcAddWorkflowTasksSwapp]
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasks-_Old]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcAddWorkflowTasks-_Old]
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasks]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcAddWorkflowTasks]
GO
/****** Object:  StoredProcedure [dbo].[ProcAddUpdatePidfFinance]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[ProcAddUpdatePidfFinance]
GO
/****** Object:  StoredProcedure [dbo].[Proc_GetCountyForBussinessUnitAndPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[Proc_GetCountyForBussinessUnitAndPIDF]
GO
/****** Object:  StoredProcedure [dbo].[GetWishListByTypeId]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetWishListByTypeId]
GO
/****** Object:  StoredProcedure [dbo].[GetWishList]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetWishList]
GO
/****** Object:  StoredProcedure [dbo].[GetUserForReminder]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetUserForReminder]
GO
/****** Object:  StoredProcedure [dbo].[GetTaskSubTaskFileProject-SwapBackup]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetTaskSubTaskFileProject-SwapBackup]
GO
/****** Object:  StoredProcedure [dbo].[GetTaskSubTaskFileProject]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetTaskSubTaskFileProject]
GO
/****** Object:  StoredProcedure [dbo].[GetStrengthForPBF_TDP]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetStrengthForPBF_TDP]
GO
/****** Object:  StoredProcedure [dbo].[GetPIDFByYearAndBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetPIDFByYearAndBusinessUnit]
GO
/****** Object:  StoredProcedure [dbo].[GetPackSizeStabilityData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetPackSizeStabilityData]
GO
/****** Object:  StoredProcedure [dbo].[GetFinaceProjectionYear]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetFinaceProjectionYear]
GO
/****** Object:  StoredProcedure [dbo].[GetEmailNotification]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetEmailNotification]
GO
/****** Object:  StoredProcedure [dbo].[GetCountryWisePackSizeStabilityData]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetCountryWisePackSizeStabilityData]
GO
/****** Object:  StoredProcedure [dbo].[GetBusinessUnitDetails]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[GetBusinessUnitDetails]
GO
/****** Object:  StoredProcedure [dbo].[AutoUpdatePIDFStatus]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[AutoUpdatePIDFStatus]
GO
/****** Object:  StoredProcedure [dbo].[AddUpdatePIDF_Pbf_ra]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[AddUpdatePIDF_Pbf_ra]
GO
/****** Object:  StoredProcedure [dbo].[AddUpdatePIDF_Finance_BatchSizeCoating]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP PROCEDURE IF EXISTS [dbo].[AddUpdatePIDF_Finance_BatchSizeCoating]
GO
/****** Object:  UserDefinedFunction [dbo].[GetPIDFHistoryStatusByPIDFID]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetPIDFHistoryStatusByPIDFID]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCountryForBusinessUnitAndPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCountryForBusinessUnitAndPIDF]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCountryByBusinessUnit]
GO
/****** Object:  UserDefinedFunction [dbo].[GetBusinessUnitInterestedInPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetBusinessUnitInterestedInPIDF]
GO
/****** Object:  UserDefinedFunction [dbo].[ufn_Split]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[ufn_Split]
GO
/****** Object:  UserDefinedFunction [dbo].[GetScaleUpPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetScaleUpPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetReferenceProductCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetReferenceProductCostPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetPrototypePBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetPrototypePBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetProjectEndDate]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetProjectEndDate]
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleDepartment]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetMultipleDepartment]
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleBusinessUnitIds]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetMultipleBusinessUnitIds]
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetMultipleBusinessUnit]
GO
/****** Object:  UserDefinedFunction [dbo].[GetFillingCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetFillingCostPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetExhibitPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetExhibitPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCurrencySymbol]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCurrencySymbol]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCurrencyCode]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCurrencyCode]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCapexCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCapexCostPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[GetCanBeApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetCanBeApprove]
GO
/****** Object:  UserDefinedFunction [dbo].[GetBioStudyCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[GetBioStudyCostPBFCharter]
GO
/****** Object:  UserDefinedFunction [dbo].[Get_PIDF_Details]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[Get_PIDF_Details]
GO
/****** Object:  UserDefinedFunction [dbo].[Get_PBF_Details]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[Get_PBF_Details]
GO
/****** Object:  UserDefinedFunction [dbo].[BusinessUnitInterestedInPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP FUNCTION IF EXISTS [dbo].[BusinessUnitInterestedInPIDF]
GO
/****** Object:  UserDefinedTableType [dbo].[Type_PIDF_PBF_RA]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP TYPE IF EXISTS [dbo].[Type_PIDF_PBF_RA]
GO
/****** Object:  UserDefinedTableType [dbo].[PIDF_Finance_BatchSizeCoatingTable_Type]    Script Date: 11/16/2023 4:01:50 AM ******/
DROP TYPE IF EXISTS [dbo].[PIDF_Finance_BatchSizeCoatingTable_Type]
GO
/****** Object:  UserDefinedTableType [dbo].[PIDF_Finance_BatchSizeCoatingTable_Type]    Script Date: 11/16/2023 4:01:50 AM ******/
CREATE TYPE [dbo].[PIDF_Finance_BatchSizeCoatingTable_Type] AS TABLE(
	[PIDFFinaceBatchSizeCoatingId] [int] NULL,
	[PIDFFinaceId] [int] NULL,
	[BusinessUnitId] [int] NULL,
	[Batchsize] [numeric](18, 2) NULL,
	[Yield] [numeric](18, 2) NULL,
	[Batchoutput] [numeric](18, 2) NULL,
	[API_CAD] [numeric](18, 2) NULL,
	[Excipients_CAD] [numeric](18, 2) NULL,
	[PM_CAD] [numeric](18, 2) NULL,
	[CCPC_CAD] [numeric](18, 2) NULL,
	[Freight_CAD] [numeric](18, 2) NULL,
	[EmcureCOGs_pack] [numeric](18, 2) NULL,
	[CreatedDate] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[Skus] [int] NULL,
	[PakeSize] [int] NULL,
	[BrandPrice] [float] NULL,
	[NetRealisation] [float] NULL,
	[GenericListprice] [float] NULL,
	[EstMAT2016_BY_12Units] [float] NULL,
	[EstMAT2020_BY_12Units] [float] NULL,
	[CAGRover2016_By_12EstMATunits] [float] NULL,
	[Marketinpacks] [float] NULL,
	[Batchsizein_ltr_tabs] [float] NULL
)
GO
/****** Object:  UserDefinedTableType [dbo].[Type_PIDF_PBF_RA]    Script Date: 11/16/2023 4:01:50 AM ******/
CREATE TYPE [dbo].[Type_PIDF_PBF_RA] AS TABLE(
	[PIDFPBFRAId] [bigint] NULL,
	[PIDFId] [bigint] NULL,
	[PBFId] [bigint] NULL,
	[CountryIdBuId] [int] NULL,
	[PivotalBatchManufactured] [datetime] NULL,
	[LastDataFromRnD] [datetime] NULL,
	[BEFinalReport] [datetime] NULL,
	[BuId] [int] NULL,
	[TypeOfSubmissionId] [int] NULL,
	[DossierReadyDate] [datetime] NULL,
	[EarliestSubmissionDExcl] [datetime] NULL,
	[EarliestLaunchDExcl] [datetime] NULL,
	[LasDateToRegulatory] [datetime] NULL,
	[CreatedOn] [datetime] NULL,
	[UpdatedOn] [datetime] NULL,
	[DeletedOn] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[EndOfProcedureDate] [datetime] NULL,
	[CountryApprovalDate] [datetime] NULL
)
GO
/****** Object:  UserDefinedFunction [dbo].[BusinessUnitInterestedInPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select [dbo].[Get_PIDF_Details_By_PIDF_Id](16,'MoleculeName')
CREATE FUNCTION [dbo].[BusinessUnitInterestedInPIDF] (@PIDFId int,@BUId int)
RETURNS bit as 
BEGIN

declare @response bit;

If Exists(Select PIDFID from PIDF Where PIDFID = @PIDFId And BusinessUnitId = @BUId)
Begin
	Return 1
End

Set @response = (select top 1 IsInterested from PIDF_BusinessUnit_Interested Where PIDFId = @PIDFId And BusinessUnitId = @BUId)
Set @response = ISNULL(@response, 0)
RETURN @response;

END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[Get_PBF_Details]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--select [dbo].[Get_PIDF_Details_By_PIDF_Id](16,'MoleculeName')
CREATE FUNCTION [dbo].[Get_PBF_Details] (@PIDFId int,@BUId int,@type nvarchar(50))
RETURNS nvarchar(200) as 
BEGIN
declare @response nvarchar(200);
Declare @PIDFPBFId int = (Select top 1 PIdfPBFId from PIDF_PBF Where PIDFId = @PIDFId)
Declare @PBFGeneralId int = (Select top 1 PBFGeneralId from PIDF_PBF_General Where PIDFPBFId = @PIDFPBFId and BusinessUnitId=@BUId)

if(@type ='MoleculeName')
	begin
		declare @MoleculeName nvarchar(200);
		select @MoleculeName = MoleculeName from PIDF Where PIDFId = @PIDFId
		set @response = @MoleculeName;
	end

RETURN @response;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[Get_PIDF_Details]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




--select [dbo].[Get_PIDF_Details_By_PIDF_Id](16,'MoleculeName')
CREATE FUNCTION [dbo].[Get_PIDF_Details] (@PIDFId int,@type nvarchar(50))
RETURNS nvarchar(200) as 
BEGIN
declare @response nvarchar(200);
Declare @PIDFPBFId int = (Select top 1 PIdfPBFId from PIDF_PBF Where PIDFId = @PIDFId)
--Declare @PBFGeneralId int = (Select top 1 PBFGeneralId from PIDF_PBF_General Where PIDFPBFId = @PIDFPBFId and BusinessUnitId=@BUId)

if(@type ='MoleculeName')
	begin
		declare @MoleculeName nvarchar(200);
		select @MoleculeName = MoleculeName from PIDF Where PIDFId = @PIDFId
		set @response = @MoleculeName;
	end

RETURN @response;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetBioStudyCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select [dbo].[GetBioStudyCostPBFCharter](1,1,5)
CREATE FUNCTION [dbo].[GetBioStudyCostPBFCharter] (@PIDFId int,@BUId int, @PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @BioStudyCost float;
    
	select @BioStudyCost = sum(((isnull(E.FastingOrFed,0))*((isnull(E.NumberofVolunteers,0)*(isnull(E.ClinicalCostAndVolume,0)+isnull(E.BioAnalyticalCostAndVolume,0))+isnull(E.DocCostandStudy,0))))) 
	from PIDF As A
	Inner Join PIDF_PBF As B On A.PIDFId = B.PIDFId And B.PIDFId = @PIDFId
	Inner Join PIDF_PBF_General As C On C.PIDFPBFId = B.PIDFPBFId 
	Inner Join Master_BusinessUnit As D On D.BusinessUnitId = C.BusinessUnitId
	inner join PIDF_PBF_Clinical E on E.PBFGeneralId = C.PBFGeneralId 
	where A.PIDFId = @PIDFId and C.PBFGeneralId = @PBFGeneralId And C.BusinessUnitId <> @BUId

    RETURN isnull(@BioStudyCost,0);
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetCanBeApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 -- select dbo.GetCanBeApprove(186,87)
CREATE   function [dbo].[GetCanBeApprove]              
(  
@PIDFID bigint,
@USERID int =0
)            
returns bit as           
BEGIN        
     
	 declare @IsInteresbucOUNT AS INT
	 declare @MasterBUCOunt AS INT
	 declare @PIDFOlderThan15daysCount AS INT
	 declare @result AS bit

	;WITH myCTE as 
 (
 select A.BusinessUnitId as BUID  --count(distinct A.BusinessUnitId) 
 from PIDF_BusinessUnit_Interested A inner join
	 PIDF B on B.PIDFID = A.PIDFId
	 where A.PIDFID = @PIDFID
union
select  BusinessUnitId as BUID from PIDFProductStrength where PIDFID = @PIDFID
)
select @IsInteresbucOUNT=count(distinct BUID) from myCTE

	 select @MasterBUCOunt=count(BusinessUnitId) from Master_BusinessUnit where IsActive = 1 
	 --and BusinessUnitId  in (select BusinessUnitId from Master_UserBusinessUnitMapping where USerId =@USERID)

 	 select @PIDFOlderThan15daysCount =count(PIDFID) from PIDF where StatusId =2 and StatusUpdatedDate < DATEADD(day,-15,getdate()) and PIDFID = @PIDFID
	
	set @result= 0

	 if(	((@MasterBUCOunt=@IsInteresbucOUNT) and @IsInteresbucOUNT>0) or (@PIDFOlderThan15daysCount=1) )
	 begin
		set @result= 1
	 end
	 else
	 begin
	 set @result= 0
	 end

	 return @result;
END    

--update PIDF set StatusUpdatedDate = DATEADD(day,-17,getdate()) where  PIDFID = 175
GO
/****** Object:  UserDefinedFunction [dbo].[GetCapexCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- select [dbo].[GetCapexCostPBFCharter](1,,1)
CREATE FUNCTION [dbo].[GetCapexCostPBFCharter] (@PIDFId int,@BUId int, @PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @CapexCost float;
    
     select @CapexCost = sum(isnull(E.StrengthMiscellaneousExpense,0)) 
	from PIDF As A
	Inner Join PIDF_PBF As B On A.PIDFId = B.PIDFId And B.PIDFId = @PIDFId
	Inner Join PIDF_PBF_General As C On C.PIDFPBFId = B.PIDFPBFId 
	Inner Join Master_BusinessUnit As D On D.BusinessUnitId = C.BusinessUnitId
	inner join PIDF_PBF_RnD_CapexMiscellaneousExpenses E on E.PBFGeneralId = C.PBFGeneralId
	where A.PIDFId = @PIDFId and C.PBFGeneralId = @PBFGeneralId And C.BusinessUnitId <> @BUId
  
    RETURN isnull(@CapexCost,0);
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetCurrencyCode]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[GetCurrencyCode] (@PIDFID int)
RETURNS nvarchar(5) as 
BEGIN
	declare @CurrencyCode nvarchar(max);
    
	select top 1  @CurrencyCode= D.CurrencyCode
	from PIDF_Commercial_Years A     
	inner join PIDF_Commercial B on A.PIDFCommercialId = B.PIDFCommercialId        
	inner join PIDF C on C.PIDFID = B.PIDFId and C.BusinessUnitId = B.BusinessUnitId        
	inner join Master_Currency D on D.CurrencyID = A.CurrencyId        
	where B.PIDFId =@PIDFID      
  
	if(@CurrencyCode is null)  
	begin  
	set @CurrencyCode = 'INR';  
	end  
  
    RETURN @CurrencyCode;
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetCurrencySymbol]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[GetCurrencySymbol] (@PIDFID int)
RETURNS nvarchar(5) as 
BEGIN
	declare @CurrencySymbol nvarchar(max);
    
	select top 1  @CurrencySymbol= D.CurrencySymbol 
	from PIDF_Commercial_Years A     
	inner join PIDF_Commercial B on A.PIDFCommercialId = B.PIDFCommercialId        
	inner join PIDF C on C.PIDFID = B.PIDFId and C.BusinessUnitId = B.BusinessUnitId        
	inner join Master_Currency D on D.CurrencyID = A.CurrencyId        
	where B.PIDFId =@PIDFID      
  
	if(@CurrencySymbol is null)  
	begin  
	set @CurrencySymbol = '$';  
	end  
  
    RETURN @CurrencySymbol;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetExhibitPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[GetExhibitPBFCharter] (@PBFGeneralId int)
RETURNS float as  
BEGIN
	declare @Exhibit float;
    
	select @Exhibit = sum(ExhibitBatch1 + ExhibitBatch2 + ExhibitBatch3) from PIDF_PBF_RnD_APIRequirement where PBFGeneralId = @PBFGeneralId      
  
    RETURN isnull(@Exhibit,0);
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetFillingCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select [dbo].[GetFillingCostPBFCharter] (1,1,5)
CREATE FUNCTION [dbo].[GetFillingCostPBFCharter] (@PIDFId int,@BUId int, @PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @FillingCost float;	      
    select @FillingCost = sum(isnull(E.TotalCost,0)) 
	from PIDF As A
	Inner Join PIDF_PBF As B On A.PIDFId = B.PIDFId And B.PIDFId = @PIDFId
	Inner Join PIDF_PBF_General As C On C.PIDFPBFId = B.PIDFPBFId 
	Inner Join Master_BusinessUnit As D On D.BusinessUnitId = C.BusinessUnitId
	inner join PIDF_PBF_RnD_FillingExpenses E on E.PBFGeneralId = C.PBFGeneralId and E.BusinessUnitId = @BUId
	where A.PIDFId = @PIDFId and C.PBFGeneralId = @PBFGeneralId And C.BusinessUnitId <> @BUId
    
	RETURN isnull(@FillingCost,0);
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[GetMultipleBusinessUnit] (@UserId int)
RETURNS nvarchar(max) as 
BEGIN
	declare @StrBusinessUnitName nvarchar(max);
    

	 WITH BUMaptable AS
 (	
	select Map.UserId,MB.BusinessUnitName,MB.BusinessUnitId from Master_BusinessUnit MB 
	inner join Master_UserBusinessUnitMapping Map
		on MB.BusinessUnitId= Map.BusinessUnitId
		where Map.UserId =@UserId 
)
SELECT  
      @StrBusinessUnitName = 
        STUFF((SELECT ', ' + BusinessUnitName
           FROM BUMaptable b 
           WHERE b.UserId = a.UserId 
          FOR XML PATH('')), 1, 2, '')
FROM BUMaptable a

    RETURN @StrBusinessUnitName;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleBusinessUnitIds]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create FUNCTION [dbo].[GetMultipleBusinessUnitIds] (@UserId int)
RETURNS nvarchar(max) as 
BEGIN
	declare @StrBusinessUnitIds nvarchar(max);
    

	 WITH BUMaptable AS
 (	
	select Map.UserId,MB.BusinessUnitId from Master_BusinessUnit MB 
	inner join Master_UserBusinessUnitMapping Map
		on MB.BusinessUnitId= Map.BusinessUnitId
		where Map.UserId =@UserId 
)
SELECT  
      @StrBusinessUnitIds = 
        STUFF((SELECT ', ' + BusinessUnitId
           FROM BUMaptable b 
           WHERE b.UserId = a.UserId 
          FOR XML PATH('')), 1, 2, '')
FROM BUMaptable a

    RETURN @StrBusinessUnitIds;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetMultipleDepartment]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create FUNCTION [dbo].[GetMultipleDepartment] (@UserId int)
RETURNS nvarchar(max) as 
BEGIN
	declare @StrDepartmentName nvarchar(max);
    

	 WITH DepartmentMaptable AS
 (	
	select B.UserId,A.DepartmentName,a.DepartmentId from Master_Department A 
	inner join Master_UserDepartmentMapping B on B.DepartmentId=A.DepartmentId
		where B.UserId =@UserId 
)
SELECT  
      @StrDepartmentName = 
        STUFF((SELECT ', ' + DepartmentName
           FROM DepartmentMaptable b 
           WHERE b.UserId = a.UserId 
          FOR XML PATH('')), 1, 2, '')
FROM DepartmentMaptable a

    RETURN @StrDepartmentName;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetProjectEndDate]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[GetProjectEndDate] (@PIDFId int)
RETURNS int as 
BEGIN
	declare @DurationinDays int;
    
select @DurationinDays = Cast(IsNull(SUM(IsNull(DurationInDays, 0)), 0) as Int) from PIDF_PBF_RnD_ManPowerCost As A
Inner JOin PIDF_PBF_General As B On A.PBFGeneralId = B.PBFGeneralId
Inner Join PIDF_PBF As C On C.PIDFPBFId = B.PIDFPBFId
Inner Join PIDF As D On D.PIDFId = C.PIDFId And B.BusinessUnitId = D.BusinessUnitId
Where D.PIDFId = @PIDFId

    RETURN @DurationinDays;
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[GetPrototypePBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[GetPrototypePBFCharter] (@PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @Prototype float;
    
	select @Prototype = sum(Prototype) from PIDF_PBF_RnD_APIRequirement where PBFGeneralId = @PBFGeneralId      
  
    RETURN isnull(@Prototype,0);
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetReferenceProductCostPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[GetReferenceProductCostPBFCharter] (@PIDFId int,@BUId int , @PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @ReferenceProductCost float;
    
	select @ReferenceProductCost = sum((isnull(UnitCostOfReferenceProduct,0) * (isnull(FormulationDevelopment,0) + isnull(PilotBE,0))) + (isnull(UnitCostOfReferenceProduct,0) * (isnull(PharmasuiticalEquivalence,0) + isnull(PivotalBio,0)))) from PIDF_PBF_RnD_ReferenceProductDetail
	where PBFGeneralId = @PBFGeneralId

    RETURN isnull(@ReferenceProductCost,0);
END;
GO
/****** Object:  UserDefinedFunction [dbo].[GetScaleUpPBFCharter]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[GetScaleUpPBFCharter] (@PBFGeneralId int)
RETURNS float as 
BEGIN
	declare @ScaleUp float;
    
	select @ScaleUp = sum(ScaleUp) from PIDF_PBF_RnD_APIRequirement where PBFGeneralId = @PBFGeneralId      
  
    RETURN isnull(@ScaleUp,0);
END;
    
GO
/****** Object:  UserDefinedFunction [dbo].[ufn_Split]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
 
/*Modification History:   ----------------------------
    WHEN ?           WHO?              WHAT? 
09/15/2023		YallaReddy CH		Fixes Used to get All values with comma separate
------------------------------------------------------- */
CREATE FUNCTION [dbo].[ufn_Split]
(
    @ListString NVARCHAR(max),
    @Delimiter VARCHAR(5) = ','
)
RETURNS @TableOfValues TABLE
	(
		Id SMALLINT IDENTITY(1,1),
		[Value] NVARCHAR(MAX)
	) 
AS 
BEGIN
    DECLARE @DelimiterLength INT = LEN(@Delimiter)
    DECLARE @ValueLength INT
  
    WHILE LEN(@ListString) > 0 
    BEGIN 
      SELECT @ValueLength = (CASE CHARINDEX(@Delimiter, @ListString) WHEN 0 THEN LEN(@ListString) ELSE (CHARINDEX(@Delimiter, @ListString) - 1) END) 
      
      INSERT INTO @TableOfValues 
        SELECT SUBSTRING(@ListString, 1, @ValueLength)
      
      SELECT @ListString = (CASE (LEN(@ListString) - @ValueLength) WHEN 0 THEN '' ELSE RIGHT(@ListString, LEN(@ListString) - @ValueLength - @DelimiterLength) END) 
    END
    
    RETURN
END  
GO
/****** Object:  UserDefinedFunction [dbo].[GetBusinessUnitInterestedInPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from [dbo].[GetBusinessUnitInterestedInPIDF](189, 1)    
CREATE FUNCTION [dbo].[GetBusinessUnitInterestedInPIDF] (@PIDFId int,@BUId int)    
RETURNS TABLE as     
Return(  
Select BusinessUnitName,   
Case 
when IsNull((select BusinessUnitId from PIDF where PIDFID = @PIDFId),0)=@BUId then 1
When IsNull(B.PIDFBusinessUnitId, 0) = 0 Then 3   
When IsNull(B.IsInterested, 0) = 0 Then 2 Else 1 End As ActionStatus,   
--convert(date,B.CreatedDate,6) As InterestedDate,   
B.CreatedDate As InterestedDate, 
C.FullName  
from Master_BusinessUnit As A  
Left Join PIDF_BusinessUnit_Interested As B On A.BusinessUnitId = B.BusinessUnitId And B.PIDFId = @PIDFId  
Left JOin [Master_User] As C On C.UserId = B.CreatedBy  
Where A.BusinessUnitId = @BUId  
)   

--	select BusinessUnitId= from PIDF where PIDFID = 189
GO
/****** Object:  UserDefinedFunction [dbo].[GetCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE FUNCTION [dbo].[GetCountryByBusinessUnit] 
(	
	@BusinessUnitId int,
	@UserId int
)
RETURNS TABLE 
AS
RETURN 
(
Select DISTINCT A.CountryId, CountryName, C.BusinessUnitId, D.UserId from Master_Country As A
Inner Join Master_RegionCountryMapping As B On A.CountryID = B.CountryId
Inner Join Master_BusinessUnitRegionMapping As C On B.RegionId = C.RegionId
Inner Join Master_UserCountryMapping As D On A.CountryID = D.CountryId
Where C.BusinessUnitId = @BusinessUnitId  And D.UserId = @UserId AND A.IsActive =1
)
GO
/****** Object:  UserDefinedFunction [dbo].[GetCountryForBusinessUnitAndPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
-- select * from PIDF where PIDFID = 59    
-- select * from  dbo.[GetCountryForBusinessUnitAndPIDF](79,2)  
  
---select * from PIDFProductStrength where PIDFID = 79 and BusinessUnitId =2  
--select * from PIDFProductStrength_CountryMapping where PIDFProductStrengthId in  (237,238) 238   
CREATE FUNCTION [dbo].[GetCountryForBusinessUnitAndPIDF]             
(             
 @PIDFID BIGINT,            
 @BusinessUnitId INT = NULL          
)            
RETURNS TABLE             
AS            
RETURN             
(
	-- if any chnage made here, nned to same chnage in SP-->[stp_npd_GetCommercialFormData] For BU wise COuntry Fetching       
	 SELECT DISTINCT A.CountryId, CountryName 
	 FROM Master_Country As A                   
	 INNER JOIN PIDFProductStrength_CountryMapping As F ON F.CountryId = A.CountryID     
	 INNER JOIN PIDFProductStrength As E on E.PIDFProductStrengthId = F.PIDFProductStrengthId  
	 WHERE E.PIDFID = @PIDFId 
		AND (@BusinessUnitId IS NULL OR E.BusinessUnitId =  @BusinessUnitId)
		AND A.IsActive = 1           
  
) 
GO
/****** Object:  UserDefinedFunction [dbo].[GetPIDFHistoryStatusByPIDFID]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- select * from  dbo.GetPIDFHistoryStatusByPIDFID(21) Order By CreatedDate desc

CREATE FUNCTION [dbo].[GetPIDFHistoryStatusByPIDFID] 
(	
	@PIDFID Bigint
)
RETURNS TABLE 
AS
RETURN 
(
select B.PIDFStatus, A.CreatedDate, C.FullName, B.StatusColor,IsNUll(A.StatusRemark, '') [Remark] from PIDFStatusHistory As A    
Inner Join Master_PIDFStatus As B On A.StatusId = B.PIDFStatusID    
Inner Join Master_User As C On C.UserId = A.CreatedBy    
where PIDFID = @PIDFID and B.PIDFStatusID not in (20,21) -- [20,21 --> MangmentStatus]
union all
select B.PIDFStatus, A.CreatedDate, C.FullName, B.StatusColor,A.Remark [Remark] from PIDF_ManagementApprovalStatusHistory As A  
Inner Join Master_PIDFStatus As B On A.StatusId = B.PIDFStatusID  
Inner Join Master_User As C On C.UserId = A.CreatedBy  
where PIDFID =@PIDFID  
)
GO
/****** Object:  StoredProcedure [dbo].[AddUpdatePIDF_Finance_BatchSizeCoating]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[AddUpdatePIDF_Finance_BatchSizeCoating] (
	@table PIDF_Finance_BatchSizeCoatingTable_Type Readonly
	,@Success NVARCHAR(12) = '' OUTPUT
	)
AS
BEGIN
	BEGIN TRAN

	BEGIN TRY
		MERGE PIDF_Finance_BatchSizeCoating AS dbEAddUpdatePIDF_Finance_BatchSizeCoating
		USING @table AS tbltypeBatchSizeCoating
			ON (
					dbEAddUpdatePIDF_Finance_BatchSizeCoating.PIDFFinaceBatchSizeCoatingId = tbltypeBatchSizeCoating.PIDFFinaceBatchSizeCoatingId
					AND tbltypeBatchSizeCoating.PIDFFinaceBatchSizeCoatingId > 0 
					)
		WHEN MATCHED 
			THEN
				UPDATE
				SET PIDFFinaceId = tbltypeBatchSizeCoating.PIDFFinaceId
					,BusinessUnitId = tbltypeBatchSizeCoating.BusinessUnitId
					,Batchsize = tbltypeBatchSizeCoating.Batchsize
					,Yield = tbltypeBatchSizeCoating.Yield
					,Batchoutput = tbltypeBatchSizeCoating.Batchoutput
					,API_CAD = tbltypeBatchSizeCoating.API_CAD
					,Excipients_CAD = tbltypeBatchSizeCoating.Excipients_CAD
					,PM_CAD = tbltypeBatchSizeCoating.PM_CAD
					,CCPC_CAD = tbltypeBatchSizeCoating.CCPC_CAD
					,Freight_CAD = tbltypeBatchSizeCoating.Freight_CAD
					,EmcureCOGs_pack = tbltypeBatchSizeCoating.EmcureCOGs_pack
					,CreatedDate = tbltypeBatchSizeCoating.CreatedDate
					,CreatedBy = tbltypeBatchSizeCoating.CreatedBy
					,Skus=tbltypeBatchSizeCoating.Skus
					,PakeSize=tbltypeBatchSizeCoating.PakeSize
					,BrandPrice=tbltypeBatchSizeCoating.BrandPrice
					,NetRealisation=tbltypeBatchSizeCoating.NetRealisation
					,GenericListprice=tbltypeBatchSizeCoating.GenericListprice
					,EstMAT2016_BY_12Units=tbltypeBatchSizeCoating.EstMAT2016_BY_12Units
					,EstMAT2020_BY_12Units=tbltypeBatchSizeCoating.EstMAT2020_BY_12Units
					,CAGRover2016_By_12EstMATunits=tbltypeBatchSizeCoating.CAGRover2016_By_12EstMATunits
					,Marketinpacks=tbltypeBatchSizeCoating.Marketinpacks
					,Batchsizein_ltr_tabs=tbltypeBatchSizeCoating.Batchsizein_ltr_tabs
		WHEN NOT MATCHED 
			THEN
				INSERT (
					[PIDFFinaceId]
					,[BusinessUnitId]
					,[Batchsize]
					,[Yield]
					,[Batchoutput]
					,[API_CAD]
					,[Excipients_CAD]
					,[PM_CAD]
					,[CCPC_CAD]
					,[Freight_CAD]
					,[EmcureCOGs_pack]
					,[CreatedDate]
					,[CreatedBy]
					,Skus
					,PakeSize
					,BrandPrice
					,NetRealisation
					,GenericListprice
					,EstMAT2016_BY_12Units
					,EstMAT2020_BY_12Units
					,CAGRover2016_By_12EstMATunits
					,Marketinpacks
					,Batchsizein_ltr_tabs
					)
				VALUES (
					tbltypeBatchSizeCoating.PIDFFinaceId
					,tbltypeBatchSizeCoating.BusinessUnitId
					,tbltypeBatchSizeCoating.Batchsize
					,tbltypeBatchSizeCoating.Yield
					,tbltypeBatchSizeCoating.Batchoutput
					,tbltypeBatchSizeCoating.API_CAD
					,tbltypeBatchSizeCoating.Excipients_CAD
					,tbltypeBatchSizeCoating.PM_CAD
					,tbltypeBatchSizeCoating.CCPC_CAD
					,tbltypeBatchSizeCoating.Freight_CAD
					,tbltypeBatchSizeCoating.EmcureCOGs_pack
					,tbltypeBatchSizeCoating.CreatedDate
					,tbltypeBatchSizeCoating.CreatedBy
					,tbltypeBatchSizeCoating.Skus
					,tbltypeBatchSizeCoating.PakeSize
					,tbltypeBatchSizeCoating.BrandPrice
					,tbltypeBatchSizeCoating.NetRealisation
					,tbltypeBatchSizeCoating.GenericListprice
					,tbltypeBatchSizeCoating.EstMAT2016_BY_12Units
					,tbltypeBatchSizeCoating.EstMAT2020_BY_12Units
					,tbltypeBatchSizeCoating.CAGRover2016_By_12EstMATunits
					,tbltypeBatchSizeCoating.Marketinpacks
					,tbltypeBatchSizeCoating.Batchsizein_ltr_tabs
					);

		SELECT @Success = 'success';

		COMMIT TRAN
	END TRY

	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[AddUpdatePIDF_Pbf_ra]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




Create PROCEDURE [dbo].[AddUpdatePIDF_Pbf_ra] (
	@table Type_PIDF_PBF_RA Readonly
	,@Success NVARCHAR(12) = '' OUTPUT
	)
AS
BEGIN
	BEGIN TRAN

	BEGIN TRY
		MERGE PIDF_PBF_RA AS dbPIDF_PBF_RA
		USING @table AS typetable
			ON (
					dbPIDF_PBF_RA.PIDFPBFRAId = typetable.PIDFPBFRAId
					AND typetable.PIDFPBFRAId > 0 
					)
		WHEN MATCHED 
			THEN
				UPDATE
				  SET PIDFId = typetable.PIDFId,
				      PBFId = typetable.PBFId,
					  CountryIdBuId = typetable.CountryIdBuId,
					  PivotalBatchManufactured = typetable.PivotalBatchManufactured,
					  LastDataFromRnD = typetable.LastDataFromRnD,
					  BEFinalReport = typetable.BEFinalReport,
					  BuId = typetable.BuId,
					  TypeOfSubmissionId = typetable.TypeOfSubmissionId,
					  DossierReadyDate = typetable.DossierReadyDate,
					  EarliestSubmissionDExcl = typetable.EarliestSubmissionDExcl,
					  EarliestLaunchDExcl = typetable.EarliestLaunchDExcl,
					  LasDateToRegulatory = typetable.LasDateToRegulatory,
					  UpdatedOn = typetable.UpdatedOn,
					  CreatedBy=typetable.CreatedBy,
					  EndOfProcedureDate=typetable.EndOfProcedureDate,
					  CountryApprovalDate=typetable.CountryApprovalDate
					 
		WHEN NOT MATCHED 
			THEN
				INSERT (
					PIDFId,
                    PBFId,
                    CountryIdBuId,
                    PivotalBatchManufactured,
                    LastDataFromRnD,
                    BEFinalReport,
                    BuId,
                    TypeOfSubmissionId,
                    DossierReadyDate,
                    EarliestSubmissionDExcl,
                    EarliestLaunchDExcl,
					LasDateToRegulatory,
                    CreatedOn,
                    CreatedBy,
					EndOfProcedureDate,
					CountryApprovalDate
					)
				VALUES (
					typetable.PIDFId,
                    typetable.PBFId,
                    typetable.CountryIdBuId,
                    typetable.PivotalBatchManufactured,
                    typetable.LastDataFromRnD,
                    typetable.BEFinalReport,
                    typetable.BuId,
                    typetable.TypeOfSubmissionId,
                    typetable.DossierReadyDate,
                    typetable.EarliestSubmissionDExcl,
                    typetable.EarliestLaunchDExcl,
					typetable.LasDateToRegulatory,
                    typetable.CreatedOn,
                    typetable.CreatedBy,
					typetable.EndOfProcedureDate,
					typetable.CountryApprovalDate
					);

		SELECT @Success = 'success';

		COMMIT TRAN
	END TRY

	BEGIN CATCH
		ROLLBACK TRAN
	END CATCH
END



GO
/****** Object:  StoredProcedure [dbo].[AutoUpdatePIDFStatus]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
      
--   exec AutoUpdatePIDFStatus      
        
CREATE PROCEDURE [dbo].[AutoUpdatePIDFStatus]         
AS        
BEGIN        
      
---------------------Get User and PIDF details to Send Mail----------------------------------------------------------------------------------------------------      
select p.PIDFNO,           
(select PIDFStatus from Master_PIDFStatus where PIDFStatusID = 4) as PIDFStatus,       
p.MoleculeName ,u.FullName,u.EmailAddress, p.PIDFID INTO #tmpPIDFReject from  PIDF p  
Inner Join PIDFStatusHistory As B On P.PIDFID = B.PIDFID And B.StatusId = 7
--inner join Master_PIDFStatus p_sts on p.StatusId = p_sts.PIDFStatusID    
inner join Master_UserBusinessUnitMapping UserBUMap on UserBUMap.BusinessUnitId = p.BusinessUnitId    
inner join Master_User u on u.UserId = UserBUMap.UserId       
where  dateadd(DD, 15, p.StatusUpdatedDate) < getdate()  
And p.PIDFId NOT IN (Select PIDFId from PIDFStatusHistory Where StatusId In (10, 11))
--and   p.StatusId = 7 --[IPD Approved = 7]    
--and   p.IsActive =1    
and u.UserId in (    
select u.UserId from Master_User u     
inner join RoleModulePermission rolepermission on rolepermission.RoleId = u.RoleId    
where rolepermission.ModuleId = 15 --[15 = Commercial Management]    
and (rolepermission.[Edit] =1 or  rolepermission.[Add] =1)    
)
and u.IsActive = 1 And u.IsDeleted = 0    
And p.StatusId NOt IN (4, 8)


Select * from #tmpPIDFReject

-------------------Update PIDF Table-----------------------------------------------------------      
      
update PIDF set StatusId = 4, LastStatusId = 7, StatusRemark ='Commercial detail has not been submitted for this PIDF since 15 days,so its been rejected automatically by system.'       
where PIDFId IN (Select DISTINCT PIDFID from #tmpPIDFReject) And StatusId NOt IN (4, 8)

DROP Table #tmpPIDFReject     
      
END        
GO
/****** Object:  StoredProcedure [dbo].[GetBusinessUnitDetails]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- Author:  <Author,,Name>  
-- Create date: <Create Date,,>  
-- Description: <Description,,>  
-- =============================================  

-- exec [GetBusinessUnitDetails] 2, 1
CREATE PROCEDURE [dbo].[GetBusinessUnitDetails] --2,1  
@PIDFID BIGINT,  
@BUID BIGINT  
AS  
BEGIN  
--SELECT 'India' as Country, 'Strength1' as Strength, 'PackSize1' as PackSize, 'Packing1' as Packing,'1st Year Price/Pack' as FirstYearPrice,  
--'1st Year Qty' as FirstYearQty, '1st Year Volume' as FirstYearVolume,'2nd Year Price/Pack' as SecondYearPrice,  
--'2nd Year Qty' as SecondYearQty,'2nd Year Volume' as SecondYearvolume,'3rd Year Price/Pack' as ThirdYearPrice,  
--'3rd Year Qty' as ThirdYearQty, '3rd Year Volume' as ThirdYearVolume,'Batch Size' as BatchSize,'Currency' as Currency,  
--'1st Yaer Cogs' as FirstyearCogs, '2nd Year Cogs' as SecondYearCogs,'3rd Year Cogs' as ThirdYearCogs,'Freight' as Freight,  
--'Total Cost' as TotalCost,'3 Year Contribution' as ThreeYearcontribution,'Cost of 3 Batches' as CostOfThreeBatches,  
--'Analytical Cost' as AnalyticalCost, 'BECost' as BECost, 'RLD Cost' as RLDCost, 'R&D Cost' as RnDCost, 'Filing Cost' as FilingCost,  
--'Stability Cost' as StabilityCost, 'Total Invest' as TotalInvest, 'Other Cost' as OtherCost, 'API Source' as APISource,  
--'ROI' as ROI  
  
--from Master_BusinessUnit  
--where (BusinessUnitId=@BUID)  
  
-- A.InHouses == true then "Yes" Else "No"  
  
Select A.MoleculeName As ProjectName, C.CountryName Country,  
case when A.InHouses=1 then 'Yes' Else 'No' end InHouses  
, 'Year' + Cast(YearIndex as nvarchar(10)) As [Year], E.CommercialBatchSize [BatchSize], E.PriceDiscounting, E.MarketGrowth, E.SUIMSVolume  
, E.TotalAPIReq, G.CurrencyName, F.PackagingTypeName, (D.Strength + H.UnitofMeasurementName) As Strength, E.MarketSize  
from PIDF As A  
Inner Join PIDF_Commercial As B On A.PIDFID = B.PIDFId  
Inner Join Master_Country As C On C.CountryId = A.RFDCountryId  
Inner Join PIDFProductStrength As D ON B.PIDFProductStrengthId = D.PIDFProductStrengthId  And D.BusinessUnitId = @BUID
Inner Join PIDF_Commercial_Years As E On E.PIDFCommercialId = B.PIDFCommercialId  
Inner Join Master_PackagingType As F On F.PackagingTypeId = E.PackagingTypeId  
Inner Join Master_Currency As G On G.CurrencyId = E.CurrencyId  
Inner Join Master_UnitofMeasurement As H On H.UnitofMeasurementId = D.UnitofMeasurementId  
Where A.PIDFID = @PIDFID And B.BusinessUnitId = @BUID  
END  
GO
/****** Object:  StoredProcedure [dbo].[GetCountryWisePackSizeStabilityData]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [dbo].[GetCountryWisePackSizeStabilityData] 353,2,2  
CREATE      Proc [dbo].[GetCountryWisePackSizeStabilityData]    
(    
 @PIDFId bigint,    
 @BUId int ,
 @CountryId int  
 )    
 AS     
 BEGIN    
	Select distinct(A.PIDFProductStrengthId),Strength,a.UnitofMeasurementId,B.UnitofMeasurementName,MC.CountryName
	from PIDFProductStrength As A    
	inner join PIDF_Commercial D on A.PIDFProductStrengthId=D.PIDFProductStrengthId
	inner join Master_Country MC on D.CountryId=MC.CountryID
	Inner Join [Master_UnitofMeasurement] As B  on a.UnitofMeasurementId=b.UnitofMeasurementId    
	Where A.PIDFId = @PIDFId And A.BusinessUnitId = @BUId and D.CountryId=@CountryId
	order by A.PIDFProductStrengthId desc    
    
	Select      
	ps.PackSizeId,ps.PackSizeName,PIDFProductStrengthId  
	,Isnull(C.Value,'')Value,Isnull(c.PackSizeStabilityId,0) PackSizeStabilityId,MC.CountryName   
	from PIDF_Commercial as D    
	inner join master_packsize as ps on ps.PackSizeId=d.PackSizeId and ps.IsActive=1 
	inner join Master_Country MC on D.CountryId=MC.CountryID
	left join PIDF_PBF_RnD_PackSizeStability As C on c.PIDFID=D.PIDFId and d.PackSizeId=c.PackSizeId and d.CountryId=c.countryid      
	Where D.PIDFId = @PIDFId and d.BusinessUnitId=@BUId  and d.IsDeleted=0 and D.CountryId=@CountryId
	order by PIDFProductStrengthId desc    
  
END 
GO
/****** Object:  StoredProcedure [dbo].[GetEmailNotification]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[GetEmailNotification]
@NotificationId bigint
As 
Begin
  

Select DISTINCT 
A.UserId, NotificationId, F.PIDFID, A.FullName as SendToName, A.EmailAddress, D.PIDFStatus, F.PIDFNO as PidfNo,
G.FullName as CreatedByName, G.CreatedDate  
from [Master_User] As A
Inner Join [Master_Role] As B On A.RoleId = B.RoleId
Inner Join RoleModulePermission As C On B.RoleId = C.RoleId And (C.[Add] = 1 Or C.Edit = 1 Or C.Approve = 1)
And ModuleId In (5, 6, 7, 8, 9, 13, 15, 16)
Inner Join Master_PIDFStatus As D On D.ModuleId = C.ModuleId
Inner Join Master_Notification As E On E.StatusId = D.PIDFStatusId
Inner Join [PIDF] As F On F.PIDFId = E.PIDFId
Inner Join [Master_User] As G On G.UserId = E.CreatedBy --And G.IsActive = 1 And G.IsDeleted = 0
Where A.isActive = 1 And A.IsDeleted = 0 And E.IsEmailSent = 0 and E.NotificationId=@NotificationId
End
GO
/****** Object:  StoredProcedure [dbo].[GetFinaceProjectionYear]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE Proc [dbo].[GetFinaceProjectionYear] --3
@monthTobeDeduct int=3
AS BEGIN

declare @CurrentYear int=(select YEAR(GETDATE()));
declare @PrevYear int=(select YEAR(DATEADD(MONTH,-@monthTobeDeduct,GETDATE())))
if(@CurrentYear!= @PrevYear)
BEGIN

 --case when @CurrentYear!= @PrevYear
 --then (SELECT 'Mar-'+ right('0'+right(datepart(YEAR,DATEADD(MONTH,-@monthTobeDeduct,GETDATE())),2),2))
 --else (SELECT 'Mar-'+ right('0'+right(datepart(YEAR,DATEADD(YEAR,0,GETDATE())),2),2)) end as Years  
 SELECT 'Mar-'+ right('0'+right(datepart(YEAR,DATEADD(YEAR,-1,GETDATE())),2),2) as Years  
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,0,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,1,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,2,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,3,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,4,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,5,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,6,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,7,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,8,GETDATE())),2),2) as Years

END
ELSE IF(@CurrentYear= @PrevYear)
BEGIN

SELECT 'Mar-'+ right('0'+right(datepart(YEAR,DATEADD(YEAR,0,GETDATE())),2),2) as Years  
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,1,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,2,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,3,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,4,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,5,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,6,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,7,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,8,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,9,GETDATE())),2),2) as Years
union all
SELECT 'Mar-'+ right('0'+right(datepart(YEAR, DATEADD(YEAR,10,GETDATE())),2),2) as Years
END
END
GO
/****** Object:  StoredProcedure [dbo].[GetPackSizeStabilityData]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--[dbo].[GetPackSizeStabilityData] 128,5  
CREATE Proc [dbo].[GetPackSizeStabilityData]    
(    
 @PIDFId bigint,    
 @BUId int    
 )    
 AS     
 BEGIN    
  
Select PIDFProductStrengthId,Strength,a.UnitofMeasurementId,B.UnitofMeasurementName from PIDFProductStrength As A    
Inner Join [Master_UnitofMeasurement] As B  on a.UnitofMeasurementId=b.UnitofMeasurementId    
  Where PIDFId = @PIDFId And A.BusinessUnitId = @BUId
order by PIDFProductStrengthId desc    
    
Select      
ps.PackSizeId,ps.PackSizeName,PIDFProductStrengthId  
,Isnull(C.Value,'')Value,Isnull(c.PackSizeStabilityId,0) PackSizeStabilityId   
from PIDF_Commercial as D    
inner join master_packsize as ps on ps.PackSizeId=d.PackSizeId and ps.IsActive=1    
left join PIDF_PBF_RnD_PackSizeStability As C on c.PIDFID=D.PIDFId and d.PackSizeId=c.PackSizeId      
Where D.PIDFId = @PIDFId and d.BusinessUnitId=@BUId  and d.IsDeleted=0  
order by PIDFProductStrengthId desc    
  
END 
GO
/****** Object:  StoredProcedure [dbo].[GetPIDFByYearAndBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- exec [GetPIDFByYearAndBusinessUnit] 5, '04-01-1970', '03-31-2024',87
CREATE procedure [dbo].[GetPIDFByYearAndBusinessUnit] (      
@BusinessUnitId int,      
@FinancialYearStart varchar(20),      
@FinancialYearEnd varchar(20),     
@UserId int    
)      
as      
begin      
    
	Select Row_Number() Over (Partition by PIDFId Order By CreatedDate Desc) As Row_Number1,
PIDFId, StatusId,CreatedDate,ManagementApprovalStatusHistoryId into #Temptable1 from PIDF_ManagementApprovalStatusHistory 


Set @BusinessUnitId = IsNull(@BusinessUnitId, 0)    
 (   
Select PIDFStatusID, PIDFStatus, SUM((Case When B.PIDFStatusHistoryId is not null And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)   
And (D.UserId = @UserId) then 1 else 0 end)) As StatusCount  
  
, A.StatusTextColor,  A.StatusColor from Master_PIDFStatus As A    
Left Join PIDFStatusHistory As B On A.PIDFStatusID = B.StatusId And Cast(B.CreatedDate as Date) Between CAST(@FinancialYearStart AS Date ) AND CAST(@FinancialYearEnd AS Date)      
Left Join [PIDF] As C On B.PIDFID = C.PIDFID And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)    
Left Join [Master_UserBusinessUnitMapping] As D On D.BusinessUnitId = C.BusinessUnitId And (D.UserId = @UserId)    
WHERE A.IsDashboard = 1 And PIDFStatusID Not In (20,21)  
--And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)    
Group BY PIDFStatusID, PIDFStatus, A.StatusTextColor,  A.StatusColor    
 )     
union all ----------------------------------------------------------------------------  
(  
Select PIDFStatusID, PIDFStatus, SUM((Case When B.ManagementApprovalStatusHistoryId is not null And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)   
And (D.UserId = @UserId) then 1 else 0 end)) As StatusCount  
  
, A.StatusTextColor,  A.StatusColor from Master_PIDFStatus As A    
Left Join #Temptable1 As B On A.PIDFStatusID = B.StatusId  And Row_Number1 =1 And Cast(B.CreatedDate as Date) Between CAST(@FinancialYearStart AS Date ) AND CAST(@FinancialYearEnd AS Date)      
Left Join [PIDF] As C On B.PIDFID = C.PIDFID And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)    
Left Join [Master_UserBusinessUnitMapping] As D On D.BusinessUnitId = C.BusinessUnitId And (D.UserId = @UserId)    
WHERE A.IsDashboard = 1 And PIDFStatusID In (20,21)  
--And (C.BusinessUnitId = @BusinessUnitId Or @BusinessUnitId = 0)    
Group BY PIDFStatusID, PIDFStatus, A.StatusTextColor,  A.StatusColor    
)  
----------------------------------------------------------------------------  
Order By PIDFStatusID   
drop table #Temptable1
end 
GO
/****** Object:  StoredProcedure [dbo].[GetStrengthForPBF_TDP]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--[dbo].[GetStrengthForPBF_TDP] 181
CREATE     Proc [dbo].[GetStrengthForPBF_TDP]
@PIDFID bigint,
@BUId bigint = 0     
As
BEGIN
select distinct(A.Strength),a.PIDFProductStrengthId,B.UnitofMeasurementName from PIDFProductStrength as A
  inner join Master_UnitofMeasurement as B on a.UnitofMeasurementId=b.UnitofMeasurementId
  inner join PIDF As C on c.UnitofMeasurementId=a.UnitofMeasurementId
  where A.PIDFID=@PIDFID and A.BusinessUnitId=@BUId --and b.IsActive=0 
  order by (A.Strength)

END
GO
/****** Object:  StoredProcedure [dbo].[GetTaskSubTaskFileProject]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
-- =============================================      
-- Author:  <Author,,Name>      
-- Create date: <Create Date,,>      
-- Description: <Description,,>      
-- =============================================     
-- exec [GetTaskSubTaskFileProject] 291, 4
CREATE PROCEDURE [dbo].[GetTaskSubTaskFileProject] --57,4     
 @PIDFID INT,      
 @FilterId INT=0--0 all,1 monthly,2 quatrely,3 half yearly,4 Annually      
 AS       
 BEGIN      
 
	 SELECT top 1 MoleculeName AS ProjectName,mpt.ProductTypeName AS ProductType,mp.PlantNameName AS PlantName,'Formulation' AS Formulation ,wf.WorkflowName as WorkFlow 
	 FROM PIDF as p      
	 left join PIDF_PBF as Pb on p.PIDFID=pb.PIDFId       
	 left join Master_ProductType mpt on pb.PackagingTypeId=mpt.ProductTypeId      
	 left join Master_Workflow wf     on pb.WorkflowId=wf.WorkflowId      
	 left join Master_Plant      mp   on pb.PlantId=mp.PlantId      
	 WHERE (p.PIDFID=@PIDFID )       
        
      
	 SELECT FileName FROM PIDF_Medical_File mfile join PIDF_Medical m on mfile.PIDFMedicalId = m.PIDFMedicalId where(PIDFId = @PIDFID)      
	 union all                                
	 select MarketDetailsFileName as FileName from PIDF_API_IPD as ai join PIDF    on ai.PIDFID =PIDF.PIDFID   where(ai.PIDFID=@PIDFID)      
 
	 SELECT DISTINCT ps.Strength, mu.UnitofMeasurementName FROM PIDFProductStrength ps join Master_UnitofMeasurement mu on ps.UnitofMeasurementId=mu.UnitofMeasurementId      
	 WHERE (PIDFID=@PIDFID)  
 
	 SELECT BusinessUnitName, BusinessUnitId from Master_BusinessUnit where IsActive=1      
 
     DECLARE @dd DATE, @range INT = 0;
	 SELECT @dd = CAST(GETDATE() AS DATE);
	 SELECT @range = CASE @FilterId WHEN 1 THEN -1 WHEN 2 THEN -3 WHEN 3 THEN -6 WHEN 4 THEN -12 END; 
	 
    
     ;WITH TaskHierarchy AS 
	 (    
		SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.PlannedStartDate, pt.PlannedEndDate, pt.TaskLevel, 
			pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate, pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, 
			pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName, mu.FullName, 0 AS HierarchyLevel, 
			CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
		FROM ProjectTask pt    
		JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
		JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
		JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
		WHERE (PIDFID = @PIDFID) AND DATEPART(YEAR, ISNULL(pt.ModifyDate, pt.CreatedDate)) = DATEPART(YEAR, GETDATE())    
			AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
		UNION ALL    
    
		SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.PlannedStartDate, pt.PlannedEndDate, pt.TaskLevel, 
			pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate, pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, 
			pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName, mu.FullName, 0 AS HierarchyLevel,    
			CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
		FROM ProjectTask pt    
		JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
		JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
		JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
		JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
	)    

	SELECT ProjectTaskId, TaskName, StartDate, PlannedStartDate, EndDate, PlannedEndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
		   TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
	FROM TaskHierarchy    
	ORDER BY TaskPath;    
    
    
	/*
		if(@FilterId=0)      
		 BEGIN      
		 --SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,      
		 --pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,      
		 --pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,      
		 --mps.StatusName,      
		 --mu.FullName FROM ProjectTask pt      
      
		 --join Master_User mu ON pt.TaskOwnerId = mu.UserId       
		 --join Master_Project_Status mps ON pt.StatusId = mps.StatusId       
		 --join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId      
		 --WHERE (PIDFID=@PIDFID)       
    
		 WITH TaskHierarchy AS (    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			WHERE (PIDFID = @PIDFID) AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
			UNION ALL    
    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
		)    
		SELECT ProjectTaskId, TaskName, StartDate, EndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
		TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
		FROM TaskHierarchy    
		ORDER BY TaskPath;    
    
    
		 --and pt.ModifiedDate= case when @FilterId=1 then   cast(pt.ModifiedDate as date) between DATEADD(month,-1, GETDATE()) and cast(GETDATE() as date)       
		 --                          when @FilterId=2 then   cast(pt.ModifiedDate as date) between DATEADD(month,-3, GETDATE()) and cast(GETDATE() as date)      
		 --                          when @FilterId=3 then   cast(pt.ModifiedDate as date) between DATEADD(month,-6, GETDATE()) and cast(GETDATE() as date)       
		 --          when @FilterId=4 then   DATEPART(year, pt.ModifiedDate) =  DATEPART(year, GETDATE()) else null END      
		 END      
		 ELSE IF(@FilterId=1)      
		 BEGIN      
		 --SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,      
		 --pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,      
		 --pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,      
		 --mps.StatusName,      
		 --mu.FullName FROM ProjectTask pt      
      
		 --join Master_User mu ON pt.TaskOwnerId = mu.UserId       
		 --join Master_Project_Status mps ON pt.StatusId = mps.StatusId       
		 --join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId      
		 --WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-1, GETDATE()) and cast(GETDATE() as date)      
   
   
		  WITH TaskHierarchy AS (    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			WHERE (PIDFID=@PIDFID) 
			and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-1, GETDATE()) and cast(GETDATE() as date)      
			AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
			UNION ALL    
    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
		)    
		SELECT ProjectTaskId, TaskName, StartDate, EndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
		TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
		FROM TaskHierarchy    
		ORDER BY TaskPath;    
   
   
		 END       
		 ELSE IF(@FilterId=2)      
		 BEGIN      
		 --SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,      
		 --pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,      
		 --pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,      
		 --mps.StatusName,      
		 --mu.FullName FROM ProjectTask pt      
      
		 --join Master_User mu ON pt.TaskOwnerId = mu.UserId       
		 --join Master_Project_Status mps ON pt.StatusId = mps.StatusId       
		 --join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId      
		 --WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-3, GETDATE()) and cast(GETDATE() as date)      
  
   
		  WITH TaskHierarchy AS (    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			WHERE (PIDFID=@PIDFID) 
			and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-3, GETDATE()) and cast(GETDATE() as date)      
			AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
			UNION ALL    
    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
		)    
		SELECT ProjectTaskId, TaskName, StartDate, EndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
		TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
		FROM TaskHierarchy    
		ORDER BY TaskPath;    
		 END       
		 ELSE IF(@FilterId=3)      
		 BEGIN      
		 --SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,      
		 --pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,      
		 --pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,      
		 --mps.StatusName,      
		 --mu.FullName FROM ProjectTask pt      
      
		 --join Master_User mu ON pt.TaskOwnerId = mu.UserId       
		 --join Master_Project_Status mps ON pt.StatusId = mps.StatusId       
		 --join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId      
		 --WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-6, GETDATE()) and cast(GETDATE() as date)    
   
		  WITH TaskHierarchy AS 
		  (    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			WHERE (PIDFID=@PIDFID) 
			and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-6, GETDATE()) and cast(GETDATE() as date)     
			  AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
			UNION ALL    
    
			SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.TaskLevel, pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate,    
				pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName,    
				mu.FullName, 0 AS HierarchyLevel,    
				CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
			FROM ProjectTask pt    
			JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
			JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
			JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
			JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
		 )    
		 SELECT ProjectTaskId, TaskName, StartDate, EndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
		 TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
		 FROM TaskHierarchy    
		 ORDER BY TaskPath;    
  
		 END       
		 ELSE IF(@FilterId=4)      
		 BEGIN      
			 --SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,      
			 --pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,      
			 --pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,      
			 --mps.StatusName,      
			 --mu.FullName FROM ProjectTask pt      
      
			 --join Master_User mu ON pt.TaskOwnerId = mu.UserId       
			 --join Master_Project_Status mps ON pt.StatusId = mps.StatusId       
			 --join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId      
			 --WHERE (PIDFID=@PIDFID) and DATEPART(year, Isnull(pt.ModifyDate,pt.CreatedDate)) =  DATEPART(year, GETDATE())      
    
			 WITH TaskHierarchy AS 
			 (    
				SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.PlannedStartDate, pt.PlannedEndDate, pt.TaskLevel, 
					pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate, pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, 
					pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName, mu.FullName, 0 AS HierarchyLevel, 
					CAST(pt.ProjectTaskId AS VARCHAR(MAX)) AS TaskPath    
				FROM ProjectTask pt    
				JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
				JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
				JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
				WHERE (PIDFID = @PIDFID) AND DATEPART(YEAR, ISNULL(pt.ModifyDate, pt.CreatedDate)) = DATEPART(YEAR, GETDATE())    
					AND (pt.ParentId  = 0 or pt.ParentId IS NULL)    
    
				UNION ALL    
    
				SELECT pt.ProjectTaskId, pt.TaskName,pt.StartDate, pt.EndDate, pt.PlannedStartDate, pt.PlannedEndDate, pt.TaskLevel, 
					pt.TaskDuration, pt.TotalPercentage, pt.CreatedDate, pt.TaskOwnerId, pt.ParentId, pt.ModifyBy, 
					pt.ModifyDate, pt.PriorityId, pp.PriorityName, mps.StatusName, mu.FullName, 0 AS HierarchyLevel,    
					CONCAT(th.TaskPath, '.', pt.ProjectTaskId) AS TaskPath    
				FROM ProjectTask pt    
				JOIN Master_User mu ON pt.TaskOwnerId = mu.UserId    
				JOIN Master_Project_Status mps ON pt.StatusId = mps.StatusId    
				JOIN Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId    
				JOIN TaskHierarchy th ON pt.ParentId = th.ProjectTaskId    
			)    

			SELECT ProjectTaskId, TaskName, StartDate, EndDate, TaskLevel, TaskDuration, TotalPercentage, CreatedDate,    
			TaskOwnerId, ParentId, ModifyBy, ModifyDate, PriorityId, PriorityName, StatusName, FullName, HierarchyLevel, TaskPath    
			FROM TaskHierarchy    
			ORDER BY TaskPath;    
	*/ 
END 
GO
/****** Object:  StoredProcedure [dbo].[GetTaskSubTaskFileProject-SwapBackup]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- Author:  <Author,,Name>  
-- Create date: <Create Date,,>  
-- Description: <Description,,>  
-- =============================================  
CREATE PROCEDURE [dbo].[GetTaskSubTaskFileProject-SwapBackup] --1,4  
 @PIDFID INT,  
 @FilterId INT=0--0 all,1 monthly,2 quatrely,3 half yearly,4 Annually  
 AS   
 BEGIN  
 SELECT top 1 MoleculeName AS ProjectName,mpt.ProductTypeName AS ProductType,mp.PlantNameName AS PlantName,'Formulation' AS Formulation  
 ,wf.WorkflowName as WorkFlow FROM PIDF as p  
 left join PIDF_PBF as Pb on p.PIDFID=pb.PIDFId   
 left join Master_ProductType mpt on pb.PackagingTypeId=mpt.ProductTypeId  
 left join Master_Workflow wf     on pb.WorkflowId=wf.WorkflowId  
 left join Master_Plant      mp   on pb.PlantId=mp.PlantId  
 WHERE (p.PIDFID=@PIDFID )   
    
  
 SELECT FileName FROM PIDF_Medical_File mfile join PIDF_Medical m on mfile.PIDFMedicalId = m.PIDFMedicalId where(PIDFId = @PIDFID)  
 union all                            
 select MarketDetailsFileName as FileName from PIDF_API_IPD as ai join PIDF    on ai.PIDFID =PIDF.PIDFID   where(ai.PIDFID=@PIDFID)  
 SELECT ps.Strength, mu.UnitofMeasurementName FROM PIDFProductStrength ps join Master_UnitofMeasurement mu on ps.UnitofMeasurementId=mu.UnitofMeasurementId  
 WHERE (PIDFID=@PIDFID)  
 SELECT BusinessUnitName, BusinessUnitId from Master_BusinessUnit where IsActive=1  
 if(@FilterId=0)  
 BEGIN  
 SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,  
 pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,  
 pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,  
 mps.StatusName,  
 mu.FullName FROM ProjectTask pt  
  
 join Master_User mu ON pt.TaskOwnerId = mu.UserId   
 join Master_Project_Status mps ON pt.StatusId = mps.StatusId   
 join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId  
 WHERE (PIDFID=@PIDFID)   
 --and pt.ModifiedDate= case when @FilterId=1 then   cast(pt.ModifiedDate as date) between DATEADD(month,-1, GETDATE()) and cast(GETDATE() as date)   
 --                          when @FilterId=2 then   cast(pt.ModifiedDate as date) between DATEADD(month,-3, GETDATE()) and cast(GETDATE() as date)  
 --                          when @FilterId=3 then   cast(pt.ModifiedDate as date) between DATEADD(month,-6, GETDATE()) and cast(GETDATE() as date)   
 --          when @FilterId=4 then   DATEPART(year, pt.ModifiedDate) =  DATEPART(year, GETDATE()) else null END  
 END  
 ELSE IF(@FilterId=1)  
 BEGIN  
 SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,  
 pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,  
 pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,  
 mps.StatusName,  
 mu.FullName FROM ProjectTask pt  
  
 join Master_User mu ON pt.TaskOwnerId = mu.UserId   
 join Master_Project_Status mps ON pt.StatusId = mps.StatusId   
 join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId  
 WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-1, GETDATE()) and cast(GETDATE() as date)  
 END   
 ELSE IF(@FilterId=2)  
 BEGIN  
 SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,  
 pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,  
 pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,  
 mps.StatusName,  
 mu.FullName FROM ProjectTask pt  
  
 join Master_User mu ON pt.TaskOwnerId = mu.UserId   
 join Master_Project_Status mps ON pt.StatusId = mps.StatusId   
 join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId  
 WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-3, GETDATE()) and cast(GETDATE() as date)  
 END   
 ELSE IF(@FilterId=3)  
 BEGIN  
 SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,  
 pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,  
 pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,  
 mps.StatusName,  
 mu.FullName FROM ProjectTask pt  
  
 join Master_User mu ON pt.TaskOwnerId = mu.UserId   
 join Master_Project_Status mps ON pt.StatusId = mps.StatusId   
 join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId  
 WHERE (PIDFID=@PIDFID) and cast(Isnull(pt.ModifyDate,pt.CreatedDate) as date) between DATEADD(month,-6, GETDATE()) and cast(GETDATE() as date)  
 END   
 ELSE IF(@FilterId=4)  
 BEGIN  
 SELECT pt.ProjectTaskId,pt.TaskName,pt.StartDate,pt.EndDate,pt.TaskLevel,  
 pt.TaskDuration,pt.TotalPercentage,pt.CreatedDate,pt.TaskOwnerId,  
 pt.ParentId,pt.ModifyBy,pt.ModifyDate,pt.PriorityId,pp.PriorityName,  
 mps.StatusName,  
 mu.FullName FROM ProjectTask pt  
  
 join Master_User mu ON pt.TaskOwnerId = mu.UserId   
 join Master_Project_Status mps ON pt.StatusId = mps.StatusId   
 join Master_Project_Priority pp ON pt.PriorityId = pp.PriorityId  
 WHERE (PIDFID=@PIDFID) and DATEPART(year, Isnull(pt.ModifyDate,pt.CreatedDate)) =  DATEPART(year, GETDATE())  
 END  
END  
GO
/****** Object:  StoredProcedure [dbo].[GetUserForReminder]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 --  exec GetUserForReminder                
CREATE PROCEDURE [dbo].[GetUserForReminder]                   
AS                  
BEGIN                  
                
select DISTINCT p.PIDFNO,p.MoleculeName,p.StatusUpdatedDate As IPDApprovedDate ,u.FullName,u.EmailAddress, B.StatusId          
from  PIDF p              
Inner Join PIDFStatusHistory As B On P.PIDFID = B.PIDFID And B.StatusId = 7                   
inner join Master_UserBusinessUnitMapping UserBUMap on UserBUMap.BusinessUnitId = p.BusinessUnitId                
Right join Master_User u on u.UserId = UserBUMap.UserId                   
where  dateadd(DD, 90, p.StatusUpdatedDate) > getdate()              
And p.PIDFId NOT IN (Select PIDFId from PIDFStatusHistory Where StatusId In (11,18))            
--and   p.StatusId = 7 --[IPD Approved = 7]                
--and   p.IsActive =1                
and u.UserId in (                
select u.UserId from Master_User u                 
inner join RoleModulePermission rolepermission on rolepermission.RoleId = u.RoleId                
where rolepermission.ModuleId = 15 --[15 = Commercial Management]                
and (rolepermission.[Edit] =1 or  rolepermission.[Add] =1)                
)            
and u.IsActive = 1 And u.IsDeleted = 0             
And p.StatusId NOt IN (4, 8)          
--and UserBUMap.BusinessUnitId not in (select BusinessUnitId from PIDF_Commercial_Master where Interested = 0)        
order by IPDApprovedDate ASC                
                
      
-------------- details for PIDF Submitted scheduler-------------------------------      
--------Table1      
select PIDFNO,PIDFID,MoleculeName,BrandName,BU.BusinessUnitName,dos.DosageFormName from PIDF P       
inner join Master_BusinessUnit BU on BU.BusinessUnitId=P.BusinessUnitId      
inner join Master_DosageForm dos on dos.DosageFormId = P.DosageFormId      
where StatusId =2      
      
--------Table2      
select DISTINCT PIDFID,Strength from PIDFProductStrength where PIDFID in (select PIDFID from PIDF where StatusId =2)      
      
--------Table3      
select PIDFID,IMSValue,IMSVolume from PIDFIMSData where PIDFID in (select PIDFID from PIDF where StatusId =2)      
      
--------Table4      
Select top 2 UserId,FullName,EmailAddress from Master_User u                         
where  u.UserId in (                
select u.UserId from Master_User u                 
inner join RoleModulePermission rolepermission on rolepermission.RoleId = u.RoleId                
where rolepermission.ModuleId = 5 --[5 = PIDF -Project Identification Form]                
and (rolepermission.[Edit] =1)                
)          
-----------------------------------------------      
END 
GO
/****** Object:  StoredProcedure [dbo].[GetWishList]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec GetWishList  @PageSize = 10, @CurrentPageNumber = 0 ,@typeId=1
CREATE Proc [dbo].[GetWishList]
(          
@typeId int=0,          
@CurrentPageNumber INT = 0,                      
@PageSize INT = 25,                      
@SortColumn VARCHAR(100) = 'CreatedOn',                      
@SortDirection VARCHAR(5) = 'DESC',                      
@SearchText VARCHAR(MAX) =''          
)                  
AS                    
BEGIN              
          
SET NOCOUNT ON; 
Set @SearchText = IsNull(@SearchText, '')  
Select * from (          
SELECT Count(WishListId) OVER() TotalCount, * , ROW_NUMBER() OVER           
(    
ORDER BY           
CASE                    
WHEN @SortDirection <> 'DESC' THEN 0                    
WHEN @SortColumn = 'WishListId' THEN  WishListId                     
END DESC                     
,CASE                    
WHEN @SortDirection <> 'ASC' THEN 0                    
WHEN @SortColumn = 'WishListId' THEN WishListId          
END ASC           
, CASE                    
WHEN @SortDirection <> 'DESC' THEN null                    
WHEN @SortColumn = 'CreatedOn' THEN CreatedOn                
END DESC                     
,CASE                    
WHEN @SortDirection <> 'ASC' THEN null                    
WHEN @SortColumn = 'CreatedOn' THEN CreatedOn                    
END ASC
,
CASE                    
WHEN @SortDirection <> 'DESC' THEN null                    
WHEN @SortColumn = 'MoleculeName' THEN MoleculeName                
END DESC                     
,CASE                    
WHEN @SortDirection <> 'ASC' THEN null                    
WHEN @SortColumn = 'WishListTyp' THEN WishListTyp                    
END ASC
,
CASE                    
WHEN @SortDirection <> 'ASC' THEN null                    
WHEN @SortColumn = 'WishListTyp' THEN WishListTyp                    
END ASC
)           
RowNumber from (          
SELECT  COUNT(u.WishListId) OVER() TotalRecord,WishListId,U.WishListTypeId,WT.WishListTyp,GeographyId,MBU.BusinessUnitName as Geography,MC.CountryName,u.CountryId,
MoleculeName,Strength,IsInhouseOrInLicensed,DateOfFiling,DateOfApproval,NameofVendor,
VendorEvaluationRemark,ReferenceDrugProduct,Remarks,U.CreatedOn,U.UpdatedOn,U.DeletedOn,u.IsActive,u.CreatedBy         
FROM Tbl_WishList As U   
LEFT join Master_Country as MC on MC.CountryID = U.CountryId          
LEFT join Master_User as us on us.UserId = u.CreatedBy       
LEFT Join Master_BusinessUnit As MBU On MBU.BusinessUnitId = U.GeographyId 
INNER JOIN Master_WishListType WT on WT.WishListTypeId=U.WishListTypeId
)  
AS B WHERE             
(MoleculeName LIKE '%' + @SearchText + '%') or (WishListTyp LIKE '%' + @SearchText + '%') or (Strength LIKE '%' + @SearchText + '%') 
or (NameofVendor LIKE '%' + @SearchText + '%') or (CountryName LIKE '%' + @SearchText + '%') or (Geography LIKE '%' + @SearchText + '%') ) As C          
Where  (WishListTypeId=@typeId or @typeId=0) and 
RowNumber BETWEEN (@CurrentPageNumber) + 1 AND (@CurrentPageNumber) + @PageSize          
          
SET NOCOUNT OFF; 
end
GO
/****** Object:  StoredProcedure [dbo].[GetWishListByTypeId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[GetWishListByTypeId](
@WishListTypeId int=0
)
as
begin
SELECT WishListId
      ,WishListTypeId
      ,GeographyId
      ,CountryId
      ,MoleculeName
      ,Strength
      ,IsInhouseOrInLicensed
      ,DateOfFiling
      ,DateOfApproval
      ,NameofVendor
      ,VendorEvaluationRemark
      ,ReferenceDrugProduct
      ,Remarks
      ,CreatedOn
      ,UpdatedOn
      ,DeletedOn
      ,IsActive
      ,CreatedBy
  FROM Tbl_WishList
  where WishListTypeId=@WishListTypeId and IsActive=1
  end
GO
/****** Object:  StoredProcedure [dbo].[Proc_GetCountyForBussinessUnitAndPIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--[dbo].[Proc_GetCountyForBussinessUnitAndPIDF] 128,5
CREATE PROC [dbo].[Proc_GetCountyForBussinessUnitAndPIDF]
@PIDFId bigint,
@BussinessUnitId bigint
AS
BEGIN
 select * from  dbo.GetCountryForBusinessUnitAndPIDF(@PIDFId, @BussinessUnitId)
END
GO
/****** Object:  StoredProcedure [dbo].[ProcAddUpdatePidfFinance]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
CREATE PROC [dbo].[ProcAddUpdatePidfFinance] (  
 @PIDFId INT  
 ,@Entity NVARCHAR(70)  
 ,@Product NVARCHAR(70)  
 ,@ForecastDate DATETIME = NULL  
 ,@Currencyid NVARCHAR(70)  
 ,@DosageFrom INT  
 ,@ManufacturingSiteOrPartner NVARCHAR(70)  
 ,@SKUs NVARCHAR(70)  
 ,@MSPersentage INT  
 ,@TargetPriceScenario INT  
 ,@ProjectStartDate DATETIME = NULL  
 ,@BatchManufacturing NVARCHAR(70)  
 ,@ExpectedFilling NVARCHAR(70)  
 ,@ApprovalPeriodinDays NVARCHAR(70)  
 ,@ApprovalDate DATETIME = NULL  
 ,@ProductLaunchDate DATETIME = NULL  
 ,@GestationPeriodinYears float  
 ,@MarketShareErosionrate NUMERIC(18, 2)  
 ,@PriceErosion NUMERIC(18, 2)  
 ,@EscalationinCOGS NVARCHAR(70)  
 ,@DiscountRate NUMERIC(18, 2)  
 ,@Incometaxrate NUMERIC(18, 2)  
 ,@Opexasapercenttosale float  
 ,@ExternalProfitSharepercent float  
 ,@CollectioninDays float  
 ,@InventoryinDays float  
 ,@CreditorinDays float  
 ,@MarketingAllowance NUMERIC(18, 2)  
 ,@RegulatoryMaintenanceCost NUMERIC(18, 2)  
 ,@GrosstoNet NUMERIC(18, 2)  
 ,@Noofbatchestobemanufactured float  
 ,@NoofbatchestobemanufacturedPhaseEndDate DATETIME = NULL  
 ,@NoSKUs float  
 ,@NoSKUsPhaseEndDate DATETIME = NULL  
 ,@RandDAnalyticalcost INT  
 ,@RandDAnalyticalcostPhaseEndDate DATETIME = NULL  
 ,@RLDsamplecost INT  
 ,@RLDsamplecostPhaseEndDate DATETIME = NULL  
 ,@BatchmanufacturingcostOrAPIActualsEst INT  
 ,@BatchmanufacturingcostOrAPIActualsEstPhaseEndDate DATETIME = NULL  
 ,@Sixmonthsstabilitycost INT  
 ,@SixmonthsstabilitycostPhaseEndDate DATETIME = NULL  
 ,@TechTransfer INT  
 ,@TechTransferPhaseEndDate DATETIME = NULL  
 ,@BEstudies INT  
 ,@BEstudiesPhaseEndDate DATETIME = NULL  
 ,@Filingfees INT  
 ,@FilingfeesPhaseEndDate DATETIME = NULL  
 ,@BioStuddyCost INT  
 ,@BioStuddyCostPhaseEndDate DATETIME = NULL  
 ,@Capex INT  
 ,@CapexPhaseEndDate DATETIME = NULL  
 ,@ToolingAndChangeParts INT  
 ,@ToolingAndChangePartsPhaseEndDate DATETIME = NULL  
 ,@Total NUMERIC(18, 2)  
 ,@CreatedBy INT  
 ,@Success NVARCHAR(12) = NULL OUTPUT  
 )  
AS  
BEGIN  
 BEGIN TRAN  
  
 BEGIN TRY  
  IF (  
    NOT EXISTS (  
     SELECT *  
     FROM PIDF_Finance  
     WHERE PIDFId = @PIDFId  
     )  
    )  
  BEGIN  
   INSERT INTO PIDF_Finance (  
    PIDFId  
    ,Entity  
    ,Product  
    ,ForecastDate  
    ,Currencyid  
    ,DosageFrom  
    ,ManufacturingSiteOrPartner  
    ,SKUs  
    ,MSPersentage  
    ,TargetPriceScenario  
    ,ProjectStartDate  
    ,BatchManufacturing  
    ,ExpectedFilling  
    ,ApprovalPeriodinDays  
    ,ApprovalDate  
    ,ProductLaunchDate  
    ,GestationPeriodinYears  
    ,MarketShareErosionrate  
    ,PriceErosion  
    ,EscalationinCOGS  
    ,DiscountRate  
    ,Incometaxrate  
    ,Opexasapercenttosale  
    ,ExternalProfitSharepercent  
    ,CollectioninDays  
    ,InventoryinDays  
    ,CreditorinDays  
    ,MarketingAllowance  
    ,RegulatoryMaintenanceCost  
    ,GrosstoNet  
    ,Noofbatchestobemanufactured  
    ,NoofbatchestobemanufacturedPhaseEndDate  
    ,NoSKUs  
    ,NoSKUsPhaseEndDate  
    ,RandDAnalyticalcost  
    ,RandDAnalyticalcostPhaseEndDate  
    ,RLDsamplecost  
    ,RLDsamplecostPhaseEndDate  
    ,BatchmanufacturingcostOrAPIActualsEst  
    ,BatchmanufacturingcostOrAPIActualsEstPhaseEndDate  
    ,Sixmonthsstabilitycost  
    ,SixmonthsstabilitycostPhaseEndDate  
    ,TechTransfer  
    ,TechTransferPhaseEndDate  
    ,BEstudies  
    ,BEstudiesPhaseEndDate  
    ,Filingfees  
    ,FilingfeesPhaseEndDate  
    ,BioStuddyCost  
    ,BioStuddyCostPhaseEndDate  
    ,Capex  
    ,CapexPhaseEndDate  
    ,ToolingAndChangeParts  
    ,ToolingAndChangePartsPhaseEndDate  
    ,Total  
    ,CreatedBy  
    )  
   VALUES (  
    @PIDFId  
    ,@Entity  
    ,@Product  
    ,@ForecastDate  
    ,@Currencyid  
    ,@DosageFrom  
    ,@ManufacturingSiteOrPartner  
    ,@SKUs  
    ,@MSPersentage  
    ,@TargetPriceScenario  
    ,@ProjectStartDate  
    ,@BatchManufacturing  
    ,@ExpectedFilling  
    ,@ApprovalPeriodinDays  
    ,@ApprovalDate  
    ,@ProductLaunchDate  
    ,@GestationPeriodinYears  
    ,@MarketShareErosionrate  
    ,@PriceErosion  
    ,@EscalationinCOGS  
    ,@DiscountRate  
    ,@Incometaxrate  
    ,@Opexasapercenttosale  
    ,@ExternalProfitSharepercent  
    ,@CollectioninDays  
    ,@InventoryinDays  
    ,@CreditorinDays  
    ,@MarketingAllowance  
    ,@RegulatoryMaintenanceCost  
    ,@GrosstoNet  
    ,@Noofbatchestobemanufactured  
    ,@NoofbatchestobemanufacturedPhaseEndDate  
    ,@NoSKUs  
    ,@NoSKUsPhaseEndDate  
    ,@RandDAnalyticalcost  
    ,@RandDAnalyticalcostPhaseEndDate  
    ,@RLDsamplecost  
    ,@RLDsamplecostPhaseEndDate  
    ,@BatchmanufacturingcostOrAPIActualsEst  
    ,@BatchmanufacturingcostOrAPIActualsEstPhaseEndDate  
    ,@Sixmonthsstabilitycost  
    ,@SixmonthsstabilitycostPhaseEndDate  
    ,@TechTransfer  
    ,@TechTransferPhaseEndDate  
    ,@BEstudies  
    ,@BEstudiesPhaseEndDate  
    ,@Filingfees  
    ,@FilingfeesPhaseEndDate  
    ,@BioStuddyCost  
    ,@BioStuddyCostPhaseEndDate  
    ,@Capex  
    ,@CapexPhaseEndDate  
    ,@ToolingAndChangeParts  
    ,@ToolingAndChangePartsPhaseEndDate  
    ,@Total  
    ,@CreatedBy  
    )  
  
   SELECT @Success = 'success-' + Convert(NVARCHAR, (  
      SELECT TOP 1 PIDFFinaceId  
      FROM PIDF_Finance  
      WHERE PIDFId = @PIDFId  
      ORDER BY PIDFFinaceId DESC  
      ));  
  END  
  ELSE IF (  
    EXISTS (  
     SELECT *  
     FROM PIDF_Finance  
     WHERE PIDFId = @PIDFId  
     )  
    )  
  BEGIN  
   UPDATE PIDF_Finance  
   SET Entity = @Entity  
    ,Product = @Product  
    ,ForecastDate = @ForecastDate  
    ,Currencyid = @Currencyid  
    ,DosageFrom = @DosageFrom  
    ,ManufacturingSiteOrPartner = @ManufacturingSiteOrPartner  
    ,SKUs = @SKUs  
    ,MSPersentage = @MSPersentage  
    ,TargetPriceScenario = @TargetPriceScenario  
    ,ProjectStartDate = @ProjectStartDate  
    ,BatchManufacturing = @BatchManufacturing  
    ,ExpectedFilling = @ExpectedFilling  
    ,ApprovalPeriodinDays = @ApprovalPeriodinDays  
    ,ApprovalDate = @ApprovalDate  
    ,ProductLaunchDate = @ProductLaunchDate  
    ,GestationPeriodinYears = @GestationPeriodinYears  
    ,MarketShareErosionrate = @MarketShareErosionrate  
    ,PriceErosion = @PriceErosion  
    ,EscalationinCOGS = @EscalationinCOGS  
    ,DiscountRate = @DiscountRate  
    ,Incometaxrate = @Incometaxrate  
    ,Opexasapercenttosale = @Opexasapercenttosale  
    ,ExternalProfitSharepercent = @ExternalProfitSharepercent  
    ,CollectioninDays = @CollectioninDays  
    ,InventoryinDays = @InventoryinDays  
    ,CreditorinDays = @CreditorinDays  
    ,MarketingAllowance = @MarketingAllowance  
    ,RegulatoryMaintenanceCost = @RegulatoryMaintenanceCost  
    ,GrosstoNet = @GrosstoNet  
    ,Noofbatchestobemanufactured = @Noofbatchestobemanufactured  
    ,NoofbatchestobemanufacturedPhaseEndDate = @NoofbatchestobemanufacturedPhaseEndDate  
    ,NoSKUs = @NoSKUs  
    ,NoSKUsPhaseEndDate = @NoSKUsPhaseEndDate  
    ,RandDAnalyticalcost = @RandDAnalyticalcost  
    ,RandDAnalyticalcostPhaseEndDate = @RandDAnalyticalcostPhaseEndDate  
    ,RLDsamplecost = @RLDsamplecost  
    ,RLDsamplecostPhaseEndDate = @RLDsamplecostPhaseEndDate  
    ,BatchmanufacturingcostOrAPIActualsEst = @BatchmanufacturingcostOrAPIActualsEst  
    ,BatchmanufacturingcostOrAPIActualsEstPhaseEndDate = @BatchmanufacturingcostOrAPIActualsEstPhaseEndDate  
    ,Sixmonthsstabilitycost = @Sixmonthsstabilitycost  
    ,SixmonthsstabilitycostPhaseEndDate = @SixmonthsstabilitycostPhaseEndDate  
    ,TechTransfer = @TechTransfer  
    ,TechTransferPhaseEndDate = @TechTransferPhaseEndDate  
    ,BEstudies = @BEstudies  
    ,BEstudiesPhaseEndDate = @BEstudiesPhaseEndDate  
    ,Filingfees = @Filingfees  
    ,FilingfeesPhaseEndDate = @FilingfeesPhaseEndDate  
    ,BioStuddyCost = @BioStuddyCost  
    ,BioStuddyCostPhaseEndDate = @BioStuddyCostPhaseEndDate  
    ,Capex = @Capex  
    ,CapexPhaseEndDate = @CapexPhaseEndDate  
    ,ToolingAndChangeParts = @ToolingAndChangeParts  
    ,ToolingAndChangePartsPhaseEndDate = @ToolingAndChangePartsPhaseEndDate  
    ,Total = @Total  
    ,ModifyDate = Getdate()  
    ,CreatedBy = @CreatedBy  
   WHERE PIDFId = @PIDFId  
     SELECT @Success = 'success-' + Convert(NVARCHAR, (  
      SELECT TOP 1 PIDFFinaceId  
      FROM PIDF_Finance  
      WHERE PIDFId = @PIDFId  
      ORDER BY PIDFFinaceId DESC  
      ));  
  END  
  
  COMMIT TRAN  
 END TRY  
  
 BEGIN CATCH  
  ROLLBACK TRAN  
 END CATCH  
END  
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasks]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
   
       
-- DELETE T FROM ProjectTask t WHERE t.PIDFId = 366; EXEC [dbo].[ProcAddWorkflowTasks]   366,1        
CREATE PROCEDURE [dbo].[ProcAddWorkflowTasks] -- 366,1              
(                
    @PIDFID INT,                
   -- @BusinessUnit INT = NULL,                
    @UserId INT = 1                
)                
AS                
BEGIN                
    SET NOCOUNT ON;          
           
                
    DECLARE @ApprovalCount INT, @ApprovedCount INT                
    DECLARE @ApiOrderedDate DATETIME                
    DECLARE @ApiReceivedDate DATETIME                
    DECLARE @BUId INT            
                
 SELECT @ApprovalCount = COUNT(UserId)                
    FROM Master_User                
    WHERE IsActive = 1 AND IsDeleted = 0 AND IsManagement = 1                
                
    SELECT @ApprovedCount = COUNT(*)                
    FROM PIDF_ManagementApprovalStatusHistory                
    WHERE PIDFId = @PIDFID AND StatusId = 20                
                
               
   IF (@ApprovalCount = @ApprovedCount)                
    BEGIN                
        DECLARE @WorkflowId INT = (                
            SELECT TOP 1 WorkFlowId                
            FROM PIDF_PBF                
            WHERE PIDFId = @PIDFId                
        )                
                
        IF ISNULL(@WorkflowId, 0) = 0                
        BEGIN                
            SET @WorkflowId = (                
                SELECT TOP 1 ProjectWorkflowId                
                FROM PIDF_PBF_Outsource                
                WHERE PIDFId = @PIDFId                
            )                
        END                
                
        SET @WorkflowId = 1                
                
        DECLARE @TaskOwnerId INT = (                
            SELECT TOP 1 FormulationGLId                
            FROM PIDF_PBF_General                
            WHERE PIDFPBFId = @PIDFId --AND (@BusinessUnit IS NULL OR BusinessUnitId = @BusinessUnit)              
        )                
                
        IF ISNULL(@TaskOwnerId, 0) = 0                
        BEGIN                
            SET @TaskOwnerId = (                
                SELECT TOP 1 UserId                
                FROM [Master_User]                
                WHERE IsActive = 1 AND IsDeleted = 0 AND (FormulationGL = 1 OR AnalyticalGL = 1)                
            )                
        END                
      
  SELECT top 1 @ApiOrderedDate = ISNULL(ApiOrderedDate, GETDATE()), @ApiReceivedDate = ISNULL(ApiReceivedDate, GETDATE())          
        FROM PIDF_PBF_General_Rnd          
        WHERE PidfId = @PIDFId        
          
        SELECT @ApiOrderedDate = ISNULL(@ApiOrderedDate, GETDATE()), @ApiReceivedDate = ISNULL(@ApiReceivedDate, GETDATE())          
          
                
        SELECT *  into #Countries            
        FROM dbo.GetCountryForBusinessUnitAndPIDF(@PIDFID, NULL)                
                
        IF NOT EXISTS (SELECT 1 FROM ProjectTask pt WHERE pt.PIDFId = @PIDFID AND ParentId = 0)                
        BEGIN                
            INSERT INTO ProjectTask (                
                PIDFId, TaskName, TaskOwnerId, TaskLevel, StartDate, EndDate, PriorityId, StatusId,                
                TaskDuration, TotalPercentage, CreatedDate, CreatedBy, ParentId, PlannedStartDate,                
                PlannedEndDate                
            )                
            SELECT                
                @PIDFID,                
                mwt.taskname AS TaskName,                
                @TaskOwnerId,                
                mwt.TaskLevel,                
                GETDATE(),                
                GETDATE() + 30,                
                1,                
                1,                
                DATEDIFF(DAY, GETDATE(), GETDATE() + 30) AS TaskDuration,                
                0,                
                GETDATE(),                
                @UserId,                
                mwt.ParentId,                
                GETDATE(),                
               GETDATE() + 30                
            FROM Master_WorkFlow_Tasks mwt                
            WHERE mwt.ParentId = 0              
                  
   UNION ALL          
          
 SELECT          
                @PIDFID,          
                mwt.taskname AS TaskName,          
                @TaskOwnerId,          
                mwt.TaskLevel,          
                DATEADD(DAY, MWT.StartDateOffset, @ApiReceivedDate),          
                DATEADD(DAY, MWT.EndDateOffset, @ApiReceivedDate),          
                1,          
                1,          
                DATEDIFF(          
                    DAY,          
                    DATEADD(DAY, MWT.StartDateOffset, @ApiReceivedDate),          
                    DATEADD(DAY, MWT.EndDateOffset, @ApiReceivedDate)          
                ) AS TaskDuration,          
                0,          
                GETDATE(),          
                @UserId,          
                mwt.ParentId,          
                GETDATE(),          
                GETDATE() + 30          
            FROM Master_WorkFlow_Tasks mwt          
            WHERE mwt.country = 0 AND mwt.WorkflowID = @WorkflowId AND mwt.ParentId = 1          
          
               
             
   DECLARE @tbl TABLE (CountyId INT, PIDFID INT, LastDataFromRnD DATETIME, LastDateToRegulatory DATETIME, DossierReadyDate DATETIME, EarliestSubmissionDate DATETIME,          
    EndOfProcedureDate DATETIME, CountryApprovalDate DATETIME, EarliestLaunchDate DATETIME)          
          
     DECLARE @BUId1 INT, @CountryID INT, @tos INT, @ldRnD DATETIME           
          
     DECLARE cur CURSOR FOR               
     SELECT b.CountryIdBuId, b.BuId, b.TypeOfSubmissionId, b.LastDataFromRnD          
     FROM [dbo].[PIDF_PBF_RA] b WHERE b.PIDFId = @PIDFID           
     ORDER BY b.PIDFPBFRAId;             
     OPEN cur               
     FETCH NEXT FROM cur  INTO @CountryID, @BUId1, @tos, @ldRnD          
              
     WHILE @@FETCH_STATUS = 0              
     BEGIN               
                  
   INSERT INTO @tbl          
   EXEC [dbo].[stp_npd_GetPBFRADates]  @PIDFId=@PIDFID, @BusinessUnitId=@BUId1, @CountryId=@CountryID,  @TypeOfSubmissionId=@tos, @LastDataFromRnD=@ldRnD                 
             
   FETCH NEXT FROM cur INTO @CountryID, @BUId1, @tos, @ldRnD          
     END               
     CLOSE cur;              
     DEALLOCATE cur;           
          
            
            CREATE TABLE #TempPhases (                
                CId INT,       
       ReceiptDatefromRnDStart DATETIME,      
                DossierReadyDateStart DATETIME,                
                DossierSubmissionDateStart DATETIME,                
                EOPdateStart DATETIME,                
                CountryApprovalDateStart DATETIME,                
                EarliestLaunchDateStart DATETIME,                
                CountryLaunchDateStart DATETIME,                
                PurchaseOrderRaisedStart DATETIME,                
                APIOrderedStart DATETIME,                
                CutterGuidesArtworkStart DATETIME,                
                DraftArtCompletedStart DATETIME,                
                ArtworksSubmitStart DATETIME,                
                PlanBatchManufactureStart DATETIME,      
          
       ReceiptDatefromRnDEnd DATETIME,      
                DossierReadyDateEnd DATETIME,                
                DossierSubmissionDateEnd DATETIME,                
                EOPdateEnd DATETIME,                
                CountryApprovalDateEnd DATETIME,                
                EarliestLaunchDateEnd DATETIME,                
                CountryLaunchDateEnd DATETIME,                
                PurchaseOrderRaisedEnd DATETIME,      
                APIOrderedEnd DATETIME,                
                CutterGuidesArtworkEnd DATETIME,                
                DraftArtCompletedEnd DATETIME,                
                ArtworksSubmitEnd DATETIME,                
                PlanBatchManufactureEnd DATETIME,                
                        
    PlReceiptDatefromRnDStart DATETIME,      
                PlDossierReadyDateStart DATETIME,                
                PlDossierSubmissionDateStart DATETIME,                
                PlEOPdateStart DATETIME,                
                PlCountryApprovalDateStart DATETIME,                
                PlEarliestLaunchDateStart DATETIME,                
                PlCountryLaunchDateStart DATETIME,                
                PlPurchaseOrderRaisedStart DATETIME,                
                PlAPIOrderedStart DATETIME,                
                PlCutterGuidesArtworkStart DATETIME,                
                PlDraftArtCompletedStart DATETIME,                
                PlArtworksSubmitStart DATETIME,                
                PlPlanBatchManufactureStart DATETIME,             
          
          
       PlReceiptDatefromRnDEnd DATETIME,      
                PlDossierReadyDateEnd DATETIME,                
                PlDossierSubmissionDateEnd DATETIME,                
                PlEOPdateEnd DATETIME,                
                PlCountryApprovalDateEnd DATETIME,                
                PlEarliestLaunchDateEnd DATETIME,                
                PlCountryLaunchDateEnd DATETIME,                
                PlPurchaseOrderRaisedEnd DATETIME,      
                PlAPIOrderedEnd DATETIME,                
                PlCutterGuidesArtworkEnd DATETIME,                
                PlDraftArtCompletedEnd DATETIME,                
                PlArtworksSubmitEnd DATETIME,                
                PlPlanBatchManufactureEnd DATETIME,                
                     
              
                StartDate DATETIME,                
                EndDate DATETIME ,          
              
            )                
                
            INSERT INTO #TempPhases (                
                CId,ReceiptDatefromRnDEnd, DossierReadyDateEnd, DossierSubmissionDateEnd, EOPdateEnd, CountryApprovalDateEnd,                
                EarliestLaunchDateEnd, CountryLaunchDateEnd , PlDossierReadyDateEnd, PlDossierSubmissionDateEnd, PlEOPdateEnd, PlCountryApprovalDateEnd,                
                PlEarliestLaunchDateEnd, PlCountryLaunchDateEnd             
            )                
            SELECT                
                r.CountryIdBuId,                
    r.LastDataFromRnD,      
                r.DossierReadyDate,                
                r.EarliestSubmissionDExcl,                
                r.EndOfProcedureDate,                
                r.CountryApprovalDate,                
                r.EarliestLaunchDExcl,                
                DATEADD(MONTH, 4, r.CountryApprovalDate) CountryLaunchDate,          
                t.DossierReadyDate,                
                t.EarliestSubmissionDate,                
                t.EndOfProcedureDate,                
                t.CountryApprovalDate,                
                t.EarliestLaunchDate,                
                DATEADD(MONTH, 4, t.CountryApprovalDate) CountryLaunchDate          
            FROM PIDF_PBF_RA r          
            LEFT JOIN @tbl t ON t.PIDFId = r.PIDFId AND t.CountyId = r.CountryIdBuId            
            WHERE r.PIDFId = @PIDFID                
        
     DELETE t FROM #TempPhases t WHERE t.DossierReadyDateEnd IS NULL       
               
            
            UPDATE #TempPhases                
            SET           
       ReceiptDatefromRnDStart = DATEADD(DAY, -10, ReceiptDatefromRnDEnd),      
    DossierReadyDateStart = DATEADD(DAY, 1, ReceiptDatefromRnDEnd),      
    DossierSubmissionDateStart= DATEADD(DAY, 1, ReceiptDatefromRnDEnd),      
    EOPdateStart = DATEADD(DAY, 1, DossierSubmissionDateEnd),      
    CountryApprovalDateStart = DATEADD(DAY, 1, EOPdateEnd),      
    EarliestLaunchDateStart = DATEADD(DAY, 1, CountryApprovalDateEnd),       
          
      
                PurchaseOrderRaisedStart = DATEADD(MONTH, -12, CountryLaunchDateEnd),                
                APIOrderedStart = DATEADD(MONTH, -12, CountryLaunchDateEnd),                
                APIOrderedEnd = DATEADD(DAY, 14, DATEADD(MONTH, -12, CountryLaunchDateEnd)),                
                CutterGuidesArtworkStart = DATEADD(MONTH, -1, EOPdateEnd),                
                CutterGuidesArtworkEnd = DATEADD(MONTH, -1, EOPdateEnd),                
                DraftArtCompletedStart = DateAdd(Day, 25, DATEADD(MONTH, -1, EOPdateEnd)),                
                DraftArtCompletedEnd = DateAdd(Day, 25, DATEADD(MONTH, -1, EOPdateEnd)),                
                ArtworksSubmitStart = DateAdd(Day, 31, DATEADD(MONTH, -1, EOPdateEnd)),                
                ArtworksSubmitEnd = DateAdd(Day, 31, DATEADD(MONTH, -1, EOPdateEnd)),                
                PlanBatchManufactureStart = CountryApprovalDateEnd,                
                PlanBatchManufactureEnd = DATEADD(DAY, 15, CountryApprovalDateEnd),          
          
                   
          
       PlReceiptDatefromRnDStart = DATEADD(DAY, -10, PlReceiptDatefromRnDEnd),      
    PlDossierReadyDateStart = DATEADD(DAY, 1, PlReceiptDatefromRnDEnd),      
    PlDossierSubmissionDateStart= DATEADD(DAY, 1, PlReceiptDatefromRnDEnd),      
    PlEOPdateStart = DATEADD(DAY, 1, PlDossierSubmissionDateEnd),      
    PlCountryApprovalDateStart = DATEADD(DAY, 1, PlEOPdateEnd),      
    PlEarliestLaunchDateStart = DATEADD(DAY, 1, PlCountryApprovalDateEnd),       
          
      
                PlPurchaseOrderRaisedStart = DATEADD(MONTH, -12, PlCountryLaunchDateEnd),                
                PlAPIOrderedStart = DATEADD(MONTH, -12, PlCountryLaunchDateEnd),                
                PlAPIOrderedEnd = DATEADD(DAY, 14, DATEADD(MONTH, -12, PlCountryLaunchDateEnd)),                
                PlCutterGuidesArtworkStart = DATEADD(MONTH, -1, PlEOPdateEnd),                
                PlCutterGuidesArtworkEnd = DATEADD(MONTH, -1, PlEOPdateEnd),                
                PlDraftArtCompletedStart = DateAdd(Day, 25, DATEADD(MONTH, -1, PlEOPdateEnd)),                
                PlDraftArtCompletedEnd = DateAdd(Day, 25, DATEADD(MONTH, -1, PlEOPdateEnd)),                
                PlArtworksSubmitStart = DateAdd(Day, 31, DATEADD(MONTH, -1, PlEOPdateEnd)),                
                PlArtworksSubmitEnd = DateAdd(Day, 31, DATEADD(MONTH, -1, PlEOPdateEnd)),                
                PlPlanBatchManufactureStart = PlCountryApprovalDateEnd,                
                PlPlanBatchManufactureEnd = DATEADD(DAY, 15, PlCountryApprovalDateEnd)             
                        
   SELECT *                
            INTO #FinalTemp                
            FROM #TempPhases t                
            INNER JOIN #Countries c ON t.CId = c.CountryId                
                  
               
            ;WITH TaskCTE AS (                
                SELECT                
                    @PIDFID AS PIDFId,                
                    CONCAT(mwt.TaskName, '(', upd.CountryName, ')') AS TaskName,                
                    @TaskOwnerId AS TaskOwnerId,                
                    mwt.TaskLevel AS TaskLevel,                
                    CASE       
         WHEN TaskName LIKE '%Receipt date from RnD%' THEN upd.ReceiptDatefromRnDStart           
                        WHEN TaskName LIKE '%Dossier Ready Date%' THEN upd.DossierReadyDateStart                
                        WHEN TaskName LIKE '%Dossier Submission Date%' THEN upd.DossierSubmissionDateStart               
                        WHEN TaskName LIKE '%End of Procedure (EOP) Date%' THEN upd.EOPdateStart             
                        WHEN TaskName LIKE '%Country Approval Date%' THEN upd.CountryApprovalDateStart                
                        WHEN TaskName LIKE '%Earliest Launch Date%' THEN upd.EarliestLaunchDateStart                
                        WHEN TaskName LIKE '%Purchase Order Raised%' THEN upd.PurchaseOrderRaisedStart                
                        WHEN TaskName LIKE '%API Ordered%' THEN upd.APIOrderedStart                
                        WHEN TaskName LIKE '%Cutter Guides sent to Artwork%' THEN upd.CutterGuidesArtworkStart                
                        WHEN TaskName LIKE '%Draft Artworks completed%' THEN upd.DraftArtCompletedStart                
                        WHEN TaskName LIKE '%Artworks submitted and approved%' THEN upd.ArtworksSubmitStart                
                        WHEN TaskName LIKE '%Plan Batch manufacture%' THEN upd.PlanBatchManufactureStart                
                        WHEN TaskName LIKE '%Launch in Country%' THEN upd.CountryLaunchDateEnd                
                        ELSE DATEADD(DAY, -mwt.StartDateOffset, upd.CountryLaunchDateEnd)                
                    END AS StartDate,                
                    CASE                
         WHEN TaskName LIKE '%Receipt date from RnD%' THEN upd.ReceiptDatefromRnDEnd       
                        WHEN TaskName LIKE '%Dossier Ready Date%' THEN upd.DossierReadyDateEnd                
                        WHEN TaskName LIKE '%Dossier Submission Date%' THEN upd.DossierSubmissionDateEnd                
                        WHEN TaskName LIKE '%End of Procedure (EOP) Date%' THEN upd.EOPdateEnd              
                        WHEN TaskName LIKE '%Country Approval Date%' THEN upd.CountryApprovalDateEnd                
                        WHEN TaskName LIKE '%Earliest Launch Date%' THEN upd.EarliestLaunchDateEnd              
                        WHEN TaskName LIKE '%Purchase Order Raised%' THEN upd.PurchaseOrderRaisedStart                
                        WHEN TaskName LIKE '%Cutter Guides sent to Artwork%' THEN upd.CutterGuidesArtworkEnd                
                        WHEN TaskName LIKE '%Draft Artworks completed%' THEN upd.DraftArtCompletedEnd                
                        WHEN TaskName LIKE '%Artworks submitted and approved%' THEN upd.ArtworksSubmitEnd                
                        WHEN TaskName LIKE '%Plan Batch manufacture%' THEN upd.PlanBatchManufactureEnd                
                        WHEN TaskName LIKE '%Launch in Country%' THEN upd.CountryLaunchDateEnd                
                        WHEN TaskName LIKE '%API Ordered%' THEN upd.APIOrderedEnd                
                        ELSE DATEADD(DAY, -mwt.EndDateOffset, upd.CountryLaunchDateEnd)                
                    END AS EndDate,                
                    1 AS PriorityId,                
                    1 AS StatusId,                
                    0 AS TaskDuration,                
                    0 AS TotalPercentage,                
                    GETDATE() AS CreatedDate,                
                    @UserId AS CreatedBy,                
                    mwt.ParentId AS ParentId,                
    CASE                
                     WHEN TaskName LIKE '%Receipt date from RnD%' THEN upd.PlReceiptDatefromRnDStart       
                        WHEN TaskName LIKE '%Dossier Ready Date%' THEN upd.PlDossierReadyDateStart                
                        WHEN TaskName LIKE '%Dossier Submission Date%' THEN upd.PlDossierSubmissionDateStart                
                        WHEN TaskName LIKE '%End of Procedure (EOP) Date%' THEN upd.PlEOPdateStart            
                        WHEN TaskName LIKE '%Country Approval Date%' THEN upd.PlCountryApprovalDateStart                
                        WHEN TaskName LIKE '%Earliest Launch Date%' THEN upd.PlEarliestLaunchDateStart               
                        WHEN TaskName LIKE '%Purchase Order Raised%' THEN upd.PlPurchaseOrderRaisedEnd               
                        WHEN TaskName LIKE '%API Ordered%' THEN upd.PlAPIOrderedStart                
                        WHEN TaskName LIKE '%Cutter Guides sent to Artwork%' THEN upd.PlCutterGuidesArtworkStart                
                        WHEN TaskName LIKE '%Draft Artworks completed%' THEN upd.PlDraftArtCompletedStart                
                        WHEN TaskName LIKE '%Artworks submitted and approved%' THEN upd.PlArtworksSubmitStart                
                        WHEN TaskName LIKE '%Plan Batch manufacture%' THEN upd.PlPlanBatchManufactureStart                
                        WHEN TaskName LIKE '%Launch in Country%' THEN upd.PlCountryLaunchDateEnd               
     ELSE DATEADD(DAY, -mwt.StartDateOffset, upd.PlCountryLaunchDateEnd)                
                    END AS PlannedStartDate,                
                    CASE             
         WHEN TaskName LIKE '%Receipt date from RnD%' THEN upd.PlReceiptDatefromRnDEnd       
                        WHEN TaskName LIKE '%Dossier Ready Date%' THEN upd.PlDossierReadyDateEnd                
                        WHEN TaskName LIKE '%Dossier Submission Date%' THEN upd.PlDossierSubmissionDateEnd                
                        WHEN TaskName LIKE '%End of Procedure (EOP) Date%' THEN upd.PlEOPdateEnd                
                        WHEN TaskName LIKE '%Country Approval Date%' THEN upd.PlCountryApprovalDateEnd                
                        WHEN TaskName LIKE '%Earliest Launch Date%' THEN upd.PlEarliestLaunchDateEnd                
                        WHEN TaskName LIKE '%Purchase Order Raised%' THEN upd.PlAPIOrderedEnd                
                        WHEN TaskName LIKE '%Cutter Guides sent to Artwork%' THEN upd.PlCutterGuidesArtworkEnd                
                        WHEN TaskName LIKE '%Draft Artworks completed%' THEN upd.PlDraftArtCompletedEnd                
                        WHEN TaskName LIKE '%Artworks submitted and approved%' THEN upd.PlArtworksSubmitEnd                
                        WHEN TaskName LIKE '%Plan Batch manufacture%' THEN upd.PlPlanBatchManufactureEnd                
                        WHEN TaskName LIKE '%Launch in Country%' THEN upd.PlCountryLaunchDateEnd                
                        WHEN TaskName LIKE '%API Ordered%' THEN upd.PlAPIOrderedEnd                
                        ELSE DATEADD(DAY, -mwt.EndDateOffset, upd.PlCountryLaunchDateEnd)                
                    END AS PlannedEndDate                
                FROM Master_WorkFlow_Tasks mwt                
                CROSS JOIN #FinalTemp upd                
                WHERE mwt.country = 1 AND mwt.WorkFlowId = @WorkflowId                
            )                
                
            -- Insert the CTE results into the temp table                
            INSERT INTO ProjectTask (                
                PIDFId, TaskName, TaskOwnerId, TaskLevel, StartDate, EndDate, PriorityId, StatusId,                
                TaskDuration, TotalPercentage, CreatedDate, CreatedBy, ParentId, PlannedStartDate,                
                PlannedEndDate                
            )                
            SELECT                
                @PIDFID,                
                TaskName,                
                TaskOwnerId,                
                TaskLevel,                
                StartDate,                
                EndDate,                
                PriorityId,                
                StatusId,                
                DATEDIFF(DAY, StartDate, EndDate),                
                TotalPercentage,                
                CreatedDate,                
                CreatedBy,                
                ParentId,                
                PlannedStartDate,                
                PlannedEndDate                
            FROM TaskCTE;                
                
            CREATE TABLE #ProjectTaskInfo (                
                ParentId INT IDENTITY(1, 1),                
                TaskName VARCHAR(100),                
                ProjectTaskId INT,                
                PIDFId INT                
            )                
                
            INSERT INTO #ProjectTaskInfo (TaskName, PIDFId, ProjectTaskId)                
            SELECT TaskName, PIDFId, ProjectTaskId                
            FROM ProjectTask                
            WHERE PIDFId = @PIDFID                
                
            UPDATE pt                
            SET pt.ParentId = ISNULL(pti.ProjectTaskId, 0)                
            FROM ProjectTask pt                
            LEFT JOIN #ProjectTaskInfo pti ON pt.ParentId = pti.ParentId                
          WHERE pt.PIDFId = @PIDFID;                
        END                
    END                
      
	DROP TABLE IF EXISTS  #ProjectTaskInfo; DROP TABLE IF EXISTS #Countries; 
	DROP TABLE IF EXISTS #TempPhases;	    DROP TABLE IF EXISTS #FinalTemp       
                
    SET NOCOUNT OFF;                
END 
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasks-_Old]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec ProcGetProjectNameAndStrength 122        
create proc [dbo].[ProcAddWorkflowTasks-_Old] --83,16     
(        
@PIDFID int=0,  
@BusinessUnit int=0  
)        
AS         
--ProcGetProjectNameAndStrength 2,10077-- 10072,        
BEGIN        
   SET NOCOUNT ON;     
   Declare @ApprovalCount int, @ApprovedCount int  
   Select @ApprovalCount =  COUNT(UserId) from Master_User  
  Where IsActive = 1 And IsDeleted = 0 And IsManagement = 1  ;  
  
  
  Select @ApprovedCount = COUNT(*)  
 from PIDF_ManagementApprovalStatusHistory  
  Where PIDFId = @PIDFID  
     
  
If (@ApprovalCount = @ApprovedCount)  
BEGIN  
  
select * into #Countries from  dbo.GetCountryForBusinessUnitAndPIDF(@PIDFID, @BusinessUnit)  
  insert into ProjectTask(  
PIDFId,  
TaskName,  
TaskOwnerId,  
TaskLevel,  
StartDate,  
EndDate,  
PriorityId,  
StatusId,  
TaskDuration,  
TotalPercentage,  
CreatedDate,  
CreatedBy,  
ModifyDate,  
ModifyBy,  
ParentId,  
PlannedStartDate,  
PlannedEndDate)  
  
select @PIDFID, TaskName, 1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, parentId, null, null   
from Master_WorkFlowTasks  
union  
select @PIDFID, CONCAT('Launch in Country ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 4, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('API ordered ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 3, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('DCP Approval in ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 2, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('National Phase in ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 2, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('Purchase order raised ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 3, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('Submit DCP2 into ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 1, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('Validation DCP1 into ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 1, null, null   
from #Countries   
union   
select @PIDFID, CONCAT('Validation DCP2 into ', CountryName) AS TASKNAME,1, 4, getdate(), getdate(), 1, 1, 0, 0, getdate(), '', null,null, 1, null, null   
from #Countries   
END  
   SET NOCOUNT OFF;        
END   
  
  
GO
/****** Object:  StoredProcedure [dbo].[ProcAddWorkflowTasksSwapp]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec ProcGetProjectNameAndStrength 122              
CREATE proc [dbo].[ProcAddWorkflowTasksSwapp] --83,16           
(              
@PIDFID int=0,        
@BusinessUnit int=0        
)              
AS                       
BEGIN              
SET NOCOUNT ON;     
     
Declare @ApprovalCount int, @ApprovedCount int        
  
Select @ApprovalCount =  COUNT(UserId) from Master_User   
Where IsActive = 1 And IsDeleted = 0 And IsManagement = 1  
        
Select @ApprovedCount = COUNT(*)        
from PIDF_ManagementApprovalStatusHistory        
Where PIDFId = @PIDFID --And StatusId = 20   
                 
select @ApprovalCount, @ApprovedCount
If (@ApprovalCount <> @ApprovedCount)        
BEGIN        
        
 Declare @WorkflowId int = (Select top 1 WorkFlowId from PIDF_PBF Where PIDFId = @PIDFId)  
  
 select * into #Countries from  dbo.GetCountryForBusinessUnitAndPIDF(@PIDFID, @BusinessUnit)       
    
 INSERT INTO ProjectTask (PIDFId, TaskName, TaskOwnerId, TaskLevel, StartDate, EndDate, PriorityId, StatusId,    
 TaskDuration, TotalPercentage, CreatedDate, CreatedBy, ModifyDate, ModifyBy, ParentId, PlannedStartDate  
 , PlannedEndDate)   
   
 SELECT  @PIDFID, mwt.taskname AS TaskName, 1, 4, GETDATE(), GETDATE(), 1, 1,  0,  0,  GETDATE(),  '',  NULL,  
 NULL,  mwt.ParentId,  NULL,  NULL FROM Master_WorkFlowTasks mwt   
 WHERE mwt.country = 0 --And mwt.WorkFlowId = @WorkflowId  
   
 UNION ALL   
   
 SELECT  @PIDFID, CONCAT(mwt.TaskName, c.CountryName) AS TaskName, 1, 4, GETDATE(), GETDATE(), 1, 1,  0,  0,  
 GETDATE(),  '',  NULL, NULL,  mwt.ParentId,  NULL,  NULL FROM Master_WorkFlowTasks mwt   
 CROSS JOIN  #Countries c    
 WHERE mwt.country = 1 --And mwt.WorkFlowId = @WorkflowId  

 create table #ProjectTaskInfo(ParentId int identity(1,1), TaskName varchar(100), ProjectTaskId int, PIDFId int )

 insert into #ProjectTaskInfo(TaskName, PIDFId, ProjectTaskId)
 select taskName,PIDFId, ProjectTaskId from ProjectTask where PIDFId = @PIDFID 

 UPDATE pt
    SET pt.ParentId = ISNULL(pti.ProjectTaskId,0)
	FROM ProjectTask pt
    left JOIN #ProjectTaskInfo pti ON pt.ParentId = pti.parentId
    WHERE pt.PIDFId = @PIDFID ;
     
END        
SET NOCOUNT OFF;              
END         
        
   
  
GO
/****** Object:  StoredProcedure [dbo].[ProcGetCommercialPackSizeForManagmentApproval]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--  exec ProcGetCommercialPackSizeForManagmentApproval  214,2                                    
CREATE     Proc [dbo].[ProcGetCommercialPackSizeForManagmentApproval] --135,16,5,2                                
@PIDFId int=0,           
@BusinessUnitId int=0           
AS                                
BEGIN                           
                    
  declare @PIDFFinaceId as int        
  select @PIDFFinaceId = PIDFFinaceId from PIDF_Finance where PIDFId = @PIDFId        
          
select  mps.PackSizeId,mps.PackSizeName,batch.EmcureCOGs_pack ,strn.Strength [SkusName],strn.PIDFProductStrengthId      
from PIDF_Finance finance                    
inner join PIDF_Finance_BatchSizeCoating batch on batch.PIDFFinaceId = finance.PIDFFinaceId --and batch.PakeSize =  pc.PackSizeId      
inner join Master_PackSize mps on mps.PackSizeId=batch.PakeSize      
inner join PIDFProductStrength strn on  strn.PIDFProductStrengthId = batch.SKus   --And strn.BusinessUnitId = @BusinessUnitId    
where finance.PIDFFinaceId=@PIDFFinaceId       
      
select   --batch.Marketinpacks      
pcy.SUIMSVolume as Marketinpacks                          
--,Convert(numeric(18,2),isnull(pcy.BrandPrice,0)) as BrandPrice                                
--,Convert(numeric(18,2),isnull(pcy.GenericPrice,0)) as GenericPrice                                
--,Convert(numeric(18,2),isnull(pcy.PriceDiscounting,0)) as PriceDiscounting                                 
--,Convert(numeric(18,2),ISNULL(pcy.SUIMSVolume,0)) as SUIMSVolume                                
--,Convert(numeric(18,2),ISNULL(pcy.CommercialBatchSize,0)) as CommercialBatchSize                             
,Convert(numeric(18,2),isnull(MarketSharePercentageLow,0)) As MarketSharePercentageLow                            
,Convert(numeric(18,2),isnull(MarketSharePercentageMedium,0)) As MarketSharePercentageMedium                            
,Convert(numeric(18,2),isnull(MarketSharePercentageHigh,0)) As MarketSharePercentageHigh                            
,Convert(numeric(18,2),isnull(NSPUnitsLow,0)) As NSPUnitsLow                            
,Convert(numeric(18,2),isnull(NSPUnitsMedium,0)) As NSPUnitsMedium                            
,Convert(numeric(18,2),isnull(NSPUnitsHigh,0)) As NSPUnitsHigh                            
from PIDF_Commercial as pc                                                         
inner join PIDF_Commercial_Years as pcy on pcy.PIDFCommercialId=pc.PIDFCommercialId                        
where  pc.IsDeleted =0  and pcy.YearIndex =1 and pc.BusinessUnitId = @BusinessUnitId and pc.PIDFId = @PIDFId                     
                          
select Expiries,AnnualConfirmatoryRelease,[Year] from PIDF_Finance_Projection projection                                  
where projection.PIDFFinaceId=@PIDFFinaceId and projection.BusinessUnitId=@BusinessUnitId  order by [Year]                          
      
------------------------------------------------      
select    
PC.BusinessUnitId  
,(select BusinessUnitName from Master_BusinessUnit where BusinessUnitId = PC.BusinessUnitId) as BusinessUnitName
,Convert(numeric(18,2),isnull(MarketSharePercentageLow,0)) As MarketSharePercentageLow              
,Convert(numeric(18,2),isnull(MarketSharePercentageMedium,0)) As MarketSharePercentageMedium              
,Convert(numeric(18,2),isnull(MarketSharePercentageHigh,0)) As MarketSharePercentageHigh              
,Convert(numeric(18,2),isnull(NSPUnitsLow,0)) As NSPUnitsLow              
,Convert(numeric(18,2),isnull(NSPUnitsMedium,0)) As NSPUnitsMedium              
,Convert(numeric(18,2),isnull(NSPUnitsHigh,0)) As NSPUnitsHigh   
--,pd.Strength  
from PIDF_Commercial_Years PCY   
inner join PIDF_Commercial PC on PC.PIDFCommercialId = PCY.PIDFCommercialId  
--left join PIDFProductStrength pd on pd.PIDFID = pc.PIDFId  
where PC.PIDFId = @PIDFId  
and PCY.YearIndex =1   
  
END 


GO
/****** Object:  StoredProcedure [dbo].[PRocGetFinanceBatchSizeCoating]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec  PRocGetFinanceBatchSizeCoating  24 
CREATE   PROC [dbo].[PRocGetFinanceBatchSizeCoating] --4          
@PIDFFinaceId int=0          
AS          
BEGIN          
SELECT  [PIDFFinaceBatchSizeCoatingId]          
      ,[PIDFFinaceId]          
      ,[Batchsize]          
      ,[Yield]          
      , IsNULL([Batchoutput],0 )  as [Batchoutput]             
      , IsNULL([API_CAD],0 )  as [API_CAD]       
      ,    IsNULL([Excipients_CAD],0 )  as [Excipients_CAD]             
      ,				IsNULL([PM_CAD],0 )  as [PM_CAD] 
      ,           IsNULL([CCPC_CAD],0 )  as [CCPC_CAD] 
      ,        IsNULL([Freight_CAD],0 )  as [Freight_CAD]    
      ,[EmcureCOGs_pack]          
      ,[CreatedDate]          
      ,[CreatedBy]          
   ,Skus          
   ,(select top 1 Strength from PIDFProductStrength where PIDFProductStrengthId=Skus)  [SkusName]        
   ,PakeSize          
   ,(select PackSize from Master_PackSize where PackSizeId = PakeSize) [PackSizeValue]     
   ,(PakeSize) [PakeSizeName]        
   ,BrandPrice          
   ,GenericListprice          
   , NetRealisation--Isnull(NetRealisation,(GenericListprice*40)/100) as NetRealisation          
   ,EstMAT2016_BY_12Units as EstMat2016By12units          
   ,EstMAT2020_BY_12Units as EstMat2020By12units          
   ,CAGRover2016_By_12EstMATunits as Cagrover2016By12estMatunits          
   ,Marketinpacks          
   ,Batchsizein_ltr_tabs as BatchsizeinLtrTabs                      
  FROM PIDF_Finance_BatchSizeCoating          
  WHERE PIDFFinaceId=@PIDFFinaceId or @PIDFFinaceId=0          
        
  select Expiries,AnnualConfirmatoryRelease,[Year] from PIDF_Finance_Projection  where PIDFFinaceId=@PIDFFinaceId order by [Year]         
        
        
        
  END
GO
/****** Object:  StoredProcedure [dbo].[ProcGetPackSizeByStrengthId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  -- exec [ProcGetPackSizeByStrengthId] 13, 1, 30  
CREATE  Proc [dbo].[ProcGetPackSizeByStrengthId] --1,1,5    
@PIDFId int=0,    
@Buid int=0,    
@StrengthId int=0    
AS    
BEGIN    
select distinct mps.PackSizeId,PackSize,PackSizeName    
from PIDF_Commercial as pc    
inner join Master_PackSize mps on mps.PackSizeId=pc.PackSizeId    
--inner join PIDF_Commercial_Years as pcy on pcy.PIDFCommercialId=pc.PIDFCommercialId    
where pc.PIDFId=@PIDFId and pc.BusinessUnitId=@Buid and pc.PIDFProductStrengthId=@StrengthId and pc.IsDeleted =0 
END    
    
    
    
GO
/****** Object:  StoredProcedure [dbo].[ProcGetPidfFinance]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   Proc [dbo].[ProcGetPidfFinance]  
@PIDFId int=0  
AS   
BEGIN  
SELECT   
       [PIDFFinaceId] as PidffinaceId  
      ,pf.[PIDFId] as Pidfid  
      ,[Entity] as Entity  
      ,[Product] as Product  
      ,[ForecastDate] as ForecastDate  
      ,[Currencyid] as Currencyid  
      ,[DosageFrom] as DosageFrom  
      ,[ManufacturingSiteOrPartner] as ManufacturingSiteOrPartner  
      ,[SKUs] as Skus  
      ,[MSPersentage] as Mspersentage  
      ,[TargetPriceScenario] as TargetPriceScenario  
      ,[ProjectStartDate] as ProjectStartDate  
      ,[BatchManufacturing] as BatchManufacturing  
      ,[ExpectedFilling] as ExpectedFilling  
      ,[ApprovalPeriodinDays] as ApprovalPeriodinDays  
      ,[ApprovalDate] as ApprovalDate  
      ,[ProductLaunchDate] as ProductLaunchDate  
      ,isnull([GestationPeriodinYears],0) as GestationPeriodinYears  
      ,[MarketShareErosionrate] as MarketShareErosionrate  
      ,[PriceErosion] as PriceErosion  
   ,EscalationinCOGS  
      ,[DiscountRate] as DiscountRate  
      ,[Incometaxrate] as Incometaxrate  
      ,[Opexasapercenttosale] as Opexasapercenttosale  
      ,[ExternalProfitSharepercent] as ExternalProfitSharepercent  
      ,[CollectioninDays] as CollectioninDays  
      ,[InventoryinDays] as InventoryinDays  
      ,[CreditorinDays] as CreditorinDays  
      ,[MarketingAllowance] as MarketingAllowance  
      ,[RegulatoryMaintenanceCost] as RegulatoryMaintenanceCost  
      ,[GrosstoNet] as GrosstoNet  
      ,[Noofbatchestobemanufactured] as Noofbatchestobemanufactured  
      ,[NoofbatchestobemanufacturedPhaseEndDate] as NoofbatchestobemanufacturedPhaseEndDate  
      ,[NoSKUs] as NoSkus  
      ,[NoSKUsPhaseEndDate] as NoSkusPhaseEndDate  
      ,[RandDAnalyticalcost] as RandDanalyticalcost  
      ,[RandDAnalyticalcostPhaseEndDate]  as RandDanalyticalcostPhaseEndDate  
      ,[RLDsamplecost] as Rldsamplecost  
      ,[RLDsamplecostPhaseEndDate] as RldsamplecostPhaseEndDate  
      ,[BatchmanufacturingcostOrAPIActualsEst] as BatchmanufacturingcostOrApiactualsEst  
      ,[BatchmanufacturingcostOrAPIActualsEstPhaseEndDate] as BatchmanufacturingcostOrApiactualsEstPhaseEndDate  
      ,[Sixmonthsstabilitycost] as Sixmonthsstabilitycost  
      ,[SixmonthsstabilitycostPhaseEndDate] as SixmonthsstabilitycostPhaseEndDate  
      ,[TechTransfer] as TechTransfer  
      ,[TechTransferPhaseEndDate] as TechTransferPhaseEndDate  
      ,[BEstudies] as Bestudies  
      ,[BEstudiesPhaseEndDate] as BestudiesPhaseEndDate  
      ,[Filingfees] as Filingfees  
      ,[FilingfeesPhaseEndDate] as FilingfeesPhaseEndDate  
      ,[BioStuddyCost] as BioStuddyCost  
      ,[BioStuddyCostPhaseEndDate] as BioStuddyCostPhaseEndDate  
      ,[Capex] as Capex  
      ,[CapexPhaseEndDate] as CapexPhaseEndDate  
      ,[ToolingAndChangeParts] as ToolingAndChangeParts  
      ,[ToolingAndChangePartsPhaseEndDate] as ToolingAndChangePartsPhaseEndDate  
      ,[Total] as Total  
      ,pf.[CreatedDate] as CreatedDate  
      ,pf.[CreatedBy] as CreatedBy  
   ,isnull(p.StatusId,0) as PIDFStatusId 
   , (select ProjectInitiationDate from PIDF_PBF where PIDFID = @PIDFId) as ProjectInitiationDate
   , (select BatchManifacturingDate from PIDF_PBF where PIDFID = @PIDFId) as BatchManifacturingDate
   ,(select FillingDateDate from PIDF_PBF where PIDFID = @PIDFId) as FillingDateDate

  FROM PIDF_Finance as pf  
  inner join PIDF as p on p.PIDFID=pf.PIDFId  
  inner join Master_PIDFStatus as mps on p.StatusId=mps.PIDFStatusID  
  WHERE pf.PIDFId=@PIDFId or @PIDFId=0  
  END
GO
/****** Object:  StoredProcedure [dbo].[ProcGetProjectNameAndStrength]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec ProcGetProjectNameAndStrength 122 , 16    
CREATE proc [dbo].[ProcGetProjectNameAndStrength]      
(      
@PIDFID int=0,      
@BUID int=0      
)      
AS       
--ProcGetProjectNameAndStrength 2,10077-- 10072,      
BEGIN      
SET NOCOUNT ON;      
      
Declare @APIREQ nvarchar(20);      
Declare @ProjectName nvarchar(100);      
      
select top 1 @APIREQ = APIReq from PIDF_Commercial_Years as A      
inner join PIDF_Commercial B on A.PIDFCommercialId = B.PIDFCommercialId      
Inner join PIDF C on C.PIDFID=B.PIDFId and C.BusinessUnitId = B.BusinessUnitId      
where C.PIDFId =  @PIDFID      
      
      
select @ProjectName = MoleculeName from PIDF where (PIDFID=@PIDFID or @PIDFID=0)      
      
--select @ProjectName as projectName ,[dbo].[GetCurrencyCode](@PIDFID) as CurrencyCode,[dbo].[GetCurrencySymbol] (@PIDFID) as CurrencySymbol      
select @ProjectName as projectName ,'INR' as CurrencyCode, NCHAR(8377) as CurrencySymbol      
      
Select DISTINCT A.Strength + ' ' + F.UnitofMeasurementName As Strength, IsNull(E.ProjectCode, '') As ProjectCode,A.PIDFProductStrengthId,B.InHouses AS IsInhouse from PIDFProductStrength As A      
Inner Join PIDF As B On A.PIDFId = B.PIDFId      
Inner Join Master_UnitofMeasurement As F On F.UnitofMeasurementId = A.UnitofMeasurementId      
Left Join PIDF_PBF As C On C.PIDFId = B.PIDFId And A.PIDFId = C.PIDFId      
Left Join PIDF_PBF_General As D On D.BusinessUnitId = B.BusinessUnitId And D.PIDFPBFId = C.PIDFPBFId      
Left Join PIDF_PBF_General_Strength As E On E.PBFGeneralId = D.PBFGeneralId And E.StrengthId = A.PIDFProductStrengthId      
Where B.PIDFId = @PIDFID And A.BusinessUnitId = @BUID  
order by A.PIDFProductStrengthId       
      
--select UserId,FullName as ManagerName,isnull(DesignationName,'NA') as DesignationName from Master_User where IsNUll(IsManagement, 0)=1      
--And IsActive = 1 And IsDeleted = 0      
select UserId,FullName as ManagerName,isnull(u.DesignationName,'') as DesignationName,isnull(pm.StatusId,0) as StatusId,isnull(pm.CreatedDate,getdate()) as CreatedDate from Master_User as u      
left join PIDF_ManagementApprovalStatusHistory pm on pm.CreatedBy=u.UserId and pm.PIDFId=@PIDFID      
where IsNUll(IsManagement, 0)=1       
And u.IsActive = 1 And IsDeleted = 0      
order by pm.CreatedDate desc      
--Head-Wise Budget (INR Lacs)--      
Select       
A.ProjectActivitiesId,       
A.ProjectActivitiesName as [BudgetsHeades],      
isnull(B.Prototype,0) [Prototype],       
isnull(B.ScaleUp,0) [ScaleUp],       
isnull(B.Exhibit,0) [Exhibit],      
isnull((B.Prototype+ B.ScaleUp + B.Exhibit),0) [Total]      
from Master_HeadWiseBudgetActivities A      
Left Join PIDF_PBF_HeadWiseBudget B ON A.ProjectActivitiesId = B.ProjectActivitiesId      
left join PIDF_PBF_General As AA on AA.PBFGeneralId = B.PBFGeneralId      
left Join PIDF_PBF As BB On AA.PIDFPBFId = BB.PIDFPBFId      
left Join PIDF As CC On CC.PIDFId = BB.PIDFId And CC.BusinessUnitId = AA.BusinessUnitId      
Where CC.PIDFId = @PIDFID      
order by B.ProjectActivitiesId      
      
select       
STUFF((SELECT ', ' + cast(MB.BusinessUnitName as nvarchar)      
           FROM PIDF_PBF_MarketMapping MM        
     inner join Master_BusinessUnit MB on MB.BusinessUnitId = MM.BusinessUnitId      
           WHERE PIDFPBFId=B.PIDFPBFId        
          FOR XML PATH('')), 1, 1, '') as Market,      
IsNull(B.SponsorBusinessPartner,'') as [SponsorBusinessPartner],      
E.FullName as [GroupLeader],      
IsNull(A.ProjectComplexity,'') as [ProjectComplexity],      
cast([dbo].[GetProjectEndDate](@PIDFId) as nvarchar )+' Days' as [TotalProjectDuration],      
IsNull(@ProjectName,'') as [API],      
--STUFF((SELECT ', ' + cast(APIName as nvarchar)+' - '+ cast(APIS.APISourcingName as nvarchar)+' - '+ cast(APIVendor as nvarchar)      
--           FROM PIDFAPIDetails PA      
--     inner join Master_APISourcing APIS on APIS.APISourcingId = PA.APISourcingId      
--           WHERE PA.PIDFID=C.PIDFID        
--          FOR XML PATH('')), 1, 1, '') as [APISource]  
  case when PAM.Interested=1 then 'In House' else 'Out Source' end as [APISource]  
 ,@APIREQ as [APICommercialQuantity],      
 IsNull((select APIRequirementMarketPrice from PIDF_PBF_RnD_Master As D where D.PBFGeneralId = A.PBFGeneralId),'') as [APIprice],      
 IsNull(@ProjectName,'') as [APIRequirement],      
 IsNull([dbo].[GetPrototypePBFCharter](A.PBFGeneralId),'') as [Prototype],      
 IsNull([dbo].[GetScaleUpPBFCharter](A.PBFGeneralId),'') as [ScaleUp],      
 IsNull([dbo].[GetExhibitPBFCharter](A.PBFGeneralId),'') as [Exhibit],      
 --deliverable columns      
--@ProjectBudget = IsNull(A.TotalExpense,''),      
IsNull(A.TotalExpense,0) as [ProjectBudget],      
IsNull(convert(datetime,dateadd(dd,[dbo].[GetProjectEndDate](@PIDFId),B.ProjectInitiationDate),108),'') as [ProjectCompletionFilingDate],      
'FTR' as [BEStudies]  ,    
plant.PlantNameName as [PlantName],    
B.ProjectInitiationDate as [ProjectInitiationDate]    
, AnaAmvCost.Remark as [Note_Remark]    
from PIDF_PBF_General As A      
Inner Join PIDF_PBF As B On A.PIDFPBFId = B.PIDFPBFId      
Inner Join PIDF As C On C.PIDFId = B.PIDFId And C.BusinessUnitId = A.BusinessUnitId      
inner Join PIDF_PBF_RnD_Master As D On D.PBFGeneralId = A.PBFGeneralId      
inner Join Master_User As E On E.UserId = A.AnalyticalGLId      
left join Master_Plant As plant on plant.PlantId = B.PlantId    
left join PIDF_PBF_Analytical_AMVCost AnaAmvCost on AnaAmvCost.PBFGeneralId = A.PBFGeneralId   
left join PIDF_API_Master PAM on PAM.PIDFId = C.PIDFId  
Where C.PIDFId = @PIDFId      
      
      
---Cumulative Phase-Wise Budget (INR Lacs)--------      
Select       
isnull(B.FeasabilityCumTotal,0) [Feasability],       
isnull(B.PrototypeCumTotal,0) [Prototype],       
isnull(B.ScaleUpCumTotal,0) [ScaleUp],       
isnull(B.AMVCumTotal,0) [AMV],       
isnull(B.ExhibitCumTotal,0) [Exhibit],       
isnull(B.FilingCumTotal,0) [Filing]      
from PIDF_PBF_PhaseWiseBudget B      
Left join PIDF_PBF_General As AA on AA.PBFGeneralId = B.PBFGeneralId      
Left Join PIDF_PBF As BB On AA.PIDFPBFId = BB.PIDFPBFId      
Left Join PIDF As CC On CC.PIDFId = BB.PIDFId And CC.BusinessUnitId = AA.BusinessUnitId      
Where CC.PIDFId = @PIDFId      
      
      
---ADDITIONAL COST TO INCUR FOR ROW AND DOMESTIC MARKET (INR Lacs) AS Per Business Unit      
      
Declare @BusinessUnitId int = (Select BusinessUnitId from PIDF Where PIDFId = @PIDFId)      
Select       
dbo.GetReferenceProductCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) [ReferenceProductCost],      
dbo.GetCapexCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) [CapexMiscCost],      
dbo.GetBioStudyCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) [BioStudyCost],       
dbo.GetFillingCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) [FillingCost],      
(dbo.GetReferenceProductCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) + dbo.GetCapexCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId) + dbo.GetBioStudyCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId)     
+ dbo.GetFillingCostPBFCharter(A.PIDFId, A.BusinessUnitId, C.PBFGeneralId))[Total],      
D.BusinessUnitId,       
D.BusinessUnitName      
from PIDF As A      
Inner Join PIDF_PBF As B On A.PIDFId = B.PIDFId And B.PIDFId = @PIDFId      
Inner Join PIDF_PBF_General As C On C.PIDFPBFId = B.PIDFPBFId       
Inner Join Master_BusinessUnit As D On D.BusinessUnitId = C.BusinessUnitId      
Where A.PIDFId = @PIDFId And C.BusinessUnitId <> @BusinessUnitId  

--PBF Details
select PT.Cost as cost,PT.Tentative as tentative,PT.PBFWorkFlowTaskName as pbfworkflowtaskname,MW.WorkflowName as workflowname,PMB.PBFWorkFlowName as pbfworkflowname from [dbo].[PIDF_PBF_Outsource] PO
inner join [dbo].[PIDF_PBF_Outsource_Task] PT on PO.PIDFPBFOutsourceId=PT.PIDFPBFOutsourceId
inner join [dbo].[Master_Workflow] MW on PO.ProjectWorkflowId=MW.WorkflowId
inner join dbo.Master_PBFWorkFlow PMB on PO.PBFWorkflowId=PMB.PBFWorkFlowId
where PO.PIDFID=@PIDFID
SET NOCOUNT OFF;      
END 
GO
/****** Object:  StoredProcedure [dbo].[ProcGetStrengthByPIDFAnddBuId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec [ProcGetStrengthByPIDFAnddBuId] 135, 16
CREATE Proc [dbo].[ProcGetStrengthByPIDFAnddBuId] --1,1    
@PIDFId int=0,    
@Buid int=0    
AS    
BEGIN    
select distinct pc.PIDFProductStrengthId,pps.Strength, MU.UnitofMeasurementName from PIDF_Commercial as pc    
inner join PIDFProductStrength as pps on pc.PIDFProductStrengthId=pps.PIDFProductStrengthId And pps.PIDFID = @PIDFId And pps.BusinessUnitId = @Buid   
inner join Master_BusinessUnit as mbu on mbu.BusinessUnitId=pc.BusinessUnitId    
Inner Join Master_UnitofMeasurement As MU On MU.UnitofMeasurementId = pps.UnitofMeasurementId    
where pc.PIDFId=@PIDFId and pc.BusinessUnitId=@Buid and pc.IsDeleted =0   
END    
    
GO
/****** Object:  StoredProcedure [dbo].[ProcGetSUIMSVolumeYearWiseByPackSize]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--  exec ProcGetSUIMSVolumeYearWiseByPackSize    214,4,871,2        
            
CREATE     Proc [dbo].[ProcGetSUIMSVolumeYearWiseByPackSize] --135,16,5,2                  
@PIDFId int=0,                  
@Buid int=0,                  
@StrengthId int=0,                  
@PackSize int=0                  
AS                  
BEGIN                  
select                  
 Convert(numeric(18,2),isnull(pcy.BrandPrice,0)) as BrandPrice                  
,Convert(numeric(18,2),isnull(pcy.GenericPrice,0)) as GenericPrice                  
,Convert(numeric(18,2),isnull(pcy.PriceDiscounting,0)) as PriceDiscounting                   
,Convert(numeric(18,2),ISNULL(pcy.SUIMSVolume,0)) as SUIMSVolume                  
,Convert(numeric(18,2),ISNULL(pcy.CommercialBatchSize,0)) as CommercialBatchSize               
,Convert(numeric(18,2),isnull(MarketSharePercentageLow,0)) As MarketSharePercentageLow              
,Convert(numeric(18,2),isnull(MarketSharePercentageMedium,0)) As MarketSharePercentageMedium              
,Convert(numeric(18,2),isnull(MarketSharePercentageHigh,0)) As MarketSharePercentageHigh              
,Convert(numeric(18,2),isnull(NSPUnitsLow,0)) As NSPUnitsLow              
,Convert(numeric(18,2),isnull(NSPUnitsMedium,0)) As NSPUnitsMedium              
,Convert(numeric(18,2),isnull(NSPUnitsHigh,0)) As NSPUnitsHigh      
,mps.PackSize [PackSizeValue]  
    
from PIDF_Commercial as pc                  
inner join Master_PackSize mps on mps.PackSizeId=pc.PackSizeId                  
inner join PIDF_Commercial_Years as pcy on pcy.PIDFCommercialId=pc.PIDFCommercialId                  
where pc.PIDFId=@PIDFId and pc.BusinessUnitId=@Buid and pc.PIDFProductStrengthId = @StrengthId        
and mps.PackSizeId=@PackSize and pc.IsDeleted =0 and pcy.YearIndex =1           
            
select Expiries,AnnualConfirmatoryRelease,[Year] from PIDF_Finance_Projection where BusinessUnitId =@Buid and PIDFID = @PIDFId order by [Year]            
       
select    
PC.BusinessUnitId  
,(select BusinessUnitName from Master_BusinessUnit where BusinessUnitId = PC.BusinessUnitId) as BusinessUnitName
,Convert(numeric(18,2),isnull(MarketSharePercentageLow,0)) As MarketSharePercentageLow              
,Convert(numeric(18,2),isnull(MarketSharePercentageMedium,0)) As MarketSharePercentageMedium              
,Convert(numeric(18,2),isnull(MarketSharePercentageHigh,0)) As MarketSharePercentageHigh              
,Convert(numeric(18,2),isnull(NSPUnitsLow,0)) As NSPUnitsLow              
,Convert(numeric(18,2),isnull(NSPUnitsMedium,0)) As NSPUnitsMedium              
,Convert(numeric(18,2),isnull(NSPUnitsHigh,0)) As NSPUnitsHigh   
--,pd.Strength  
from PIDF_Commercial_Years PCY   
inner join PIDF_Commercial PC on PC.PIDFCommercialId = PCY.PIDFCommercialId  
--left join PIDFProductStrength pd on pd.PIDFID = pc.PIDFId  
where PC.PIDFId = @PIDFId  
and PCY.YearIndex =1   
  
  
END   

GO
/****** Object:  StoredProcedure [dbo].[ProcUpdateEmailNotificationMaster]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE proc [dbo].[ProcUpdateEmailNotificationMaster]
@NotificationId bigint,
@Success varchar(12) out
AS
BEGIN
  UPDATE Master_Notification
  set IsEmailSent=1,
      SentDatetime=GETDATE()
  WHERE NotificationId=@NotificationId
  set @Success='success'
  select @Success
END


GO
/****** Object:  StoredProcedure [dbo].[ProcUpdateParentTaskProgressByParentId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[ProcUpdateParentTaskProgressByParentId]
@ParentId int,
@TotalPercentage bigint,
@Success nvarchar(12) output
As
begin
declare @OldTotalPercentage bigint= (select cast(sum(TotalPercentage)/count(TotalPercentage) as bigint) TotalPercentage from ProjectTask where ParentId=@ParentId) --and ProjectTaskId=@ParentId)
--select TotalPercentage from ProjectTask where ParentId=@ParentId
update ProjectTask
set TotalPercentage=@OldTotalPercentage,
    ModifyDate=GETDATE()
where ProjectTaskId=@ParentId
set @Success='success';
select @Success
end
GO
/****** Object:  StoredProcedure [dbo].[RemovePIDF_Finance_BatchSizeCoatingById]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[RemovePIDF_Finance_BatchSizeCoatingById]
@PIDFFinaceBatchSizeCoatingId int,
@Success nvarchar(10)=null output
As
begin 

DELETE FROM PIDF_Finance_BatchSizeCoating where PIDFFinaceBatchSizeCoatingId=@PIDFFinaceBatchSizeCoatingId
set @Success='deleted';
select  @Success
end
GO
/****** Object:  StoredProcedure [dbo].[SaveUpdateEmailLogs]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from Master_EmailLog
Create PROC [dbo].[SaveUpdateEmailLogs]
@EmailLogId bigint=0,
@ToEmailAddress nvarchar(2000),
@Subject nvarchar(2000),
@SentSuccessfully bit=0
AS
BEGIN
if(not exists(select * from Master_EmailLog where EmailLogId=@EmailLogId))
BEGIN
  INSERT INTO Master_EmailLog
              (ToEmailAddress,Subject,SentSuccessfully)
         VALUES(@ToEmailAddress,@Subject,@SentSuccessfully)
END
else if(exists(select * from Master_EmailLog where EmailLogId=@EmailLogId))
BEGIN
UPDATE Master_EmailLog
SET ToEmailAddress=@ToEmailAddress,
    Subject=@Subject,
	SentSuccessfully=@SentSuccessfully,
	CreatedDate=GETDATE()
WHERE EmailLogId=@EmailLogId
END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_Fill_ddl_PBF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
-- =============================================  
-- Author:  <Author,,Name>  
-- Create date: <Create Date,,>  
-- Description: <Description,,>  
-- =============================================  
-- exec [SP_Fill_ddl_PBF] 14, 21  
CREATE     PROCEDURE [dbo].[SP_Fill_ddl_PBF]   
 @UserId int,  
 @selectedbusinessunit int,
 @PIDFId int  
AS  
BEGIN  
   
Select BusinessUnitId, BusinessUnitName from Master_BusinessUnit  
Where IsActive = 1  
  
Select BERequirementId, BERequirementName from Master_BERequirement  
Where IsActive = 1  
  
Select PlantId, PlantNameName from Master_Plant  
Where IsActive = 1  
  
Select WorkflowId, WorkflowName from Master_Workflow  
Where IsActive = 1  
  
Select DosageId, DosageName from Master_Dosage  
Where IsActive = 1  
  
Select FilingTypeId, FilingTypeName from Master_FilingType  
Where IsActive = 1  
  
Select FormRnDDivisionId, FormRnDDivisionName from Master_FormRnDDivision  
Where IsActive = 1  
  
Select PackagingTypeId, PackagingTypeName from Master_PackagingType  
Where IsActive = 1  
  
Select ManufacturingId, ManufacturingName from Master_Manufacturing  
Where IsActive = 1  
  
Select distinct A.CountryID, CountryName,E.BusinessUnitId from Master_Country As A  
INNER JOIN PIDFProductStrength_CountryMapping As F ON F.CountryId = A.CountryID    
 INNER JOIN PIDFProductStrength As E on E.PIDFProductStrengthId = F.PIDFProductStrengthId  
WHERE E.PIDFID = @PIDFId 
		AND (@selectedbusinessunit IS NULL OR E.BusinessUnitId =  @selectedbusinessunit)
		AND A.IsActive = 1       
 
Select ProductTypeId, ProductTypeName from Master_ProductType  
Where IsActive = 1  
  
Select TestLicenseId, TestLicenseName from Master_TestLicense  
Where IsActive = 1  
  
Select UserId, FullName from Master_User  
Where IsActive = 1 And IsDeleted = 0 And IsNUll(FormulationGL,0) = 1  
  
Select UserId, FullName from Master_User  
Where IsActive = 1 And IsDeleted = 0 And IsNUll(AnalyticalGL,0) = 1  
  
select top 1 MoleculeName,RFDBrand,RFDCountryId,RFDApplicant,RFDIndication from PIDF  
where PIDFID = @PIDFId  
  
select top 1 PatentStatus from PIDF_IPD  
where PIDFID = @PIDFId  
  
  
--Select PIDFProductStrengthId,Strength,B.UnitofMeasurementName  
--from PIDFProductStrength as A  
--inner join Master_UnitofMeasurement As B on A.UnitofMeasurementId = B.UnitofMeasurementId  
--Where PIDFId = @PIDFId
Select PIDFProductStrengthId, Strength, UnitofMeasurementName from(
Select PIDFProductStrengthId,Strength,B.UnitofMeasurementName
, ROW_NUMBER() OVER(Partition BY Strength, B.UnitofMeasurementName Order By PIDFProductStrengthId) As rowNumber, A.BusinessUnitId
from PIDFProductStrength as A  
inner join Master_UnitofMeasurement As B on A.UnitofMeasurementId = B.UnitofMeasurementId  
inner join Master_BusinessUnit As MB on A.BusinessUnitId=MB.BusinessUnitId
Where PIDFId = @PIDFId and MB.BusinessUnitId=@selectedbusinessunit) As A Where rowNumber = 1

  
Select TestTypeId, TestTypeName from Master_TestType  
Where IsActive = 1  
   
END  
GO
/****** Object:  StoredProcedure [dbo].[SP_Fill_ddl_PIDF]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- exec [SP_Fill_ddl_PIDF]
CREATE PROCEDURE [dbo].[SP_Fill_ddl_PIDF] 
	@UserId int
AS
BEGIN
	
	--Oral Master 
	Select OralId, OralName from [dbo].[Master_Oral] As Oral where IsActive=1
	
	--Unit Measurement
	Select UnitofMeasurementId, UnitofMeasurementName from [dbo].[Master_UnitofMeasurement] where IsActive=1
	
	--Dosage Form
	Select DosageFormId, DosageFormName from [dbo].[Master_DosageForm] where IsActive=1
	
	--Market Extension 
	Select MarketExtenstionId, MarketExtenstionName from [dbo].[Master_MarketExtenstion] where IsActive=1
	
	--Product packaging Type 
	Select PackagingTypeId, PackagingTypeName from [dbo].[Master_PackagingType] where IsActive=1
	
	--In Licenses
	Select BusinessUnitId, BusinessUnitName from [dbo].[Master_BusinessUnit] where IsActive=1
	And BusinessUnitId IN (Select BusinessUnitId from Master_UserBusinessUnitMapping Where UserId = @UserId)
	
	Select APISourcingId, APISourcingName from [dbo].[Master_APISourcing] where IsActive=1

	Select DIAId, DIAName from [dbo].[Master_DIA] where IsActive=1

	
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GetActiveBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_GetActiveBusinessUnit] 
	
AS
BEGIN
	Select BusinessUnitId, BusinessUnitName from Master_BusinessUnit
	Where IsActive = 1
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GetActiveBusinessUnitByUserid]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_GetActiveBusinessUnitByUserid] -- 1 
@Userid int
AS  
BEGIN  
 Select mb.BusinessUnitId , BusinessUnitName 
 from Master_BusinessUnit mb
 left join Master_UserBusinessUnitMapping mub on mb.BusinessUnitId = mub.BusinessUnitId
 Where IsActive = 1 and mub.UserId = @Userid
 order by  BusinessUnitId 
END 
GO
/****** Object:  StoredProcedure [dbo].[SP_GetCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_GetCountryByBusinessUnit] 
	@BusinessUnitId int,
	@UserId int
AS
BEGIN
	Select * from dbo.GetCountryByBusinessUnit(@BusinessUnitId, @UserId)
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GetCurrencyByUser]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_GetCurrencyByUser]   
(  
@UserId INT = 0   
)  
AS  
BEGIN  
 Select A.CurrencyID,A.CurrencyCode, A.CurrencyName from Master_Currency As A  
Inner Join Master_CurrencyCountryMapping As B On A.CurrencyId = B.CurrencyId  
Inner Join Master_UserCountryMapping As C On C.CountryId = B.CountryId  
Where C.UserId = @UserId And A.IsActive = 1  
UNION
SELECT A.CurrencyID,A.CurrencyCode, A.CurrencyName 
from Master_Currency As A  
Inner Join Master_CurrencyCountryMapping As B On A.CurrencyId = B.CurrencyId 
END
GO
/****** Object:  StoredProcedure [dbo].[SP_PIDF_UPDATE_CSV]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_PIDF_UPDATE_CSV] 
AS   
BEGIN  


--update Master_MarketExtenstion set MarketExtenstionName = 'NPL' where MarketExtenstionName = 'New'

--update Master_APISourcing set APISourcingName = 'Distributor' where APISourcingName = 'Out sourced'
--update Master_APISourcing set APISourcingName = 'In-House' where APISourcingName = 'In house'


   update a  
 set a.MarketExtenstionId = b.MarketExtenstionId 
    from PIDF a  
	inner join ExcelExportPIDF excel on excel.PIDFID = a.PIDFID
 inner join Master_MarketExtenstion b on excel.[Market Extension] = b.MarketExtenstionName;  


 
 --   update a  
 --set a.InHouses = b.APISourcingName 
 --   from PIDF a  
	--inner join ExcelExportPIDF excel on excel.PIDFID = a.PIDFID
 --inner join Master_APISourcing b on excel.[In house/ In-licensed] = b.APISourcingName;  

 end
GO
/****** Object:  StoredProcedure [dbo].[SpGetPIDF_PBF_General_RND]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[SpGetPIDF_PBF_General_RND] --0,147,80
(
@PbfRndDetailsId bigint =0,
@PidfId bigint =0,
@PbfId bigint =0,
@BusinessUnitId bigint=0
)
AS BEGIN
SELECT  
       PbfRndDetailsId
      ,PidfId
      ,PbfId
      ,RndResponsiblePerson
      , TypeOfDevelopmentDate
      ,PivotalBatchesManufacturedCompleted
      ,StabilityResultsDayZero
      ,StabilityResultsThreeMonth
      ,StabilityResultsSixMonth
      ,NonStandardProduct
      ,Pivotals
      ,BatchSizes
      ,NoMOfBatchesPerStrength
      ,SiteTransferDate
      ,ApiOrderedDate
      ,ApiReceivedDate
      ,FinalFormulationApproved
      ,CreatedOn
      ,UpdatedOn
      ,DeletedOn
      ,CreatedBy
  FROM PIDF_PBF_General_RND
  where (PbfRndDetailsId=@PbfRndDetailsId or @PbfRndDetailsId=0)
        AND PidfId=@PidfId
        AND (PbfId=@PbfId or @PbfId=0) AND BusinessUnitId=@BusinessUnitId

END
GO
/****** Object:  StoredProcedure [dbo].[std_npd_GetIsAlloeToApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[std_npd_GetIsAlloeToApprove]                            
(                  
@PIDFID INT = 0 ,
@USERID INT = 0  
)                          
AS                            
BEGIN  
	select  dbo.GetCanBeApprove(@PIDFID,@USERID)  
END
GO
/****** Object:  StoredProcedure [dbo].[std_npd_GetIsInterestedByPIDFandBU]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[std_npd_GetIsInterestedByPIDFandBU] (
@PIDFID int =0,
@BUID int =0
)as
begin

select * from [dbo].[GetBusinessUnitInterestedInPIDF](@PIDFID, @BUID)  


end
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_AfterApproveRejectActions]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_AfterApproveRejectActions @PIDFID=208, @StatusId =7           
CREATE   PROCEDURE [dbo].[stp_npd_AfterApproveRejectActions]                        
(            
	@PIDFID BIGINT,            
	@StatusId INT         
)                      
AS                        
BEGIN   
	IF (@StatusId = 3) 
	BEGIN
		 INSERT INTO PIDF_BusinessUnit (PIDFID, OralId, UnitofMeasurementId, DosageFormId, PackagingTypeId, BusinessUnitId,  BrandName, ApprovedGenerics, 
										LaunchedGenerics, RFDBrand,	RFDApplicant, RFDCountryId, RFDIndication, RFDInnovators, RFDInitialRevenuePotential,
										RFDPriceDiscounting, RFDCommercialBatchSize, CreatedDate, CreatedBy, ModifyDate, ModifyBy, MarketExtenstionId,
										DIAId, TradeNameRequired, TradeNameDate) 
		 SELECT PIDFID, OralId, UnitofMeasurementId, DosageFormId, PackagingTypeId, BusinessUnitId,  BrandName, ApprovedGenerics, 
						LaunchedGenerics, RFDBrand,	RFDApplicant, RFDCountryId, RFDIndication, RFDInnovators, RFDInitialRevenuePotential,
						RFDPriceDiscounting, RFDCommercialBatchSize, CreatedDate, CreatedBy, ModifyDate, ModifyBy, MarketExtenstionId,
						DIAId, TradeNameRequired, TradeNameDate
		 FROM dbo.PIDF  p
		 WHERE p.PIDFId = @PIDFID  
		 AND NOT EXISTS (SELECT TOP 1 1 FROM dbo.PIDF_BusinessUnit b WHERE b.PIDFID = p.PIDFID AND b.BusinessUnitId = p.BusinessUnitId)
	END

	IF (@StatusId = 7) 
	BEGIN
		 INSERT INTO PIDF_PBF_Reference_Product_detail (PIDFID, BusinessUnitId, RFDBrand, RFDApplicant, RFDCountryId, RFDIndication, RFDInnovators, 
														RFDInitialRevenuePotential, RFDPriceDiscounting, RFDCommercialBatchSize)
		 SELECT pb.PIDFId, pb.BusinessUnitId, pb.RFDBrand, pb.RFDApplicant, pb.RFDCountryId, pb.RFDIndication, pb.RFDInnovators, pb.RFDInitialRevenuePotential, pb.RFDPriceDiscounting,pb.RFDCommercialBatchSize
		 FROM  dbo.PIDF_BusinessUnit  pb
		 WHERE pb.PIDFId = @PIDFID
		 AND NOT EXISTS (SELECT TOP 1 1 FROM dbo.PIDF_PBF_Reference_Product_detail b WHERE b.PIDFID = pb.PIDFID AND b.BusinessUnitId = pb.BusinessUnitId) 
	END
END
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetAPIList]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetAPIList
CREATE PROCEDURE [dbo].[stp_npd_GetAPIList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
WHERE  U.IsActive = 1
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetAuditLogList]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from abctest
--Create Table dbo.abctest(CurrentPageNumber int, PageSize int, SortColumn varchar(100), SortDirection varchar(5), SearchText varchar(max))

-- exec stp_npd_GetAuditLogList @CurrentPageNumber =30, @PageSize = 10 @SearchText = 'Internal'   
CREATE   PROCEDURE [dbo].[stp_npd_GetAuditLogList]              
(  
@CurrentPageNumber INT = 0,                
@PageSize INT = 25,                
@SortColumn VARCHAR(100) = 'CreatedDate',                
@SortDirection VARCHAR(5) = 'Desc',                
@SearchText VARCHAR(MAX) =''    
)            
AS              
BEGIN        
    
SET NOCOUNT ON;    
Set @SearchText = IsNull(@SearchText, '')   


Select * from (        
SELECT Count(AuditLogId) OVER() TotalCount, * , ROW_NUMBER() OVER         
(        
ORDER BY         
  CASE WHEN @SortDirection <> 'DESC' THEN 'DESC'              
WHEN @SortColumn = 'ModuleName' THEN ModuleName         
END DESC               
,CASE              
WHEN @SortDirection <> 'ASC' THEN 'ASC'              
WHEN @SortColumn = 'ModuleName' THEN ModuleName    
END ASC     
, CASE              
WHEN @SortDirection <> 'DESC' THEN 'Desc'              
WHEN @SortColumn = 'ActionType' THEN ActionType    
END DESC               
,CASE              
WHEN @SortDirection <> 'ASC' THEN 'ASC'              
WHEN @SortColumn = 'ActionType' THEN ActionType    
END ASC  
,CASE              
WHEN @SortDirection <> 'DESC' THEN 'DESC'              
WHEN @SortColumn = 'CreatedBy' THEN CreatedBy              
END DESC    
,CASE              
WHEN @SortDirection <> 'ASC' THEN 'ASC'              
WHEN @SortColumn = 'CreatedBy' THEN CreatedBy              
END ASC   
,CASE              
WHEN @SortDirection <> 'DESC' THEN null              
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate         
END DESC   
,CASE              
WHEN @SortDirection <> 'ASC' THEN null              
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate              
END ASC         
)         
RowNumber from (        
SELECT     
    COUNT(u.AuditLogId) OVER() TotalRecord, U.AuditLogId, M.ModuleName,U.ActionType,U.[Log], U.CreatedDate as CreatedDate,us.FullName as CreatedBy
FROM Master_AuditLog As U   
Inner join Master_Module as M on M.ModuleId = U.ModuleId  
Inner join Master_User as us on us.UserId = u.CreatedBy   
)AS B WHERE           
(ModuleName LIKE '%' + @SearchText + '%'   
OR ActionType LIKE '%' + @SearchText + '%'    
OR CreatedBy LIKE '%' + @SearchText + '%'    
OR Cast(CreatedDate as Date) LIKE '%' + @SearchText + '%'  
)        
) As C Where         
RowNumber BETWEEN (@CurrentPageNumber) + 1 AND (@CurrentPageNumber) + @PageSize           

SET NOCOUNT OFF;    
           
END     
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetBusinessUnitByUserId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetBusinessUnitByUserId 14
CREATE PROCEDURE [dbo].[stp_npd_GetBusinessUnitByUserId]          
(
@UserId INT = 0
)        
AS          
BEGIN    

select bu.* FROM Master_User u 
inner join Master_UserBusinessUnitMapping map on u.UserId=map.UserId
inner join Master_BusinessUnit bu on bu.BusinessUnitId = map.BusinessUnitId
where u.UserId =@UserId and bu.IsActive=1
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCanBeApprove]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 --  exec [stp_npd_GetCanBeApprove] 175
CREATE   PROCEDURE [dbo].[stp_npd_GetCanBeApprove]              
(  
@PIDFID bigint
)            
AS              
BEGIN        
     
	 declare @IsInteresbucOUNT AS INT
	 declare @MasterBUCOunt AS INT
	 declare @PIDFOlderThan15daysCount AS INT

	 select @IsInteresbucOUNT =count(distinct A.BusinessUnitId) from PIDF_BusinessUnit_Interested A inner join
	 PIDF B on B.PIDFID = A.PIDFId
	 where A.PIDFID = 175

	 select @MasterBUCOunt=count(BusinessUnitId) from Master_BusinessUnit

 	 select @PIDFOlderThan15daysCount =count(PIDFID) from PIDF where StatusId =2 and StatusUpdatedDate < DATEADD(day,-15,getdate()) and PIDFID = 175
	 
	 if(	((@MasterBUCOunt=@IsInteresbucOUNT) and @IsInteresbucOUNT>0) or (@PIDFOlderThan15daysCount=1) )
	 begin
		select 1
	 end
	 else
	 begin
	 select 0
	 end

END     
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCommercialFormData]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetCommercialFormData 194,1          
CREATE PROCEDURE [dbo].[stp_npd_GetCommercialFormData]                        
(              
@PIDFId int,            
@UserId int            
)                      
AS                        
BEGIN                  
              
select PIDFCommercialId, PIDFId, BusinessUnitId,CountryId, PIDFProductStrengthId, MarketSizeInUnit, ShelfLife            
, A.PackSizeId, B.PackSizeName, B.PackSize            
from PIDF_Commercial As A            
Inner Join Master_PackSize As B On A.PackSizeId = B.PackSizeId            
Where PIDFId = @PIDFId and A.IsDeleted = 0          
            
select [PIDFCommercialYearId], A.PIDFCommercialId, YearIndex, PackagingTypeId, CurrencyId,            
[CommercialBatchSize], [PriceDiscounting], [TotalApireq], [Apireq], [Suimsvolume], [FreeOfCost],             
[MarketGrowth], [MarketSize], [PriceErosion], [FinalSelectionId], [MarketSharePercentageLow],             
[MarketSharePercentageMedium], [MarketSharePercentageHigh], [MarketShareUnitLow], [MarketShareUnitMedium],             
[MarketShareUnitHigh], [NspunitsLow], [NspunitsMedium], [NspunitsHigh], [NspLow], [NspMedium],             
[NspHigh], [BrandPrice], [GenericPrice],[TargetCostOfGood]            
, B.BusinessUnitId,B.CountryId,B.PIDFId, B.PIDFProductStrengthId, B.PackSizeId            
from PIDF_Commercial_years As A            
Inner Join PIDF_Commercial As B On A.PIDFCommercialId = B.PIDFCommercialId            
Where PIDFId = @PIDFId and B.IsDeleted = 0 order by PIDFCommercialId,YearIndex         
        
            
Select Strength, C.UnitofMeasurementName, A.PIDFProductStrengthId, A.BusinessUnitId from PIDFProductStrength As A            
Inner Join PIDF As B On A.PIDFId = B.PIDFId            
Inner Join Master_UnitofMeasurement As C On C.UnitofMeasurementId = A.UnitofMeasurementId            
Where A.PIDFId = @PIDFId            
            
Select StatusId,InHouses from PIDF             
Where PIDFID = @PIDFId            
            
Select BusinessUnitId, BusinessUnitName from Master_BusinessUnit            
Where IsActive = 1            
            
exec SP_GetCurrencyByUser @UserId            
            
Select PackagingTypeId, PackagingTypeName from Master_PackagingType            
Where IsActive = 1            
            
Select PackSizeId, PackSizeName, PackSize from Master_PackSize            
Where IsActive = 1            
            
Select FinalSelectionId, FinalSelectionName from Master_FinalSelection            
Where IsActive = 1            
            
select Remark,Interested,BusinessUnitId,PIDFID,CountryId from PIDF_Commercial_Master where PIDFID =  @PIDFId      
                       
-------------------Get PBFOutsource data-------------------------    
select PPO.PIDFID,MPWorkFlow.PBFWorkFlowName,MPWorkFlow.PBFWorkflowId,PPO_Task.PBFWorkFlowTaskName,PPO_Task.Cost,PPO.ProjectWorkflowId,    
PPO_Task.Tentative,MPO_Task.TaskLevel,MPO_Task.ParentId      
from PIDF_PBF_Outsource PPO       
left join PIDF_PBF_Outsource_Task PPO_Task on PPO.PIDFPBFOutsourceId = PPO_Task.PIDFPBFOutsourceId       
left join Master_PBFWorkflow_Task MPO_Task on MPO_Task.PBFWorkFlowTaskName = PPO_Task.PBFWorkFlowTaskName      
left join Master_PBFWorkFlow MPWorkFlow on MPWorkFlow.PBFWorkflowId = PPO.PBFWorkflowId      
      
where PPO.PIDFID = @PIDFId   -- and    
 --PPO.PBFWorkflowId = @PBFWorkflowId     
order by MPO_Task.TaskLevel      
-----------------------------------------------------------------------------------------------------------------------    
-----if any chnage made here, nned to same chnage in FUNCTION -->[dbo].[GetCountryForBusinessUnitAndPIDF] ---------------------    
Select DISTINCT A.CountryId, CountryName,C.BusinessUnitId,E.PIDFProductStrengthId,E.Strength,MU.UnitofMeasurementName from Master_Country As A      
Inner Join Master_RegionCountryMapping As B On A.CountryID = B.CountryId      
Inner Join Master_BusinessUnitRegionMapping As C On C.RegionId = B.RegionId --And C.BusinessUnitId = @BusinessUnitId
--Inner Join PIDF As D On D.BusinessUnitId = C.BusinessUnitId And D.PIDFID = @PIDFId     
Inner Join PIDFProductStrength As E On E.BusinessUnitId = C.BusinessUnitId And E.PIDFID = @PIDFId     
Inner Join PIDFProductStrength_CountryMapping As F ON F.PIDFProductStrengthId = E.PIDFProductStrengthId  and F.CountryId = A.CountryID
--------this addition join for Unit of Measurment
Inner Join Master_UnitofMeasurement As MU On MU.UnitofMeasurementId = E.UnitofMeasurementId  
Where A.IsActive = 1      
------------------------------------------------------------------------------------------    
    
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCommercialPIDFList]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec [stp_npd_GetCommercialPIDFList]
CREATE PROCEDURE [dbo].[stp_npd_GetCommercialPIDFList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, ME.MarketExtenstionName as marketExtension,
U.ApprovedGenerics, U.LaunchedGenerics, U.RFDApplicant as applicant, MC.CountryName as country, MD.DIAName as diaName,
c.CountryName as CountryName,P.PackagingTypeName as PackagingTypeName,U.RFDIndication as inidication,
transformFormRandDDivision = null,previousProjectCode = null, sinkCost = null,
us.FullName as CreatedBy, ps.PIDFStatus as status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_MarketExtenstion ME on ME.MarketExtenstionId = U.MarketExtenstionId
left join Master_Country as MC on MC.CountryID = U.RFDCountryId
left join Master_DIA as MD on MD.DIAId = U.DIAId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId
WHERE  U.IsActive = 1 and ps.PIDFStatusID=7 --(status =7 [IPD approved] for Commercial)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryByRegion]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetCountryByRegion 0, '31,32,33'  
CREATE PROCEDURE [dbo].[stp_npd_GetCountryByRegion]            
(  
@UserId INT = 0,  
@RegionIds varchar(max)  
)          
AS            
BEGIN      
  
select distinct A.CountryID, A.CountryName from Master_Country As A  
Inner Join Master_RegionCountryMapping As B On A.CountryID = B.CountryId  
Where A.IsActive = 1 And B.RegionId in (SELECT CAST(value AS INT) FROM string_split(@RegionIds, ','))  
  
END   
  
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryByUserId]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetBusinessUnitByUserId 14
CREATE PROCEDURE [dbo].[stp_npd_GetCountryByUserId]          
(
@UserId INT = 0
)        
AS          
BEGIN    

select bu.* FROM Master_User u 
inner join Master_UserCountryMapping map on u.UserId=map.UserId
inner join Master_Country bu on bu.CountryID = map.CountryId
where u.UserId =@UserId and bu.IsActive=1
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetCountryListByIsInterested]    Script Date: 11/16/2023 4:01:50 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[stp_npd_GetCountryListByIsInterested](      
@PIDFID Bigint=0   ,
@BUId int=0     
)      
as      
begin      
      
select * from  dbo.GetCountryForBusinessUnitAndPIDF(@PIDFID,@BUId)    
      
  end 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetDepartmentCountryByBusinessUnit]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetDepartmentCountryByBusinessUnit 0, 32
CREATE PROCEDURE [dbo].[stp_npd_GetDepartmentCountryByBusinessUnit]          
(
@UserId INT = 0,
@BusinessUnitId int = 0
)        
AS          
BEGIN    

select A.DepartmentId, A.DepartmentName from Master_Department As A
Inner Join Master_DepartmentBusinessUnitMapping As B On A.DepartmentId = B.DepartmentId
Where A.IsActive = 1 And B.BusinessUnitId = @BusinessUnitId

Select A.CountryID, CountryName from Master_Country As A
Inner Join Master_BusinessUnitCountryMapping As B On A.CountryID = B.CountryId
Where A.IsActive = 1 And B.BusinessUnitId = @BusinessUnitId

END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetFinancePIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFList
CREATE PROCEDURE [dbo].[stp_npd_GetFinancePIDFList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName,P.PackagingTypeName as ProductPackagingName,
us.FullName as CreatedBy,U.BusinessUnitId, ps.PIDFStatus as status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId

WHERE  U.IsActive = 1 and ps.PIDFStatusID in (7,11) --( for IPD/BD Approved && Finance Rejected)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDDetailByPIDF]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec [stp_npd_GetIPDDetailByPIDF] 134     
CREATE   PROCEDURE [dbo].[stp_npd_GetIPDDetailByPIDF]         
 @PIDFId int         
AS        
BEGIN        
 select B.IPDID, A.MoleculeName As ProjectName, B.MarketName, B.DataExclusivity, B.FillingType, B.ApprovedGenetics, B.LaunchedGenetics        
 , B.LegalStatus, B.CostOfLitication, B.Comments,B.Innovators, B.PatentStatus        
 , STUFF((SELECT ', ' + y.CountryName FROM PIDF_IPD_Country x         
 Inner Join Master_Country y on x.CountryId = y.CountryID        
 WHERE x.IPDID = B.IPDID FOR XML PATH('')), 1, 2, '') As Country,        
 C.BusinessUnitName        
 from PIDF As A        
 Inner JOin PIDF_IPD As B On A.PIDFID = B.PIDFID        
 Inner Join Master_BusinessUnit As C On C.BusinessUnitId = B.BusinessUnitId        
 Where A.PIDFId = @PIDFId        
        
 select B.IPDID, C.BusinessUnitName, A.PatentNumber, A.Type, A.OriginalExpiryDate, A.ExtensionExpiryDate,        
 A.Comments, A.Strategy,A.PatentType  
, [BasicPatentExpiry]      
, [OtherLmitingPatentDate1]    
, [OtherLmitingPatentDate2]    
, [EarliestLaunchDate]     
, [AnyPatentstobeFiled]     
, [EarliestMarketEntry]     
, [stimatedNumberofgenericsinthe]   
, [Lawfirmbeingused]      
, country.CountryName as CountryName,  
 (
 A.PatentStrategyOther
 --case when A.PatentStrategy = 6 then A.PatentStrategyOther   
 -- when A.PatentStrategy < 6 then (select PatentStrategyName from Master_Patent_Strategy where PatentStrategyID = A.PatentStrategy)  
 --end  
 ) 
 as PatentStrategyName  
 from PIDF_IPD_PatentDetails As A        
 Inner JOin PIDF_IPD As B On A.IPDID = B.IPDID        
 Inner Join Master_BusinessUnit As C On C.BusinessUnitId = B.BusinessUnitId   
 left join Master_Country country on country.CountryID = A.CountryId  
 Where B.PIDFId = @PIDFId        
        
 Select MoleculeName As ProjectName from PIDF        
 Where PIDFID = @PIDFId        
END
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDManagementPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFList
CREATE PROCEDURE [dbo].[stp_npd_GetIPDManagementPIDFList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName,P.PackagingTypeName as ProductPackagingName,
us.FullName as CreatedBy, ps.PIDFStatus as status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId

WHERE  U.IsActive = 1 and ps.PIDFStatusID in (5,3,6,8) --(for PIDF Approved,IPD Created,IPD/BD Pending Approval,IPD/BD Rejected)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIpdPatentDetailsBUssinessUnitWiseCountryList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec stp_npd_GetIpdPatentDetailsBUssinessUnitWiseCountryList 5
CREATE proc [dbo].[stp_npd_GetIpdPatentDetailsBUssinessUnitWiseCountryList](
@BUID int=0
)
as
begin
SELECT CountryID,CountryName from Master_Country where IsActive =1 
  end
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIPDPatentDetailsCountryList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 --exec stp_npd_GetIPDPatentDetailsCountryList 5    
CREATE proc [dbo].[stp_npd_GetIPDPatentDetailsCountryList](    
@BUId int=0    
)    
as    
begin    
    
Select DISTINCT A.CountryId, CountryName from Master_Country As A    
Inner Join Master_RegionCountryMapping As B On A.CountryID = B.CountryId    
Inner Join Master_BusinessUnitRegionMapping As C On B.RegionId = C.RegionId    
Where C.BusinessUnitId = @BUId   AND A.IsActive =1    
    
  end 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetIpdPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetIpdPIDFList  
CREATE   PROCEDURE [dbo].[stp_npd_GetIpdPIDFList]            
(  
@StatusId INT=3,
@CurrentPageNumber INT = 0,              
@PageSize INT = 25,              
@SortColumn VARCHAR(100) = 'PIDFNO',              
@SortDirection VARCHAR(5) = 'ASC',              
@SearchText VARCHAR(MAX) =''  
)          
AS            
BEGIN      
  
SET NOCOUNT ON;  
Set @SearchText = IsNull(@SearchText, '')  
SELECT Count(PIDFID) OVER() TotalCount, * from (  
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER   
(  
ORDER BY   
   
CASE            
WHEN @SortDirection <> 'DESC' THEN 'DESC'            
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo       
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN 'ASC'            
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo  
END ASC   
, CASE            
WHEN @SortDirection <> 'DESC' THEN 'Desc'            
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName  
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN 'ASC'            
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName  
END ASC   
, CASE            
WHEN @SortDirection <> 'DESC' THEN null            
WHEN @SortColumn = 'BrandName' THEN U.BrandName        
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'BrandName' THEN U.BrandName            
END ASC  
, CASE            
WHEN @SortDirection <> 'DESC' THEN null            
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName        
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName            
END ASC  
,CASE            
WHEN @SortDirection <> 'DESC' THEN null            
WHEN @SortColumn = 'PackagingTypeName' THEN P.PackagingTypeName       
END DESC 
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'PackagingTypeName' THEN P.PackagingTypeName            
END ASC  
, CASE            
WHEN @SortDirection <> 'DESC' THEN null            
WHEN @SortColumn = 'ApprovedGenerics' THEN U.ApprovedGenerics       
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'ApprovedGenerics' THEN U.ApprovedGenerics            
END ASC 
,CASE            
WHEN @SortDirection <> 'DESC' THEN null            
WHEN @SortColumn = 'LaunchedGenerics' THEN U.LaunchedGenerics       
END DESC             
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'LaunchedGenerics' THEN U.LaunchedGenerics            
END ASC 
,CASE            
WHEN @SortDirection <> 'ASC' THEN null            
WHEN @SortColumn = 'CreatedBy' THEN us.FullName            
END ASC  
)   
RowNumber,PIDFID,u.BusinessUnitId, PIDFNo,MoleculeName,BrandName,DF.DosageFormName, P.PackagingTypeName,  ME.MarketExtenstionName as marketExtension,
U.ApprovedGenerics, U.LaunchedGenerics, U.RFDApplicant as applicant, MC.CountryName as country, MD.DIAName as diaName,
MC.CountryName as countryName,P.PackagingTypeName as ProductPackagingName,U.RFDIndication as inidication,
transformFormRandDDivision = null,previousProjectCode = null, sinkCost = null,
us.FullName as CreatedBy, ps.PIDFStatus as status  
FROM PIDF As U  
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId  
left join Master_MarketExtenstion ME on ME.MarketExtenstionId = U.MarketExtenstionId
left join Master_Country as MC on MC.CountryID = U.RFDCountryId
left join Master_DIA as MD on MD.DIAId = U.DIAId
left join Master_User as us on us.UserId = u.CreatedBy  
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId
WHERE  U.IsActive = 1 --AND U.StatusId= @StatusId
)AS B WHERE     
(BrandName LIKE '%' + @SearchText + '%'         
OR PIDFNo LIKE '%' + @SearchText + '%')  
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize     
     
SET NOCOUNT OFF;  
           
END   
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetManagementPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFList
CREATE PROCEDURE [dbo].[stp_npd_GetManagementPIDFList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName,P.PackagingTypeName as ProductPackagingName,
us.FullName as CreatedBy,U.BusinessUnitId, ps.PIDFStatus as status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId

WHERE  U.IsActive = 1 and ps.PIDFStatusID in (10,11) --(for Finance Approved && Finance Rejected)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetModulePermissionRefByRoleId]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[stp_npd_GetModulePermissionRefByRoleId]            
(  
@RoleId INT = 0
)          
AS            
BEGIN      
  
SET NOCOUNT ON;  

SELECT rm.roleId,rm.ModuleId,rm.SubModuleId,m.ModuleName,s.SubModuleName from dbo.RoleModulePermission rm INNER JOIN Master_Module m ON rm.ModuleId=m.ModuleId
LEFT JOIN Master_SubModule s ON s.SubModuleId=rm.SubModuleId WHERE rm.RoleId=@RoleId

SET NOCOUNT OFF;  
           
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetNotificationList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetNotificationList @UserId = 14,  @PageSize = 10, @CurrentPageNumber = 0  
CREATE PROCEDURE [dbo].[stp_npd_GetNotificationList]                    
(          
@UserId int,          
@CurrentPageNumber INT = 0,                      
@PageSize INT = 25,                      
@SortColumn VARCHAR(100) = 'CreatedDate',                      
@SortDirection VARCHAR(5) = 'DESC',                      
@SearchText VARCHAR(MAX) =''          
)                  
AS                    
BEGIN              
          
SET NOCOUNT ON;    
declare @pendingNotification int = (Select count(*) from Master_Notification    
Where CreatedDate > (select top 1 UpdateDate from Master_Notification_User Where UserId = @UserId))    
    
Set @SearchText = IsNull(@SearchText, '')      
  
Select * from (          
SELECT Count(NotificationId) OVER() TotalCount, * , ROW_NUMBER() OVER           
(    
ORDER BY           
CASE                    
WHEN @SortDirection <> 'DESC' THEN 0                    
WHEN @SortColumn = 'NotificationId' THEN  NotificationId                     
END DESC                     
,CASE                    
WHEN @SortDirection <> 'ASC' THEN 0                    
WHEN @SortColumn = 'NotificationId' THEN NotificationId          
END ASC           
, CASE                    
WHEN @SortDirection <> 'DESC' THEN null                    
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate                
END DESC                     
,CASE                    
WHEN @SortDirection <> 'ASC' THEN null                    
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate                    
END ASC          
)           
RowNumber from (          
SELECT  COUNT(u.NotificationId) OVER() TotalRecord, NotificationId, P.PIDFNO + ' ('+P.MoleculeName+')'+' updated with status '+ MPS.PIDFStatus +'' + ' By ' + us.FullName As NotificationTitle,          
P.PIDFNO+' updated with status <br/>'+ MPS.PIDFStatus +'' As NotificationTitleView, U.CreatedDate, MPS.StatusColor, P.PIDFNO as PidfNo,us.FullName as CreatedByName         
FROM Master_Notification As U          
Left Join PIDF As P ON U.PIDFId = P.PIDFId          
Left Join Master_PIDFStatus As MPS ON MPS.PIDFStatusID = U.StatusId       
left join Master_User as us on us.UserId = u.CreatedBy       
	--where MPS.PIDFStatusID in   
	--(select MPS.PIDFStatusID from Master_User u inner join RoleModulePermission RMP on RMP.RoleId = u.RoleId  
	--inner join Master_PIDFStatus MPS on MPS.ModuleId = RMP.ModuleId  
	--where u.UserId = @UserId and (RMP.[View] =1 or RMP.[Add] =1 or RMP.[Edit] = 1 or RMP.[Delete] =1))
)  
AS B WHERE             
(NotificationTitle LIKE '%' + @SearchText + '%')) As C          
Where RowNumber BETWEEN (@CurrentPageNumber) + 1 AND (@CurrentPageNumber) + @PageSize          
             
SET NOCOUNT OFF;          
                   
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPatentDetails]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- exec stp_npd_GetPatentDetails
CREATE procedure [dbo].[stp_npd_GetPatentDetails]  
as  
begin  
   Select * from PIDF_IPD_PatentDetails Order By PatentNumber Asc;
End  
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPatentDetailsById]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- exec stp_npd_GetPatentDetailsById
CREATE procedure [dbo].[stp_npd_GetPatentDetailsById]  
(
@IPDID INT
)
as  
begin  
   select * from PIDF_IPD pd join PIDF_IPD_PatentDetails pid
   on pd.IPDID = pid.IPDID
   order by pd.IPDID asc;
End  
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPbfAllTabData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPbfAllTabData @PIDFID=227,@BUId =2            
CREATE PROCEDURE [dbo].[stp_npd_GetPbfAllTabData]                        
(            
@PIDFID bigint = 0,            
@BUId bigint = 0            
)                      
AS                        
BEGIN                  
            
           
 -------find PIDFPBF Id by PIDF Id            
             
Declare @PIDFPBFId int = (Select top 1 PIdfPBFId from PIDF_PBF Where PIDFId = @PIDFId)        
Declare @PBFGeneralId int = (Select top 1 PBFGeneralId from PIDF_PBF_General Where PIDFPBFId = @PIDFPBFId and BusinessUnitId=@BUId)        
        
Select TestTypeId, TestTypeName, TestTypeCode, TestTypePrice from Master_TestType        
Where IsActive = 1        
        
Select PackingTypeId, PackingTypeName, PackingCost, Unit from Master_PackingType        
Where IsActive = 1        
        
Select BatchSizeNumberId, BatchSizeNumberName from Master_BatchSizeNumber        
Where IsActive = 1        
        
Select BusinessUnitId, BusinessUnitName from Master_BusinessUnit        
Where IsActive = 1        
        
  
  
select DISTINCT PBFGeneralId, StrengthId, ProjectCode, ImprintingEmbossingCode        
from PIDF_PBF_General_Strength where PBFGeneralId = @PBFGeneralId        
        
-- Clinical tables        
select PIDF_PBF_Clinical.PBFGeneralId, StrengthId, BioStudyTypeId, FastingOrFed, NumberofVolunteers, ClinicalCostAndVolume,         
BioAnalyticalCostAndVolume, DocCostandStudy,PBF_G.BEStudyResults from PIDF_PBF_Clinical      
left join PIDF_PBF_General PBF_G on PIDF_PBF_Clinical.PBFGeneralId=PBF_G.PBFGeneralId
Where PIDF_PBF_Clinical.PBFGeneralId = @PBFGeneralId   
--select BEStudyResults from PIDF_PBF_General    
--Where PBFGeneralId = @PBFGeneralId   
        
-- analyticals tables        
select A.PBFGeneralId, A.StrengthId,A.TestTypeId, A.ActivityTypeId, A.Numberoftests, A.PrototypeDevelopment, A.CostPerTest,         
A.PrototypeCost        
from PIDF_PBF_Analytical as A         
Where A.PBFGeneralId = @PBFGeneralId        
        
--analytical cost and strength mapping        
Select A.TotalAMVCost,A.TotalAMVTitle,A.Remark,B.StrengthId,B.IsChecked        
from PIDF_PBF_Analytical_AMVCost As A        
left join PIDF_PBF_Analytical_AMVCost_StrengthMapping B on A.TotalAMVCostId = B.TotalAMVCostId        
Where PBFGeneralId = @PBFGeneralId        
        
        
-- rnd tables        
select PBFGeneralId, BatchSizeId, APIRequirementMarketPrice, PlanSupportCostRsPerDay, ManHourRate,PlantId,LineId,APIRequirementVendorName from PIDF_PBF_RnD_Master        
Where PBFGeneralId = @PBFGeneralId        
        
select PIDFPBFRNDExicipientId,PBFGeneralId, StrengthId, ActivityTypeId, ExicipientPrototype, ExicipientDevelopment, RsPerKg,         
MgPerUnitDosage from PIDF_PBF_RnD_ExicipientRequirement        
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, ActivityTypeId, PackingTypeId, UnitOfMeasurement,PackagingDevelopment, RsPerUnit,         
Quantity from PIDF_PBF_RnD_PackagingMaterial        
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, PrototypeFormulation, ScaleUpbatch,ExhibitBatch1, ExhibitBatch2,         
ExhibitBatch3,salt from PIDF_PBF_Rnd_BatchSize       
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, Prototype, ScaleUp,ExhibitBatch1, ExhibitBatch2,         
ExhibitBatch3,PrototypeCost,ScaleUpCost,ExhibitBatchCost,TotalCost from PIDF_PBF_RnD_APIRequirement        
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, ActivityTypeId, Prototype, StrengthUnitQuantity,Cost        
 from PIDF_PBF_RnD_ToolingChangepart        
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, ActivityTypeId, MiscellaneousDevelopment,StrengthMiscellaneousExpense from PIDF_PBF_RnD_CapexMiscellaneousExpenses        
Where PBFGeneralId = @PBFGeneralId        
        
        
select PBFGeneralId, StrengthId, ScaleUp, Exhibit        
from PIDF_PBF_RnD_PlantSupportCost        
Where PBFGeneralId = @PBFGeneralId        
        
        
select PBFGeneralId, StrengthId, UnitCostOfReferenceProduct, FormulationDevelopment,PilotBE,PharmasuiticalEquivalence        
,PivotalBio,TotalCost from PIDF_PBF_RnD_ReferenceProductDetail        
Where PBFGeneralId = @PBFGeneralId        
        
select PBFGeneralId, StrengthId, BusinessUnitId, IsChecked,TotalCost from PIDF_PBF_RnD_FillingExpenses        
Where PBFGeneralId = @PBFGeneralId        
        
Select A.ProjectActivitiesId, A.ProjectActivitiesName,        
B.DurationInDays , B.ManPowerInDays         
from Master_ProjectActivities A        
Left Join PIDF_PBF_RnD_ManPowerCost B        
ON A.ProjectActivitiesId = B.ProjectActivitiesId        
And B.PBFGeneralId = @PBFGeneralId        
        
Select CostOfLitication, BusinessUnitId,([dbo].[GetCurrencySymbol](@PIDFId)) As CurrencySymbol from PIDF_IPD        
Where PIDFId = @PIDFId        
        
Select A.ProjectActivitiesId, A.ProjectActivitiesName,        
isnull(B.Prototype,'') [Prototype] , isnull(B.ScaleUp,'') [ScaleUp], isnull(B.Exhibit,'') [Exhibit]        
from Master_HeadWiseBudgetActivities A        
Left Join PIDF_PBF_HeadWiseBudget B        
ON A.ProjectActivitiesId = B.ProjectActivitiesId        
And B.PBFGeneralId = @PBFGeneralId        
      
      
select * from PIDF_PBF_Reference_Product_detail where BusinessUnitId = @BUId and  PIDFID = @PIDFID   
  
select ExcipientRequirementId,ExcipientRequirementName,ExcipientRequirementCost from Master_ExcipientRequirement  
where IsActive =1  

select [FeasabilityCumTotalDate]
      ,[PrototypeCumTotalDate]
      ,[ScaleUpCumTotalDate]
      ,[AMVCumTotalDate]
      ,[ExhibitCumTotalDate]
      ,[FilingCumTotalDate]
  FROM [dbo].[PIDF_PBF_PhaseWiseBudget] where PBFGeneralId=@PBFGeneralId
        
END
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFAPIPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPBFAPIPIDFList
CREATE PROCEDURE [dbo].[stp_npd_GetPBFAPIPIDFList] 
					--			  PBFAPIPIDF
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName,P.PackagingTypeName,
us.FullName as CreatedBy,U.BusinessUnitId, ps.PIDFStatus as Status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId

WHERE  U.IsActive = 1 and ps.PIDFStatusID=7 --(status =7 for IPD/BD Approved)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPbfData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPbfData @PIDFID=397,@BUSINESSUNITId =4       
CREATE     PROCEDURE [dbo].[stp_npd_GetPbfData]                  
(      
@PIDFID bigint = 0,      
@BUSINESSUNITId bigint = 0      
)                
AS                  
BEGIN            
      
 declare @PIDFPBFId as bigint       
 declare @PBFGeneralId as bigint   
 declare @OralName as nvarchar(30)  
 declare @TradeDressProposalId as bigint      
 --declare @StrengthId as bigint   
   
  -------find PIDFId by PIDF Id    
  select @OralName = MO.OralName from PIDF   
 inner join Master_Oral as MO on MO.OralId = pidf.OralId  
 where pidf.PIDFID = @PIDFID  
 --PBF Object  
  
 -------find PIDFPBF Id by PIDF Id      
 select @PIDFPBFId=PIDFPBFId from PIDF_PBF where PIDFID= @PIDFID       
 select @PBFGeneralId = PBFGeneralId from PIDF_PBF_General where PIDFPBFId= @PIDFPBFId and BusinessUnitId=@BUSINESSUNITId      
 select top 1 @TradeDressProposalId=TradeDressProposalId from dbo.pbf_general_TDP TDP where PIDFID= @PIDFID         
 --select @PIDFPBFId,@PBFAnalyticalId,@PBFClinicalId      
      
  --------------------Table[0]--PBF Object---------------      
 select       
 PBF.[PIDFPBFId]       
 ,PBF.[PIDFId]       
 ,PBF.[ProjectName]       
 ,PBF.[BusinessRelationable]       
 ,PBF.[BERequirementId]       
 ,PBF.[NumberOfApprovedANDA]       
 ,PBF.[ProductTypeId]       
 ,PBF.[PlantId]       
 ,PBF.[WorkflowId]       
 ,PBF.[DosageId]      
 ,PBF.[PatentStatus]      
 ,PBF.[SponsorBusinessPartner]       
 ,PBF.[FillingTypeId]      
 ,PBF.[ScopeObjectives]       
 ,PBF.[FormRnDDivisionId]       
 ,PBF.[ProjectInitiationDate] 
 ,PBF.[BatchManifacturingDate]
	 ,PBF.[FillingDateDate]
 ,PBF.[RnDHead]       
 ,PBF.[ProjectManager]      
 ,PBF.[PackagingTypeId]        
 ,PBF.[ManufacturingId]    
 ,PBG_G.[PBFGeneralId]      
 ,PBG_G.[PIDFPBFID]       
 ,PBG_G.[BusinessUnitId]      
 ,PBG_G.[Capex]       
 ,PBG_G.[TotalExpense]       
 ,PBG_G.[ProjectComplexity]       
 ,PBG_G.[ProductTypeId] as GeneralProductTypeId      
 ,PBG_G.[TestLicenseAvailability]       
 ,PBG_G.[BudgetTimelineSubmissionDate]       
 ,PBG_G.[ProjectDevelopmentInitialDate]       
 ,PBG_G.[FormulationGLId]      
 --,PBG_G.[StrengthId]       
 ,PBG_G.[AnalyticalGLId]  
 ,PIDF.StatusId  
 ,TDP.Approch  
 ,TDP.FormulaterResponsiblePerson  
 --,PBG_G.[CreatedDate]       
 ,STUFF((SELECT ',' + cast(BusinessUnitId as nvarchar)  
           FROM PIDF_PBF_MarketMapping b     
           WHERE PIDFPBFId=PBF.PIDFPBFId    
          FOR XML PATH('')), 1, 1, '') as MarketIds  
 from PIDF_PBF as PBF   
 inner join PIDF on PBF.PIDFId=PIDF.PIDFID  
  inner join dbo.pbf_general_TDP TDP on TDP.TradeDressProposalId=@TradeDressProposalId  
 Left join PIDF_PBF_General as PBG_G on PBG_G.PIDFPBFID = PBF.PIDFPBFId and  PBG_G.PBFGeneralId = @PBFGeneralId      
 where PBF.PIDFId = @PIDFID     
  
      
 --------------------Table[1]--PBF General Strength Object---------------      
 select * from PIDF_PBF_General_Strength where PBFGeneralId=@PBFGeneralId    
   
  --------------------Table[2]--PIDF Object---------------      
 select @OralName [OralName]    
  
END
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFOutsourceData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
 -- exec stp_npd_GetPBFOutsourceData 1

CREATE proc [dbo].[stp_npd_GetPBFOutsourceData]   
 @PBFWorkFlowID int =0    
 as  
 begin  
  
 select	MPWorkFlow.PBFWorkflowId,MPWorkFlow.PBFWorkFlowName,MPO_Task.PBFWorkFlowTaskName,MPO_Task.TaskLevel,MPO_Task.ParentId  
from   
Master_PBFWorkflow_Task MPO_Task 
inner join Master_PBFWorkFlow MPWorkFlow on MPWorkFlow.PBFWorkflowId = MPO_Task.PBFWorkflowId  
where MPO_Task.PBFWorkflowId = @PBFWorkFlowID
order by MPO_Task.TaskLevel  
  
 end

GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFOutsourceWorkflowTask]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
  --	exec [stp_npd_GetPBFOutsourceWorkflowTask] 135,1

CREATE proc [dbo].[stp_npd_GetPBFOutsourceWorkflowTask]   
 @PIDFID bigint =0,
 @PBFWorkflowId int =0  
 as  
 begin  
  
 select PPO.PIDFID,MPWorkFlow.PBFWorkFlowName,MPWorkFlow.PBFWorkflowId,PPO_Task.PBFWorkFlowTaskName,PPO_Task.Cost,PPO_Task.Tentative,MPO_Task.TaskLevel,MPO_Task.ParentId  
from PIDF_PBF_Outsource PPO   
right join PIDF_PBF_Outsource_Task PPO_Task on PPO.PIDFPBFOutsourceId = PPO_Task.PIDFPBFOutsourceId   
inner join Master_PBFWorkflow_Task MPO_Task on MPO_Task.PBFWorkFlowTaskName = PPO_Task.PBFWorkFlowTaskName  
left join Master_PBFWorkFlow MPWorkFlow on MPWorkFlow.PBFWorkflowId = PPO.PBFWorkflowId  
  
where PPO.PIDFID = @PIDFID   and
 PPO.PBFWorkflowId = @PBFWorkflowId 
order by MPO_Task.TaskLevel 
  
 end
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPBFRADates]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
 
--[dbo].[stp_npd_GetPBFRADates]     148,2,94,2,'20230807' 
CREATE PROCEDURE [dbo].[stp_npd_GetPBFRADates]    
(              
@PIDFId int,
@BusinessUnitId int,
@CountryId int,
@TypeOfSubmissionId int = null,
@DossierReadyDate datetime= null,
@PivotalBatchManufactured datetime = null,
@LastDataFromRnD datetime = null,
@BEFinalReport datetime = null,
@UserId INT = 0,
@SMStabilityResultsSixMonth datetime=null
)                      
AS                        
BEGIN        
	DECLARE @today DATETIME = GETDATE();
	DECLARE @EarliestLaunchDate DateTime = @today, @EndOfProcedureDate DateTime = @today, @CountryApprovalDate DateTime = @today,
			@LastDateToRegulatory DateTime, @EarliestSubmissionDate DateTime,
			@TypeSubmissionEOP INT, @NationApprovalEOP int

	DECLARE @StabilityResultsSixMonth DATETIME = (SELECT TOP 1 StabilityResultsSixMonth FROM PIDF_PBF_General_RND WHERE PidfId = @PIDFId);
	
	SELECT TOP 1 @TypeSubmissionEOP = ISNULL(MaxEOP, MinEOP) 
	FROM Master_TypeOfSubmission WHERE Id = @TypeOfSubmissionId;
	
	SELECT TOP 1 @NationApprovalEOP = ISNULL(MaxEOP, MinEOP) 
	FROM Master_NationApproval As A JOIN Master_NationApproval_CountryMapping As B On A.NationApprovalId = B.NationApprovalId
										Where B.CountryId = @CountryId 

	SET @StabilityResultsSixMonth = COALESCE(@StabilityResultsSixMonth, @SMStabilityResultsSixMonth, @today)
	SET @LastDataFromRnD  = ISNULL(@LastDataFromRnD, DATEADD(MONTH, 1, @StabilityResultsSixMonth))
	
	SET @LastDateToRegulatory = @LastDataFromRnD
	SET @DossierReadyDate = DATEADD(MONTH, 2, @LastDataFromRnD); 
	SET @EarliestSubmissionDate = @DossierReadyDate;  
	SET @EndOfProcedureDate = DATEADD(MONTH, ISNULL(@TypeSubmissionEOP, 0),  @DossierReadyDate)  
	SET @CountryApprovalDate = DATEADD(MONTH, ISNULL(@NationApprovalEOP, 0), @EndOfProcedureDate)
	SET @EarliestLaunchDate  = DATEADD(MONTH, 4, @CountryApprovalDate)
	
	
	SELECT @CountryId CountryId, @PIDFId PIDFId,
			  Cast(@LastDataFromRnD as Date)  LastDataFromRnD,		  Cast(@LastDateToRegulatory as Date) LastDateToRegulatory
			, Cast(@DossierReadyDate as Date) DossierReadyDate,		  Cast(@EarliestSubmissionDate as Date) EarliestSubmissionDate
			,  Cast(@EndOfProcedureDate as Date) EndOfProcedureDate,  CAST(@CountryApprovalDate as Date) CountryApprovalDate
			, Cast(@EarliestLaunchDate as Date) EarliestLaunchDate
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFAPICharterData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFAPICharterData @PIDFID=129    
CREATE   PROCEDURE [dbo].[stp_npd_GetPIDFAPICharterData]                
(    
@PIDFID bigint = 0    
)              
AS                
BEGIN          
    
 declare @PIDFAPICharterId as bigint    
  declare @PIDFProjectInitiationDate as datetime    
 select @PIDFAPICharterId=PIDF_API_CharterId from PIDF_API_Charter where PIDFID= @PIDFID    
 select top 1 @PIDFProjectInitiationDate = ProjectInitiationDate from PIDF_PBF where PIDFId = @PIDFID  
 --select @PIDFAPICharterId    
 --------------------Table[0]--Charter Object---------------    
 select C.PIDF_API_CharterId,C.ProjectComplexityId,C.ManHourRates,    
(select top 1 FullName from Master_User where UserId in (select UserId from PIDF_API_Master where PIDFID = @PIDFID)) as APIGroupLeader,
 (select CONVERT(NVARCHAR,@PIDFProjectInitiationDate,106))[ProjectInitiationDate],   
 (SELECT CONVERT(NVARCHAR, DATEADD(DAY, [dbo].[GetProjectEndDate](@PIDFID),@PIDFProjectInitiationDate),106) ProjectEndDate)[ProjectEndDate], -- End Date Hasrcoded to Next 1 Months, --> this may need to be Change on Client feedback  
 A.MoleculeName [ProjectName],    
 B.BusinessUnitName [Market]    
 from PIDF A left join Master_BusinessUnit B on A.BusinessUnitId=B.BusinessUnitId     
 left join PIDF_API_Charter C on C.PIDFId = A.PIDFID    
 where A.PIDFID=@PIDFID    
 --------------------Table[1]----TimelineInMonths-------------    
   Select A.Name,A.Master_API_Charter_TimelineInMonthsId [TimelineInMonthsId],  B.TimelineInMonthsValue from Master_API_Charter_TimelineInMonths As A    
Left join PIDF_API_Charter_TimelineInMonths As B On A.Master_API_Charter_TimelineInMonthsId =    
B.TimelineInMonthsId  And B.PIDF_API_CharterId = @PIDFAPICharterId    
Order By A.SortOrder    
    
--------------------Table[2]----AnalyticalDepartment-------------    
 Select A.Name,A.Master_API_Charter_AnalyticalDepartmentId [AnalyticalDepartmentId],     
 B.AnalyticalDepartmentARDValue,    
 B.AnalyticalDepartmentImpurityValue,    
 B.AnalyticalDepartmentStabilityValue,    
 B.AnalyticalDepartmentAMVValue,    
 B.AnalyticalDepartmentAMTValue    
 from Master_API_Charter_AnalyticalDepartment As A    
Left join PIDF_API_Charter_AnalyticalDepartment As B On A.Master_API_Charter_AnalyticalDepartmentId =     
B.AnalyticalDepartmentId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder    
    
    
--------------------Table[3]----PRDDepartment-------------    
 Select A.Name,A.Master_API_Charter_PRDDepartmentId [PRDDepartmentId],     
 B.PRDDepartmentRawMaterialValue    
 from Master_API_Charter_PRDDepartment As A    
Left join PIDF_API_Charter_PRDDepartment As B On A.Master_API_Charter_PRDDepartmentId =     
B.PRDDepartmentId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder    
    
--------------------Table[4]----CapitalOtherExpenditure-------------    
 Select A.Name,A.Master_API_Charter_CapitalOtherExpenditureId [CapitalOtherExpenditureId],     
 B.CapitalOtherExpenditureAmountValue,    
 B.CapitalOtherExpenditureRemarkValue    
 from Master_API_Charter_CapitalOtherExpenditure As A    
Left join PIDF_API_Charter_CapitalOtherExpenditure As B On A.Master_API_Charter_CapitalOtherExpenditureId =     
B.CapitalOtherExpenditureId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder    
    
    
--------------------Table[5]----ManhourEstimates-------------    
 Select A.Name,A.Master_API_Charter_ManhourEstimatesId [ManhourEstimatesId],  B.ManhourEstimatesNoOfEmployeeValue,B.ManhourEstimatesMonthsValue,    
  B.ManhourEstimatesHoursValue,B.ManhourEstimatesCostValue from Master_API_Charter_ManhourEstimates As A    
Left join PIDF_API_Charter_ManhourEstimates As B On A.Master_API_Charter_ManhourEstimatesId =     
B.ManhourEstimatesId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder    
    
--------------------Table[6]----HeadwiseBudget-------------    
 Select A.Name,A.Master_API_Charter_HeadwiseBudgetId [HeadwiseBudgetId],     
 B.HeadwiseBudgetValue    
 from Master_API_Charter_HeadwiseBudget As A    
Left join PIDF_API_Charter_HeadwiseBudget As B On A.Master_API_Charter_HeadwiseBudgetId =     
B.HeadwiseBudgetId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder    
    
--------------------Table[7]----ManagementTeam-------------      
 Select FullName,DesignationName from Master_User where APIUser =1 and IsDeleted=0 and IsActive=1   
  
  
END       
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFAPICharterSummaryData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
    
    
-- exec [stp_npd_GetPIDFAPICharterSummaryData] @PIDFID=115        
CREATE   PROCEDURE [dbo].[stp_npd_GetPIDFAPICharterSummaryData]                        
(            
@PIDFID bigint = 0            
)                      
AS                        
BEGIN                 
            
declare @CurrencySymbol  as nvarchar            
set @CurrencySymbol = [dbo].[GetCurrencySymbol](@PIDFId)         
     
      
            
 declare @PIDFAPICharterId as bigint          
  declare @PIDFProjectInitiationDate as datetime          
 select @PIDFAPICharterId=PIDF_API_CharterId from PIDF_API_Charter where PIDFID= @PIDFID         
  select top 1 @PIDFProjectInitiationDate = ProjectInitiationDate from PIDF_PBF where PIDFId = @PIDFID        
 --select @PIDFAPICharterId            
 --------------------Table[0]--Charter Object---------------            
 select C.PIDF_API_CharterId,C.ProjectComplexityId, Replace(FORMAT(cast(C.ManHourRates as decimal(28,2)), 'C', 'en-US'),'$',@CurrencySymbol) 'ManHourRates' ,            
         (select top 1 FullName from Master_User where UserId in (select UserId from PIDF_API_Master where PIDFID = @PIDFID)) as APIGroupLeader, 
 (select CONVERT(NVARCHAR,@PIDFProjectInitiationDate,106))[ProjectInitiationDate],         
 (SELECT CONVERT(NVARCHAR, DATEADD(DAY, [dbo].[GetProjectEndDate](@PIDFID), @PIDFProjectInitiationDate),106) ProjectEndDate)[ProjectEndDate], -- End Date Hasrcoded to Next 1 Months, --> this may need to be Change on Client feedback        
        
 A.MoleculeName [ProjectName],            
 B.BusinessUnitName [Market]            
 from PIDF A left join Master_BusinessUnit B on A.BusinessUnitId=B.BusinessUnitId             
 left join PIDF_API_Charter C on C.PIDFId = A.PIDFID            
 where A.PIDFID=@PIDFID            
 --------------------Table[1]----TimelineInMonths-------------            
   Select A.Name,A.Master_API_Charter_TimelineInMonthsId [TimelineInMonthsId],  B.TimelineInMonthsValue from Master_API_Charter_TimelineInMonths As A            
Left join PIDF_API_Charter_TimelineInMonths As B On A.Master_API_Charter_TimelineInMonthsId =            
B.TimelineInMonthsId             
And B.PIDF_API_CharterId = @PIDFAPICharterId            
Order By A.SortOrder            
            
--------------------Table[2]----AnalyticalDepartment-------------            
 Select A.Name,A.Master_API_Charter_AnalyticalDepartmentId [AnalyticalDepartmentId]            
            
 , Replace(FORMAT(cast( B.AnalyticalDepartmentARDValue as numeric),   'C', 'en-US'),'$',@CurrencySymbol    ) 'AnalyticalDepartmentARDValue'            
 , Replace(FORMAT(cast( B.AnalyticalDepartmentImpurityValue as numeric),'C', 'en-US'),'$',@CurrencySymbol     ) 'AnalyticalDepartmentImpurityValue'            
 , Replace(FORMAT(cast( B.AnalyticalDepartmentStabilityValue as numeric), 'C', 'en-US'),'$',@CurrencySymbol    ) 'AnalyticalDepartmentStabilityValue'            
 , Replace(FORMAT(cast( B.AnalyticalDepartmentAMVValue as numeric),   'C', 'en-US'),'$',@CurrencySymbol    ) 'AnalyticalDepartmentAMVValue'            
 , Replace(FORMAT(cast( B.AnalyticalDepartmentAMTValue as numeric),  'C', 'en-US'),'$',@CurrencySymbol     ) 'AnalyticalDepartmentAMTValue'            
 from Master_API_Charter_AnalyticalDepartment As A            
Left join PIDF_API_Charter_AnalyticalDepartment As B On A.Master_API_Charter_AnalyticalDepartmentId =             
B.AnalyticalDepartmentId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder            
            
            
--------------------Table[3]----PRDDepartment-------------            
 Select A.Name,A.Master_API_Charter_PRDDepartmentId [PRDDepartmentId],             
 Replace(FORMAT(cast( B.PRDDepartmentRawMaterialValue as numeric), 'C', 'en-US'),'$',@CurrencySymbol) 'PRDDepartmentRawMaterialValue'            
 from Master_API_Charter_PRDDepartment As A            
Left join PIDF_API_Charter_PRDDepartment As B On A.Master_API_Charter_PRDDepartmentId =             
B.PRDDepartmentId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder            
            
--------------------Table[4]----CapitalOtherExpenditure-------------            
 Select A.Name,A.Master_API_Charter_CapitalOtherExpenditureId [CapitalOtherExpenditureId],             
 Replace(FORMAT(cast( B.CapitalOtherExpenditureAmountValue as numeric), 'C', 'en-US'),'$',@CurrencySymbol) 'CapitalOtherExpenditureAmountValue',            
 B.CapitalOtherExpenditureRemarkValue            
 from Master_API_Charter_CapitalOtherExpenditure As A            
Left join PIDF_API_Charter_CapitalOtherExpenditure As B On A.Master_API_Charter_CapitalOtherExpenditureId =             
B.CapitalOtherExpenditureId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder                
            
--------------------Table[5]----ManhourEstimates-------------            
 Select A.Name,A.Master_API_Charter_ManhourEstimatesId [ManhourEstimatesId],  B.ManhourEstimatesNoOfEmployeeValue,B.ManhourEstimatesMonthsValue,            
  B.ManhourEstimatesHoursValue,            
   Replace(FORMAT(cast( B.ManhourEstimatesCostValue as numeric), 'C', 'en-US'),'$',@CurrencySymbol) 'ManhourEstimatesCostValue'             
  from Master_API_Charter_ManhourEstimates As A            
Left join PIDF_API_Charter_ManhourEstimates As B On A.Master_API_Charter_ManhourEstimatesId =             
B.ManhourEstimatesId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder            
            
--------------------Table[6]----HeadwiseBudget-------------            
 Select A.Name,A.Master_API_Charter_HeadwiseBudgetId [HeadwiseBudgetId],             
             
   Replace(FORMAT(cast( B.HeadwiseBudgetValue as numeric), 'C', 'en-US'),'$',@CurrencySymbol) 'HeadwiseBudgetValue'            
            
 from Master_API_Charter_HeadwiseBudget As A            
Left join PIDF_API_Charter_HeadwiseBudget As B On A.Master_API_Charter_HeadwiseBudgetId =             
B.HeadwiseBudgetId And B.PIDF_API_CharterId = @PIDFAPICharterId Order By A.SortOrder            
          
--------------------Table[7]----ManagementTeam-------------            
 Select FullName,DesignationName from Master_User where APIUser =1 and IsDeleted=0 and IsActive=1      
 
 --------------------Table[8]----ApiInHouse-------------      
 select [APIInhouseName],[Primary] from dbo.[PIDF_API_Inhouse] PN
 inner join dbo.Master_API_Inhouse AI on PN.APIInhouseId=AI.APIInhouseId 
 where PIDFId=@PIDFID         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFList @ScreenId =5, @SearchText = '', @PageSize = 100, @CurrentPageNumber = 0  , @UserId=1        
CREATE PROCEDURE [dbo].[stp_npd_GetPIDFList]                          
(                
@UserId INT = 0,                
@CurrentPageNumber INT = 0,                            
@PageSize INT = 25,                            
@SortColumn VARCHAR(100) = 'PIDFNO',                            
@SortDirection VARCHAR(5) = 'ASC',                            
@SearchText VARCHAR(MAX) ='',          
@ScreenId int = 0          
)                        
AS                          
BEGIN                    
                
SET NOCOUNT ON;               
        
Declare @APIGroupLeader int = IsNull((Select top 1 APIGroupLeader from Master_User Where UserId = @UserId), 0)        
Declare @APIHead int = IsNull((Select top 1 APIUser from Master_User Where UserId = @UserId), 0)        
      
--DECLARE @IsManagement bit=(select top 1 Isnull(IsManagement,0) from master_user where Userid=@UserId);          
--Declare @AlReadyApproved bit=(select top 1 case when isnull(StatusId,0)=20 or isnull(StatusId,0)=21 then 1 else 0 end from PIDF_ManagementApprovalStatusHistory where CreatedBy=@UserId)          
Set @SearchText = IsNull(@SearchText, '')                
Select * from (                
SELECT Count(PIDFID) OVER() TotalCount, * , ROW_NUMBER() OVER                 
(                
ORDER BY                 
                 
CASE                          
WHEN @SortDirection <> 'DESC' THEN 'DESC'                          
WHEN @SortColumn = 'PIDFNo' THEN PIDFNo                     
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN 'ASC'                          
WHEN @SortColumn = 'PIDFNo' THEN PIDFNo                
END ASC                 
, CASE                          
WHEN @SortDirection <> 'DESC' THEN 'Desc'                          
WHEN @SortColumn = 'MoleculeName' THEN MoleculeName                
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN 'ASC'                          
WHEN @SortColumn = 'MoleculeName' THEN MoleculeName                
END ASC                 
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'BrandName' THEN BrandName                      
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'BrandName' THEN BrandName                          
END ASC                
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'DosageFormName' THEN DosageFormName                      
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'DosageFormName' THEN DosageFormName                          
END ASC                
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'CountryName' THEN CountryName                     
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'CountryName' THEN CountryName                          
END ASC                
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate                
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate                          
END ASC                
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'BusinessUnitName' THEN BusinessUnitName                
END DESC                           
,CASE   
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'BusinessUnitName' THEN BusinessUnitName                          
END ASC       
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'OralName' THEN OralName           
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'OralName' THEN OralName                          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null             
WHEN @SortColumn = 'status' THEN [status]        
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'status' THEN [status]          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'MarketExtenstionName' THEN marketExtension          
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'MarketExtenstionName' THEN marketExtension          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'applicant' THEN applicant          
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'applicant' THEN applicant          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'InHouses' THEN InHouses          
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'InHouses' THEN InHouses          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'inidication' THEN inidication          
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'inidication' THEN inidication          
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'CreatedBy' THEN CreatedBy         
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'CreatedBy' THEN CreatedBy        
END ASC           
, CASE                          
WHEN @SortDirection <> 'DESC' THEN null                          
WHEN @SortColumn = 'diaName' THEN DIAName          
END DESC                           
,CASE                          
WHEN @SortDirection <> 'ASC' THEN null                          
WHEN @SortColumn = 'diaName' THEN DIAName          
END ASC           
)                 
RowNumber from (                
SELECT COUNT([PIDFID]) OVER() TotalRecord, PIDFID, PIDFNo,MoleculeName,BrandName,
dbo.GetCanBeApprove(PIDFID,@UserId) as IsAllowApprove,
DF.DosageFormName as DosageFormName, ME.MarketExtenstionName as marketExtension,                
U.ApprovedGenerics, U.LaunchedGenerics, U.RFDApplicant as applicant, MC.CountryName as CountryName, MD.DIAName as diaName,                
P.PackagingTypeName as ProductPackagingName,U.RFDIndication as inidication,                
us.FullName as CreatedBy,us.UserId as UserId,ISNULL(        
(select top 1 case when isnull(StatusId,0)=20 or isnull(StatusId,0)=21 then 1 else 0 end from PIDF_ManagementApprovalStatusHistory as A where CreatedBy=@UserId        
and A.PIDFId = U.PIDFID)        
,0) as AlReadyApproved, ps.PIDFStatus as status, ps.StatusColor, PIDFStatusID                
, MO.OralName, MBU.BusinessUnitName, IsNull(U.InHouses, 0) As InHouses, U.CreatedDate, U.BusinessUnitId                
                
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 6), 0) as bit) As IPD                
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 11), 0) as bit) As Commercial                
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 13), 0) as bit) As PBF                
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 15), 0) as bit) As API                
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 17), 0) as bit) As Finance            
, Cast(IsNull((Select top 1 1 from PIDFStatusHistory Where PIDFId = U.PIDFId And StatusId = 9), 0) as bit) As Medical                
                
, cast(0 as bit) Management, RFDBrand                
        
, IsNull((Select top 1 Interested as APIInterested from PIDF_API_Master Where PIDFId = U.PIDFId), 0) As APIInterested        
           
, (select A.Strength, B.UnitofMeasurementName from PIDFProductStrength As A                
LEFT Join Master_UnitofMeasurement As B On A.UnitofMeasurementId = B.UnitofMeasurementId                
Where PIDFID = U.PIDFID                
FOR JSON PATH, INCLUDE_NULL_VALUES) As ProductStrength                
                
, (select A.APIName, B.APISourcingName, A.APIVendor from PIDFAPIDetails As A                
LEFT Join Master_APISourcing As B On A.APISourcingId = B.APISourcingId                
Where PIDFID = U.PIDFID                
FOR JSON PATH, INCLUDE_NULL_VALUES)  As ProductAPIDetail                
                
,(          
select * from  dbo.GetPIDFHistoryStatusByPIDFID(U.PIDFID) Order By CreatedDate desc                
FOR JSON PATH, INCLUDE_NULL_VALUES)  As StatusHistory                
                
FROM PIDF As U           
LEFT join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId                
LEFT join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId                
LEFT join Master_Country as MC on MC.CountryID = U.RFDCountryId                
LEFT join Master_User as us on us.UserId = u.CreatedBy                
LEFT Join Master_Oral As MO On MO.OralId = U.OralId                
LEFT Join Master_BusinessUnit As MBU On MBU.BusinessUnitId = U.BusinessUnitId                
                
LEFT join Master_MarketExtenstion ME on ME.MarketExtenstionId = U.MarketExtenstionId                
LEFT join Master_DIA as MD on MD.DIAId = U.DIAId                
Left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId                
WHERE  ((U.BusinessUnitId In (Select BusinessUnitId from Master_UserBusinessUnitMapping Where UserId = @UserId)) Or @UserId = 0 Or @ScreenId IN (1, 2, 4, 6, 8))          
          
And ((@ScreenId = 1 And U.StatusId > 0) Or (@ScreenId = 2 And U.StatusId NOT In (1,2,4))          
 Or (@ScreenId = 3 And U.StatusId NOT In (1, 2, 4) And MBU.IsDomestic = 1)          
  Or (@ScreenId = 4 And U.StatusId NOT In (1, 2, 3, 4, 5, 6, 8, 9))          
   Or (@ScreenId = 5 And U.StatusId NOT In (1, 2, 3, 4, 5, 6, 8, 9))          
    Or (@ScreenId = 6 And U.StatusId NOT In (1, 2, 3, 4, 5, 6, 8, 9) And U.InHouses = 1)          
  Or (@ScreenId = 7 And (select Count(PIDFStatusHistoryId) from PIDFStatusHistory where StatusId In (11, 13) And  PIDFId = U.PIDFId) > 1 And U.StatusId NOT In (1, 2, 3, 4, 5, 6, 8, 9))          
  Or (@ScreenId = 8 And U.StatusId In (18, 20, 21,22))          
  Or (@ScreenId = 9 And U.StatusId In (22))          
  )        
          
  And ((@ScreenId = 5 And ( @APIGroupLeader = 1       
 And  PIDFId In (Select PIDFId from PIDF_API_Master Where Interested = 1 And UserId = @UserId) OR @APIHead =1 )         
)      
  OR (@APIGroupLeader = 0) OR (@ScreenId <> 5))        
        
)AS B WHERE                   
(BrandName LIKE '%' + @SearchText + '%' OR PIDFNo LIKE '%' + @SearchText + '%'           
OR MoleculeName LIKE '%' + @SearchText + '%' OR DosageFormName LIKE '%' + @SearchText + '%'           
OR BusinessUnitName LIKE '%' + @SearchText + '%' OR OralName LIKE '%' + @SearchText + '%'                
OR CountryName LIKE '%' + @SearchText + '%' OR status LIKE '%' + @SearchText + '%'          
 OR applicant LIKE '%' + @SearchText + '%' OR diaName LIKE '%' + @SearchText + '%'          
 OR ProductPackagingName LIKE '%' + @SearchText + '%' OR RFDBrand LIKE '%' + @SearchText + '%'          
)                
) As C Where                 
RowNumber BETWEEN (@CurrentPageNumber) + 1 AND (@CurrentPageNumber) + @PageSize                   
                   
SET NOCOUNT OFF;                
                         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetPIDFManagementPIDFList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFList
CREATE PROCEDURE [dbo].[stp_npd_GetPIDFManagementPIDFList]          
(
@PIDFID INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'PIDFNO',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
SELECT Count(PIDFID) OVER() TotalCount, * from (
SELECT COUNT([PIDFID]) OVER() TotalRecord, ROW_NUMBER() OVER 
(
ORDER BY 
 
CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'PIDFNo' THEN U.PIDFNo
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'ProjectName' THEN U.MoleculeName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'BrandName' THEN U.BrandName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'DosageForm' THEN DF.DosageFormName          
END ASC
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'Country' THEN C.CountryName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'ProductPackagingName' THEN P.PackagingTypeName          
END ASC
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedBy' THEN us.FullName          
END ASC
) 
RowNumber,PIDFID, PIDFNo,MoleculeName,BrandName,DF.DosageFormName as DosageFormName, c.CountryName as CountryName,P.PackagingTypeName as ProductPackagingName,
us.FullName as CreatedBy, ps.PIDFStatus as status
FROM PIDF As U
left join Master_DosageForm as DF on DF.DosageFormId = u.DosageFormId
left join Master_Country as C on C.CountryID = u.RFDCountryId
left join Master_PackagingType as P on P.PackagingTypeId = u.PackagingTypeId
left join Master_User as us on us.UserId = u.CreatedBy
left join Master_PIDFStatus as ps on ps.PIDFStatusID = u.StatusId

WHERE  U.IsActive = 1 and ps.PIDFStatusID in (4,1,2) --(for PIDF Created,PIDF Pending Approval,PIDF Rejected)
)AS B WHERE   
(BrandName LIKE '%' + @SearchText + '%'       
OR PIDFNo LIKE '%' + @SearchText + '%')
And RowNumber BETWEEN (@CurrentPageNumber * @PageSize) + 1 AND (@CurrentPageNumber * @PageSize) + @PageSize   
   
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetRealTimeNotificationForUser]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetRealTimeNotificationForUser @UserId = 1     
CREATE PROCEDURE [dbo].[stp_npd_GetRealTimeNotificationForUser]                
(      
@UserId int           
)              
AS                
BEGIN          

--select 30 as PendingNotification
Select count(*) as PendingNotification from Master_Notification
Where CreatedDate > (select top 1 UpdateDate from Master_Notification_User Where UserId = @UserId)

               
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetRegionByBusinessUnit]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec [stp_npd_GetRegionByBusinessUnit] 1, '1,2,3,4,5,16,19,21,22,23,24,25'
-- exec stp_npd_GetRegionByBusinessUnit 0, '31,32,33'  
CREATE PROCEDURE [dbo].[stp_npd_GetRegionByBusinessUnit]            
(  
@UserId INT = 0,  
@BusinessUnitIds varchar(max)  
)          
AS            
BEGIN      
  
select DISTINCT A.RegionId, A.RegionName from Master_Region As A  
Inner Join Master_BusinessUnitRegionMapping As B On A.RegionId = B.RegionId  
Where A.IsActive = 1 And B.BusinessUnitId in (SELECT CAST(value AS INT) FROM string_split(@BusinessUnitIds, ','))  
  
END   
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetUserDropdown]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[stp_npd_GetUserDropdown]          
(
@UserId INT = 0
)        
AS          
BEGIN    

Select BusinessUnitId, BusinessUnitName from Master_BusinessUnit
Where IsActive = 1

Select RoleId, RoleName from Master_Role
Where IsNull(IsActive, 0) = 1 And IsNull(IsDeleted,0) = 0
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_GetUserList]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetUserList @SearchText = '', @PageSize = 1000, @CurrentPageNumber = 0
CREATE PROCEDURE [dbo].[stp_npd_GetUserList]          
(
@UserId INT = 0,
@CurrentPageNumber INT = 0,            
@PageSize INT = 25,            
@SortColumn VARCHAR(100) = 'FullName',            
@SortDirection VARCHAR(5) = 'ASC',            
@SearchText VARCHAR(MAX) =''
)        
AS          
BEGIN    

SET NOCOUNT ON;
Set @SearchText = IsNull(@SearchText, '')
Select * from (
SELECT Count(UserId) OVER() TotalCount, * , ROW_NUMBER() OVER 
(
ORDER BY 
CASE          
WHEN @SortDirection <> 'DESC' THEN 0          
WHEN @SortColumn = 'UserId' THEN  UserId           
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 0          
WHEN @SortColumn = 'UserId' THEN UserId
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'DESC'          
WHEN @SortColumn = 'FullName' THEN FullName     
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'FullName' THEN FullName
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN 'Desc'          
WHEN @SortColumn = 'EmailAddress' THEN EmailAddress
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN 'ASC'          
WHEN @SortColumn = 'EmailAddress' THEN EmailAddress
END ASC 
, CASE          
WHEN @SortDirection <> 'DESC' THEN null          
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate      
END DESC           
,CASE          
WHEN @SortDirection <> 'ASC' THEN null          
WHEN @SortColumn = 'CreatedDate' THEN CreatedDate          
END ASC
) 
RowNumber from (
SELECT COUNT(U.[UserId]) OVER() TotalRecord, U.UserId as 'UserId', FullName, EmailAddress, U.CreatedDate, 
BusinessUnitName = dbo.GetMultipleBusinessUnit(U.UserId) ,
DepartmentName =   dbo.GetMultipleDepartment(U.UserId) ,
RoleName= (Select RoleName from Master_Role where RoleId=U.RoleId)
, IsNull(MC.ISDCountryCode + '-', '') + U.MobileNumber As MobileNumber
, U.IsActive
FROM Master_User As U
Left Join Master_Country As MC On MC.CountryID = U.MobileCountryId
	
WHERE  U.IsDeleted = 0
)AS B WHERE   
(FullName LIKE '%' + @SearchText + '%'       
OR EmailAddress LIKE '%' + @SearchText + '%'
OR DepartmentName LIKE '%' + @SearchText + '%'
OR RoleName LIKE '%' + @SearchText + '%'
OR BusinessUnitName LIKE '%' + @SearchText + '%')
) As C Where 
RowNumber BETWEEN (@CurrentPageNumber) + 1 AND (@CurrentPageNumber) + @PageSize     
 
SET NOCOUNT OFF;
         
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_InsertException]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 -- exec stp_npd_InsertException @Message='TEST',@Source ='TEST',@InnerException ='TEST',@StackTrace='TEST',@CreatedBy=1   
CREATE PROCEDURE [dbo].[stp_npd_InsertException]                
(    
@Message nvarchar(500),    
@Source nvarchar(500), 
@InnerException nvarchar(4000), 
@StackTrace nvarchar(4000), 
@CreatedBy nvarchar(4000),
@Success bit = 1 OUTPUT
)              
AS                
BEGIN 

BEGIN TRAN

	BEGIN TRY
	INSERT INTO Master_Exception(
					[Message]
					,[Source]
					,[InnerException]
					,[StrackTrace]					
					,[CreatedDate]
					,[CreatedBy]
					)
				VALUES (
					@Message,
					@Source,
					@InnerException,
					@StackTrace,
					GETDATE(),
					@CreatedBy
					);
	
		SET @Success = 1;

		COMMIT TRAN
	END TRY

	BEGIN CATCH
	SET @Success = 0;
		ROLLBACK TRAN
	END CATCH
	SELECT @Success;
END 

GO
/****** Object:  StoredProcedure [dbo].[stp_npd_RemoveAllMultipleMappingofMasterUser]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_RemoveAllMultipleMappingofMasterUser 32
CREATE PROCEDURE [dbo].[stp_npd_RemoveAllMultipleMappingofMasterUser]          
(
@UserId INT = 0
)        
AS         

BEGIN    

  delete from Master_UserBusinessUnitMapping    where UserId= @UserId 
  delete from Master_UserRegionMapping			where UserId= @UserId 	
  delete from Master_UserCountryMapping			where UserId= @UserId 
  delete from Master_UserDepartmentMapping		where UserId= @UserId 

END 
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_RemoveChildDataAPICharter]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec stp_npd_GetPIDFAPICharterData @PIDFID=18
CREATE   PROCEDURE [dbo].[stp_npd_RemoveChildDataAPICharter]            
(
@PIDFAPICharterId bigint = 0
)          
AS            
BEGIN      

delete from PIDF_API_Charter_AnalyticalDepartment where PIDF_API_CharterId =  @PIDFAPICharterId
delete from PIDF_API_Charter_CapitalOtherExpenditure where PIDF_API_CharterId = @PIDFAPICharterId
delete from PIDF_API_Charter_HeadwiseBudget where PIDF_API_CharterId = @PIDFAPICharterId
delete from PIDF_API_Charter_ManhourEstimates where PIDF_API_CharterId = @PIDFAPICharterId
delete from PIDF_API_Charter_PRDDepartment where PIDF_API_CharterId = @PIDFAPICharterId
delete from PIDF_API_Charter_TimelineInMonths where PIDF_API_CharterId = @PIDFAPICharterId

END   
GO
/****** Object:  StoredProcedure [dbo].[stp_npd_VerifyUserLogin]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- exec stp_npd_VerifyUserLogin 'sanket@neosoft.com','12345'
 
CREATE PROCEDURE [dbo].[stp_npd_VerifyUserLogin]            
(                
@Email VARCHAR(100),              
@Password VARCHAR(100)
)          
AS            
BEGIN      

declare @BUIds VARCHAR(200)
select @BUIds =STRING_AGG(BusinessUnitId,',') from Master_UserBusinessUnitMapping where UserId=(select userId FROM Master_User WHERE EmailAddress=@Email 
and [Password]=@Password AND IsActive=1 and ISNULL(IsDeleted,0)=0)

  

SELECT FullName,UserId,EmailAddress,RoleId,@BUIds As AssignedBusinessUnit, IsNull(IsManagement, 0) As IsManagement
FROM Master_User WHERE EmailAddress=@Email 
and [Password]=@Password AND IsActive=1 and ISNULL(IsDeleted,0)=0




Declare @UserId int = (SELECT Top 1 UserId FROM Master_User WHERE EmailAddress=@Email 
and [Password]=@Password AND IsActive=1 and ISNULL(IsDeleted,0)=0)

	If IsNUll(@UserId, 0) > 0
	Begin
		Insert Into UserSessionLogMaster(UserId, CreatedDate)
		Values(@UserId, GetDate())
	End
           
END 
GO
/****** Object:  StoredProcedure [dbo].[stp_PBF_PhasewiseBudgetData]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- [dbo].[stp_PBF_PhasewiseBudgetData] 421
CREATE   Proc [dbo].[stp_PBF_PhasewiseBudgetData]  
@PIDFId int=0
AS 
BEGIN
	  DECLARE @fillDate DATE, @manufactorDate DATE, @intdate DATE;
	  DECLARE @data TABLE ([Include] BIT, Sort INT, [Terms] VARCHAR(100), Cost DECIMAL(18, 2), [EndDate] DATETIME)

	  SELECT @manufactorDate = p.BatchManifacturingDate, @fillDate = p.FillingDateDate, @intdate = p.ProjectInitiationDate
	  FROM dbo.PIDF_PBF p
	  WHERE p.PIDFId = @PIDFId

	  SELECT TOP 1 b.BusinessUnitName, b.BusinessUnitId, pb.*
	  INTO #tmpD
	  FROM PIDF_PBF_PhaseWiseBudget pb
	  JOIN PIDF_PBF_General g ON g.PBFGeneralId = pb.PBFGeneralId
	  JOIN PIDF_PBF p ON  g.PIDFPBFId = p.PIDFPBFId
	  JOIN Master_BusinessUnit b ON b.BusinessUnitId = g.BusinessUnitId
	  WHERE p.PIDFId = @PIDFId 

	  INSERT INTO @data
	  SELECT 1, 1,  'Feasability' [Terms], t.FeasabilityCumTotal [Cost],			ISNULL(t.FeasabilityCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 1, 2, 'Prototype development' [Terms], t.PrototypeCumTotal [Cost],		ISNULL(t.PrototypeCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 1, 3, 'R&D Scale Up	' [Terms], t.ScaleUpCumTotal [Cost],			ISNULL(t.ScaleUpCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 1, 4, 'AMV / AMT' [Terms], t.AMVCumTotal [Cost],						ISNULL(t.AMVCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 1, 5, 'Exhibit and Scalability' [Terms], t.ExhibitCumTotal [Cost],		ISNULL(t.ExhibitCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 1, 6, 'Filing' [Terms], t.FilingCumTotal [Cost],						ISNULL(t.FilingCumTotalDate, @fillDate) [EndDate] 
	  FROM #tmpD t 
	  UNION
	  SELECT 0, 7, 'MFD', NULL, @manufactorDate
	  UNION
	  SELECT 0, 7, 'FD', NULL, @fillDate
	  UNION
	  SELECT 0, 7, 'IND', NULL, @intdate
	   
	  DROP TABLE #tmpD;

	  SELECT * FROM @data ORDER BY Sort 
  END
GO
/****** Object:  StoredProcedure [dbo].[usp_PIDF_CSV]    Script Date: 11/16/2023 4:01:51 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[usp_PIDF_CSV] 
AS   
BEGIN    
	DECLARE @Dt DATETIME = GETDATE(), @By INT=1
	DECLARE @mCnt TABLE(Id INT, CountryName VARCHAR(1000));

	----- Step1: Add PIDFID for table -----
	-- ALTER TABLE [dbo].[ExcelExportPIDF] ADD PIDFID INT

	--===== Data update =======
	--- Unit of measurement ----
	INSERT INTO Master_UnitofMeasurement(UnitofMeasurementName, IsActive, CreatedBy, CreatedDate)
	SELECT t.Strength, 1, @By, @Dt
	FROM [dbo].[ExcelExportPIDF] t
	WHERE t.Strength IS NOT NULL AND -- Replace Strength with Unit of measure 
	NOT EXISTS (SELECT TOP 1 1 FROM Master_UnitofMeasurement m1 WHERE m1.UnitofMeasurementName = t.Strength)
		
	 	--- Strength --- 
	--	parshob will share new sheet with coumn [Strengt] and [UNit of Measurment]
	--INSERT INTO Master_ProductStrength(ProductStrengthName, IsActive, CreatedBy, CreatedDate)
	--SELECT TRIM(t.[Strength]), 1, @By,@Dt
	--FROM [dbo].[ExcelExportPIDF] t 
	--WHERE t.[Strength] IS NOT NULL   -- 
	--AND NOT EXISTS (SELECT TOP 1 1 FROM Master_ProductStrength m1 WHERE m1.ProductStrengthName = t.[Strength])

	--- update Country ---- 
	INSERT INTO Master_Country(CountryName, CountryCode, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t1.[Value]), TRIM(t1.[Value]), 1, @By,@Dt 
	FROM [dbo].[ExcelExportPIDF] t
	CROSS APPLY [dbo].[ufn_Split](t.Country, '/') t1
	WHERE t.Country IS NOT NULL   -- Replace Strength with Unit of measure 
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_Country m1 WHERE m1.CountryCode = TRIM(t1.[Value])) 

	--- Dosage form --- 
	INSERT INTO Master_DosageForm(DosageFormName, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t.[Dosage form]), 1, @By,@Dt
	FROM [dbo].[ExcelExportPIDF] t 
	WHERE t.[Dosage form] IS NOT NULL   -- Replace Strength with Unit of measure 
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_DosageForm m1 WHERE m1.DosageFormName = t.[Dosage form]) 

	
	--- Pack Size --- 
	-- parshob will share new sheet with coumn [Pack Size Name] and [Pack Size]

	--INSERT INTO Master_PackSize(PackSizeName,PackSize, IsActive, CreatedBy, CreatedDate)
	--SELECT 'Pack Size Name',TRIM(t.[Pack Size]), 1, @By,@Dt
	--FROM [dbo].[ExcelExportPIDF] t 
	--WHERE t.[Pack Size] IS NOT NULL   -- 
	--AND NOT EXISTS (SELECT TOP 1 1 FROM Master_PackSize m1 WHERE m1.PackSizeName = t.[Pack Size Name]) 
	 
	 	--- Market Extenstion --- 
	INSERT INTO Master_MarketExtenstion(MarketExtenstionName, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t.[Market Extension]), 1, @By,@Dt
	FROM [dbo].[ExcelExportPIDF] t 
	WHERE t.[Market Extension] IS NOT NULL   --  
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_MarketExtenstion m1 WHERE m1.MarketExtenstionName = t.[Market Extension])
		
	----Master In house/InLicensed ---> already done
	
	--- Master_DIA / MA --- 
	INSERT INTO Master_DIA(DIAName, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t.[MA]), 1, @By,@Dt
	FROM [dbo].[ExcelExportPIDF] t 
	WHERE t.[MA] IS NOT NULL   -- 
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_DIA m1 WHERE m1.DIAName = t.[MA])

		---Manufacturer --- 
	INSERT INTO Master_Manufacturing(ManufacturingName, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t.Manufacturer), 1, @By,@Dt
	FROM [dbo].[ExcelExportPIDF] t 
	WHERE t.[Manufacturer] IS NOT NULL   -- 
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_Manufacturing m1 WHERE m1.ManufacturingName = t.Manufacturer)
	 
	 	--- Business Unit--- 
	INSERT INTO Master_BusinessUnit(BusinessUnitName, IsActive, CreatedBy, CreatedDate)
	SELECT TRIM(t.BU), 1, @By,@Dt
	FROM [dbo].[ExcelExportPIDF] t 
	WHERE t.[BU] IS NOT NULL   -- Replace Strength with Unit of measure 
	AND NOT EXISTS (SELECT TOP 1 1 FROM Master_BusinessUnit m1 WHERE m1.BusinessUnitName = t.[BU])



	-- Step2: Do Product info -----
	DECLARE  @name VARCHAR(1000), @buId INT = 2

	DECLARE db_cursor CURSOR FOR 
	SELECT DISTINCT t.Product
	FROM [dbo].[ExcelExportPIDF] t WHERE t.Product IS NOT NULL  
	ORDER BY t.Product

	OPEN db_cursor  
	FETCH NEXT FROM db_cursor INTO @name  

	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		   DECLARE @pidfId INT
		   

		   INSERT INTO [dbo].[PIDF] ([BusinessUnitId],[MoleculeName],[IsActive]
           ,[CreatedDate], ModifyDate
           ,[CreatedBy], ModifyBy 
           ,[StatusId]
           ,[LastStatusId]
           ,[InHouses], 
		   OralId, UnitofMeasurementId, DosageFormId, PackagingTypeId, RFDCountryId, DIAId, MarketExtenstionId, StatusUpdatedBy, PIDFNO) 
		   SELECT DISTINCT 2 [BusinessUnitId], t.Product, 1, GETDATE(), GETDATE(), 1, 1,
					1 [StatusId], 1 [LastStatusId], 1 [InHouses]
					, 1, 1 UnitofMeasurementId, 1, 1 PackagingTypeId, 1, 1 DIAId, 1, 1, 'PIDF-00'
		   FROM [dbo].[ExcelExportPIDF] t WHERE t.Product = @name
		   SET @pidfId = SCOPE_IDENTITY(); 

		   PRINT 'Added data' 
		   --UPDATE p SET p.PIDFNO = 'PIDF-00' + CAST(@pidfId AS varchar(1000))
		   --FROM [dbo].[PIDF] p WITH(NOLOCK)
		   --WHERE p.PIDFID = @pidfId

		  --- Update PIDF ID -----
		  UPDATE t SET t.PIDFID = @pidfId
		  FROM  [dbo].[ExcelExportPIDF] t WHERE t.Product = @name



		-- Add PIDFProductStrength ---  
		 SELECT DISTINCT t.PIDFID, t.Strength, PATINDEX('%[^0-9.]%', t.Strength) Ind
		 INTO #Str
		 FROM [dbo].[ExcelExportPIDF] t WITH(NOLOCK) 
		 WHERE t.PIDFID = @pidfId

		 INSERT INTO PIDFProductStrength (PIDFID, Strength, UnitofMeasurementId, BusinessUnitId, ModifyDate, ModifyBy)
		 SELECT DISTINCT t.PIDFID, SUBSTRING(t.Strength, 0, t.Ind) Strength,  u.UnitofMeasurementId, @buId [BusinessUnitId], GETDATE(), 1
		  FROM #Str t 
		 LEFT JOIN Master_UnitofMeasurement u ON u.UnitofMeasurementName = TRIM(SUBSTRING(t.Strength, t.Ind, LEN(t.Strength)))
		 WHERE t.PIDFID = @pidfId

		 DROP TABLE #Str;
		 PRINT 'Added PIDFProductStrength' 



		-- Add [PIDFProductStrength_CountryMapping]
		 INSERT INTO [PIDFProductStrength_CountryMapping] (PIDFProductStrengthId, CountryId, ModifyBy, ModifyDate)
		 SELECT p.PIDFProductStrengthId, c.CountryID, 1, GETDATE()
		 FROM PIDFProductStrength p  WITH(NOLOCK)
		 OUTER APPLY (SELECT c.CountryID FROM Master_Country c 
					  JOIN [dbo].[ExcelExportPIDF] t ON t.Country = c.CountryCode 
					  WHERE t.PIDFId = @pidfId
					 ) c
		 WHERE p.PIDFId = @pidfId AND c.CountryID IS NOT NULL
		 PRINT 'Added PIDFProductStrength_CountryMapping' 

		  FETCH NEXT FROM db_cursor INTO @name 
	END 

	CLOSE db_cursor  
	DEALLOCATE db_cursor
END   
GO
